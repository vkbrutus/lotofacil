<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lotofácil v3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #0f172a; color: #f1f5f9; min-height: 100vh; }
        header { background: #1e293b; border-bottom: 1px solid #334155; padding: 1rem; position: sticky; top: 0; z-index: 100; }
        .header-inner { max-width: 1100px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .logo { font-size: 1.25rem; font-weight: 700; color: #10b981; }
        .badge { background: #f59e0b; color: #000; font-size: 0.6rem; padding: 2px 5px; border-radius: 3px; margin-left: 5px; vertical-align: middle; }
        nav { display: flex; gap: 5px; flex-wrap: wrap; }
        nav button { background: transparent; border: 1px solid #334155; color: #94a3b8; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
        nav button:hover { background: #334155; color: #f1f5f9; }
        nav button.active { background: #10b981; color: white; border-color: #10b981; }
        
        /* Status Bar */
        .status-bar { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
        .status-indicator { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; color: #94a3b8; background: #0f172a; padding: 4px 10px; border-radius: 20px; border: 1px solid #334155; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #64748b; animation: pulse-dot 2s infinite; }
        .status-dot.online { background: #22c55e; }
        .status-dot.offline { background: #ef4444; }
        .status-dot.cached { background: #f59e0b; }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .status-text { font-weight: 500; }
        .last-update { font-size: 0.7rem; color: #64748b; }
        .btn-refresh { background: #334155; border: none; color: #94a3b8; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .btn-refresh:hover { background: #10b981; color: white; transform: rotate(180deg); }
        .btn-refresh.loading { animation: spin 1s linear infinite; pointer-events: none; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        main { max-width: 1100px; margin: 0 auto; padding: 1.5rem; }
        .hidden { display: none !important; }
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.25rem; }
        .card-title { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: #10b981; }
        .grid2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.25rem; }
        .grid3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        .grid4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; }
        .result-card { background: linear-gradient(135deg, #1e293b, rgba(16,185,129,0.15)); border: 2px solid #10b981; text-align: center; padding: 1.5rem; }
        
        /* Resultado Completo Estilo Mazusoft */
        .result-card-full { background: linear-gradient(135deg, #1e293b, rgba(16,185,129,0.1)); border: 2px solid #10b981; padding: 1.5rem; }
        
        /* Banner de Acumulado */
        .acumulado-banner { background: linear-gradient(135deg, #ef4444, #dc2626, #ef4444); background-size: 200% 200%; animation: gradientMove 2s ease infinite; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; text-align: center; box-shadow: 0 4px 20px rgba(239,68,68,0.4); }
        .acumulado-content { display: flex; align-items: center; justify-content: center; gap: 0.75rem; flex-wrap: wrap; }
        .acumulado-icon { font-size: 2rem; animation: pulse 1s ease-in-out infinite; }
        .acumulado-text { font-size: 1.5rem; font-weight: 800; color: #fff; text-transform: uppercase; letter-spacing: 2px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .acumulado-desc { font-size: 0.8rem; color: rgba(255,255,255,0.9); width: 100%; }
        .acumulado-prize { animation: pulseBox 1.5s ease-in-out infinite; }
        @keyframes gradientMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        @keyframes pulseBox { 0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); } 50% { box-shadow: 0 0 20px 10px rgba(239,68,68,0.2); } }
        .result-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; text-align: left; }
        .result-prize { background: linear-gradient(135deg, #f59e0b, #d97706); color: #000; padding: 0.6rem 1rem; border-radius: 8px; font-weight: 700; text-align: center; min-width: 180px; }
        .result-prize-label { font-size: 0.7rem; opacity: 0.8; }
        .result-prize-value { font-size: 1.1rem; }
        
        /* Rateio de Premiações - Layout Horizontal */
        .rateio-section { margin-top: 1.25rem; padding-top: 1.25rem; border-top: 1px dashed #334155; }
        .rateio-box-full { background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 0.75rem 1rem; }
        .rateio-title { color: #64748b; font-size: 0.75rem; margin-bottom: 0.75rem; text-align: center; }
        .rateio-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem; }
        .rateio-item-h { background: #1e293b; border: 1px solid #334155; border-radius: 6px; padding: 0.5rem 0.75rem; text-align: center; min-width: 100px; }
        .rateio-pts { font-weight: 700; font-size: 0.85rem; margin-bottom: 0.2rem; }
        .rateio-pts.pts15 { color: #22c55e; }
        .rateio-pts.pts14 { color: #10b981; }
        .rateio-pts.pts13 { color: #6366f1; }
        .rateio-pts.pts12 { color: #8b5cf6; }
        .rateio-pts.pts11 { color: #f59e0b; }
        .rateio-valor { color: #f1f5f9; font-weight: 600; font-size: 0.8rem; }
        .rateio-ganh { color: #64748b; font-size: 0.65rem; margin-top: 0.2rem; }
        
        /* Layout Resultado - Volante e Stats lado a lado */
        .resultado-content { display: flex; gap: 1.5rem; justify-content: center; align-items: flex-start; flex-wrap: wrap; margin-bottom: 1.5rem; }
        .resultado-stats { display: flex; flex-direction: column; gap: 0.75rem; }
        
        .volante-section { display: flex; flex-wrap: wrap; gap: 1.5rem; justify-content: center; align-items: flex-start; margin-bottom: 1.5rem; }
        .volante-container { text-align: center; }
        .volante-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; max-width: 280px; margin: 0 auto; }
        .volante-num { width: 48px; height: 48px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem; border: 2px solid #334155; background: #1e293b; color: #64748b; position: relative; transition: all 0.2s; }
        .volante-num.sorteado { background: linear-gradient(135deg, #10b981, #059669); border-color: #10b981; color: white; box-shadow: 0 2px 8px rgba(16,185,129,0.4); }
        .volante-num.moldura { border-color: #f59e0b; }
        .volante-num.moldura.sorteado { box-shadow: 0 2px 8px rgba(16,185,129,0.4), inset 0 0 0 2px #f59e0b; }
        .volante-num.miolo { border-color: #6366f1; }
        .volante-num.miolo.sorteado { box-shadow: 0 2px 8px rgba(16,185,129,0.4), inset 0 0 0 2px #6366f1; }
        .volante-num .num-badge { position: absolute; top: -4px; right: -4px; width: 14px; height: 14px; border-radius: 50%; font-size: 0.5rem; display: flex; align-items: center; justify-content: center; font-weight: 700; }
        .volante-num .num-badge.par { background: #3b82f6; color: white; }
        .volante-num .num-badge.impar { background: #ef4444; color: white; }
        .volante-legend { display: flex; gap: 1rem; justify-content: center; margin-top: 0.75rem; flex-wrap: wrap; }
        .vleg-item { display: flex; align-items: center; gap: 4px; font-size: 0.7rem; color: #94a3b8; }
        .vleg-dot { width: 12px; height: 12px; border-radius: 4px; }
        .vleg-dot.sorteado { background: #10b981; }
        .vleg-dot.moldura-dot { background: transparent; border: 2px solid #f59e0b; }
        .vleg-dot.miolo-dot { background: transparent; border: 2px solid #6366f1; }
        
        .linhas-colunas { display: flex; flex-direction: column; gap: 1rem; }
        .lc-box { background: #0f172a; border-radius: 8px; padding: 0.75rem; }
        .lc-title { font-size: 0.75rem; color: #64748b; margin-bottom: 0.5rem; text-align: center; }
        .lc-grid { display: flex; gap: 6px; justify-content: center; }
        .lc-item { width: 36px; height: 36px; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 700; }
        .lc-item.linha { background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; }
        .lc-item.coluna { background: linear-gradient(135deg, #f59e0b, #d97706); color: #000; }
        .lc-item span:first-child { font-size: 0.6rem; opacity: 0.8; }
        .lc-item span:last-child { font-size: 0.9rem; }
        
        .stats-detailed { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-bottom: 1.5rem; }
        
        /* Novo Layout Estatísticas com Padrão */
        .stats-detailed-new { background: #0f172a; border: 1px solid #334155; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; }
        .stats-title { font-size: 0.9rem; font-weight: 600; color: #94a3b8; margin-bottom: 1rem; text-align: center; }
        .stats-grid-new { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; }
        .stat-card { background: #1e293b; border: 2px solid #334155; border-radius: 10px; padding: 0.75rem; text-align: center; transition: all 0.3s; }
        .stat-card.dentro { border-color: #22c55e; background: rgba(34,197,94,0.1); }
        .stat-card.fora { border-color: #ef4444; background: rgba(239,68,68,0.1); }
        .stat-card-header { display: flex; align-items: center; justify-content: center; gap: 0.4rem; margin-bottom: 0.5rem; }
        .stat-card-icon { font-size: 1rem; }
        .stat-card-title { font-size: 0.75rem; color: #94a3b8; font-weight: 500; }
        .stat-card-value { font-size: 1.25rem; font-weight: 700; color: #f1f5f9; margin-bottom: 0.25rem; }
        .stat-card.dentro .stat-card-value { color: #22c55e; }
        .stat-card.fora .stat-card-value { color: #ef4444; }
        .stat-card-ideal { font-size: 0.65rem; color: #64748b; margin-bottom: 0.4rem; }
        .stat-card-status { font-size: 0.7rem; font-weight: 600; padding: 0.2rem 0.5rem; border-radius: 4px; display: inline-block; }
        .stat-card.dentro .stat-card-status { background: #22c55e; color: #000; }
        .stat-card.fora .stat-card-status { background: #ef4444; color: #fff; }
        .stat-card-numbers { font-size: 0.65rem; color: #64748b; margin-top: 0.3rem; word-break: break-all; }
        
        /* Tendências - Números Maiores */
        .tendencias-section { display: flex; flex-direction: column; gap: 0.75rem; }
        .tendencias-row { display: flex; flex-direction: column; gap: 0.5rem; }
        .tendencias-label { font-size: 0.8rem; color: #94a3b8; font-weight: 500; }
        .tendencias-nums { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .tend-num { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 48px; height: 56px; border-radius: 8px; font-size: 1.25rem; font-weight: 700; color: #fff; transition: transform 0.2s; }
        .tend-num:hover { transform: scale(1.1); }
        .tend-num small { font-size: 0.65rem; font-weight: 400; opacity: 0.85; margin-top: 2px; }
        .tend-num.quente { background: linear-gradient(135deg, #ef4444, #f59e0b); box-shadow: 0 2px 8px rgba(239,68,68,0.4); }
        .tend-num.fria { background: linear-gradient(135deg, #6366f1, #8b5cf6); box-shadow: 0 2px 8px rgba(99,102,241,0.4); }
        .stat-box { background: #0f172a; border-radius: 10px; padding: 0.75rem; display: flex; align-items: center; gap: 0.75rem; border: 1px solid #334155; }
        .stat-icon { font-size: 1.5rem; }
        .stat-info { flex: 1; }
        .stat-label { font-size: 0.7rem; color: #64748b; }
        .stat-value { font-size: 1rem; font-weight: 700; color: #10b981; }
        .stat-value.warning { color: #f59e0b; }
        .stat-value.danger { color: #ef4444; }
        .stat-value.info { color: #6366f1; }
        
        .ordem-sorteio { text-align: center; }
        .resultado-csn { margin-top: 0.75rem; padding: 0.5rem 1rem; background: linear-gradient(135deg, #0f172a, rgba(16,185,129,0.15)); border: 1px solid #10b981; border-radius: 8px; display: inline-block; }
        .csn-label { font-size: 0.8rem; color: #94a3b8; }
        .csn-value { font-size: 1.1rem; font-weight: 700; color: #10b981; margin-left: 0.3rem; }
        .os-title { font-size: 0.8rem; color: #64748b; margin-bottom: 0.75rem; }
        
        /* Números Ausentes Último Sorteio */
        .ausentes-ultimo { text-align: center; margin-top: 1.25rem; padding-top: 1.25rem; border-top: 1px dashed #334155; }
        .ausentes-balls { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
        .ausentes-balls .ball-aus { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #334155, #1e293b); border: 2px solid #475569; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.8rem; color: #94a3b8; transition: all 0.2s; }
        .ausentes-balls .ball-aus:hover { transform: scale(1.1); border-color: #64748b; }
        .ausentes-balls .ball-aus.quente { border-color: #ef4444; color: #ef4444; background: rgba(239,68,68,0.1); }
        .ausentes-balls .ball-aus.morno { border-color: #f59e0b; color: #f59e0b; background: rgba(245,158,11,0.1); }
        .ausentes-balls .ball-aus.frio { border-color: #6366f1; color: #6366f1; background: rgba(99,102,241,0.1); }
        .result-title { font-size: 0.8rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px; }
        .result-num { font-size: 1.8rem; font-weight: 700; color: #10b981; margin: 0.5rem 0; }
        .result-date { color: #94a3b8; font-size: 0.85rem; }
        .balls { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; margin-top: 1rem; }
        .ball { width: 36px; height: 36px; border-radius: 50%; background: #10b981; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem; }
        .numgrid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; max-width: 300px; margin: 1rem auto; }
        .numbtn { aspect-ratio: 1; border: 2px solid #334155; border-radius: 8px; background: #1e293b; color: #f1f5f9; font-weight: 700; cursor: pointer; font-size: 0.9rem; transition: all 0.15s; }
        .numbtn:hover { border-color: #10b981; transform: scale(1.05); }
        .numbtn.sel { background: #10b981; border-color: #10b981; }
        .numbtn.fix { background: #6366f1; border-color: #6366f1; }
        .numbtn.exc { background: #ef4444; border-color: #ef4444; opacity: 0.8; }
        .numbtn.mold { box-shadow: inset 0 0 0 2px #f59e0b; }
        .btn { padding: 10px 18px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 5px; }
        .btn-p { background: #10b981; color: white; }
        .btn-p:hover { background: #059669; }
        .btn-s { background: #334155; color: #f1f5f9; }
        .btn-d { background: #ef4444; color: white; }
        .btn-a { background: #6366f1; color: white; }
        .btn-w { background: #f59e0b; color: #000; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .btns { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 1rem; }
        .fgroup { margin-bottom: 0.75rem; }
        .flabel { display: block; margin-bottom: 0.3rem; color: #94a3b8; font-size: 0.8rem; }
        .fsel, .finput { width: 100%; padding: 8px 12px; border: 1px solid #334155; border-radius: 6px; background: #0f172a; color: #f1f5f9; font-size: 0.9rem; }
        .fsel:focus, .finput:focus { outline: none; border-color: #10b981; }
        .stat { background: #1e293b; border: 1px solid #334155; border-radius: 10px; padding: 1rem; text-align: center; }
        .stat-v { font-size: 1.5rem; font-weight: 700; color: #10b981; }
        .stat-l { color: #64748b; font-size: 0.75rem; margin-top: 0.2rem; }
        .tabs { display: flex; gap: 3px; background: #0f172a; padding: 3px; border-radius: 6px; margin-bottom: 1rem; }
        .tab { flex: 1; padding: 7px; border: none; background: transparent; color: #64748b; font-size: 0.8rem; cursor: pointer; border-radius: 4px; }
        .tab.active { background: #10b981; color: white; }
        .fbox { background: #0f172a; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem; }
        .fbox-t { font-size: 0.7rem; color: #64748b; margin-bottom: 0.5rem; text-transform: uppercase; }
        .cnt { display: inline-flex; align-items: center; gap: 5px; background: #334155; padding: 5px 10px; border-radius: 12px; font-size: 0.8rem; }
        .cnt-v { font-weight: 700; color: #10b981; }
        .jogo { background: #1e293b; border: 1px solid #334155; border-radius: 10px; padding: 0.75rem; margin-bottom: 0.75rem; }
        
        /* Layout Meus Jogos com Painel */
        .jogos-container { display: grid; grid-template-columns: 1fr 280px; gap: 1rem; }
        .jogos-main { min-width: 0; }
        .jogos-stats { position: sticky; top: 1rem; height: fit-content; }
        
        /* Painel de Estatísticas */
        .stats-panel { padding: 1rem !important; }
        .stats-panel .card-title { font-size: 1rem; margin-bottom: 1rem; }
        .stats-panel-item { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; border-radius: 8px; margin-bottom: 0.4rem; background: #0f172a; }
        .stats-panel-item.total { background: linear-gradient(135deg, #1e293b, #334155); padding: 0.75rem; }
        .stats-panel-icon { font-size: 1.5rem; }
        .stats-panel-info { text-align: right; }
        .stats-panel-value { font-size: 1.75rem; font-weight: 800; color: #f1f5f9; }
        .stats-panel-label { font-size: 0.7rem; color: #64748b; }
        .stats-panel-divider { height: 1px; background: #334155; margin: 0.75rem 0; }
        .stats-panel-subtitle { font-size: 0.75rem; color: #94a3b8; font-weight: 600; margin-bottom: 0.5rem; }
        .stats-panel-pts { font-size: 0.8rem; font-weight: 600; padding: 0.2rem 0.5rem; border-radius: 4px; }
        .stats-panel-qty { font-size: 1.1rem; font-weight: 700; }
        .stats-panel-item.pts15 .stats-panel-pts { background: #22c55e; color: #000; }
        .stats-panel-item.pts15 .stats-panel-qty { color: #22c55e; }
        .stats-panel-item.pts14 .stats-panel-pts { background: #10b981; color: #000; }
        .stats-panel-item.pts14 .stats-panel-qty { color: #10b981; }
        .stats-panel-item.pts13 .stats-panel-pts { background: #6366f1; color: #fff; }
        .stats-panel-item.pts13 .stats-panel-qty { color: #6366f1; }
        .stats-panel-item.pts12 .stats-panel-pts { background: #8b5cf6; color: #fff; }
        .stats-panel-item.pts12 .stats-panel-qty { color: #8b5cf6; }
        .stats-panel-item.pts11 .stats-panel-pts { background: #f59e0b; color: #000; }
        .stats-panel-item.pts11 .stats-panel-qty { color: #f59e0b; }
        .stats-panel-label2 { font-size: 0.75rem; color: #94a3b8; }
        .stats-panel-money { font-size: 1rem; font-weight: 700; }
        .stats-panel-money.negative { color: #ef4444; }
        .stats-panel-money.positive { color: #22c55e; }
        .stats-panel-item.saldo { background: linear-gradient(135deg, #1e293b, #334155); padding: 0.75rem; }
        .stats-panel-saldo { font-size: 1.3rem; font-weight: 800; }
        .stats-panel-saldo.positivo { color: #22c55e; }
        .stats-panel-saldo.negativo { color: #ef4444; }
        .stats-panel-saldo.zero { color: #94a3b8; }
        
        @media (max-width: 900px) {
            .jogos-container { grid-template-columns: 1fr; }
            .jogos-stats { position: static; order: -1; }
            .stats-panel-item.total { padding: 0.5rem; }
            .stats-panel-value { font-size: 1.5rem; }
        }
        
        /* Jogos Repetidos */
        .alert-repetidos { background: linear-gradient(135deg, #7c2d12, #9a3412); border: 2px solid #f97316; border-radius: 10px; padding: 0.75rem; margin-bottom: 1rem; animation: pulseAlert 2s ease-in-out infinite; }
        .alert-rep-content { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
        .alert-rep-icon { font-size: 1.5rem; animation: shake 0.5s ease-in-out infinite; }
        .alert-rep-text { flex: 1; min-width: 200px; }
        .alert-rep-text strong { display: block; color: #fff; font-size: 0.9rem; }
        .alert-rep-text span { color: #fed7aa; font-size: 0.8rem; }
        .jogo-repetido { border: 2px solid #f97316 !important; background: linear-gradient(135deg, #1e293b, rgba(249,115,22,0.15)) !important; position: relative; }
        .repetido-badge { background: linear-gradient(135deg, #f97316, #ea580c); color: #fff; font-size: 0.7rem; font-weight: 700; padding: 0.3rem 0.6rem; border-radius: 6px; margin-bottom: 0.5rem; display: inline-block; animation: pulseAlert 1.5s ease-in-out infinite; }
        @keyframes pulseAlert { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        @keyframes shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } }
        
        /* Erros - Números repetidos no mesmo jogo */
        .alert-nums-rep { background: linear-gradient(135deg, #7f1d1d, #991b1b) !important; border-color: #ef4444 !important; }
        .jogo-erro { border: 2px solid #ef4444 !important; background: linear-gradient(135deg, #1e293b, rgba(239,68,68,0.2)) !important; }
        .erro-badge { background: linear-gradient(135deg, #ef4444, #dc2626); color: #fff; font-size: 0.7rem; font-weight: 700; padding: 0.3rem 0.6rem; border-radius: 6px; margin-bottom: 0.5rem; display: inline-block; }
        .num-erro { background: #ef4444 !important; color: #fff !important; border: 2px solid #fff !important; animation: pulseNum 0.5s ease-in-out infinite; }
        @keyframes pulseNum { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .jogo:hover { border-color: #10b981; }
        .jogo-numero { position: absolute; top: -8px; left: -8px; background: #8B008B; color: white; font-size: 0.7rem; font-weight: 700; padding: 0.25rem 0.6rem; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .jogo { position: relative; }
        .jogo-h { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.3rem; font-size: 0.8rem; color: #64748b; flex-wrap: wrap; gap: 0.3rem; }
        .jogo-csn { font-size: 0.7rem; color: #10b981; font-weight: 600; margin-bottom: 0.4rem; padding: 0.2rem 0.5rem; background: rgba(16,185,129,0.1); border-radius: 4px; display: inline-block; }
        .jogo-n { display: flex; flex-wrap: wrap; gap: 4px; }
        .jn { width: 28px; height: 28px; border-radius: 5px; background: #334155; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; }
        .jn.hit { background: #22c55e; }
        .jogo-f { display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #334155; flex-wrap: wrap; gap: 0.5rem; }
        .jpts { font-size: 1rem; font-weight: 700; color: #10b981; }
        .jpts.prize { color: #f59e0b; }
        .pbadge { background: #f59e0b; color: #000; padding: 2px 6px; border-radius: 3px; font-size: 0.6rem; font-weight: 700; margin-left: 5px; }
        .freq { display: flex; align-items: center; gap: 8px; padding: 0.5rem 0; border-bottom: 1px solid #334155; }
        .fnum { width: 30px; height: 30px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; }
        .fnum.hot { background: #ef4444; }
        .fnum.cold { background: #6366f1; }
        .fbar { flex: 1; height: 5px; background: #0f172a; border-radius: 3px; overflow: hidden; }
        .ffill { height: 100%; border-radius: 3px; }
        .ffill.hot { background: linear-gradient(90deg, #ef4444, #f59e0b); }
        .ffill.cold { background: linear-gradient(90deg, #6366f1, #06b6d4); }
        .agrid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        
        /* Gráfico de Linha */
        .grafico-controls { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .grafico-controls .fgroup { flex: 1; min-width: 150px; }
        .grafico-container { background: #0f172a; border-radius: 10px; padding: 1rem; margin-bottom: 1rem; height: 300px; position: relative; }
        .grafico-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; }
        .grafico-stat-item { background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 0.75rem; text-align: center; }
        .grafico-stat-value { font-size: 1.25rem; font-weight: 700; color: #f1f5f9; }
        .grafico-stat-label { font-size: 0.7rem; color: #64748b; margin-top: 0.2rem; }
        .grafico-stat-item.minimo .grafico-stat-value { color: #ef4444; }
        .grafico-stat-item.maximo .grafico-stat-value { color: #22c55e; }
        .grafico-stat-item.media .grafico-stat-value { color: #6366f1; }
        .grafico-stat-item.atual .grafico-stat-value { color: #f59e0b; }
        .grafico-stat-item.positivo .grafico-stat-value { color: #22c55e; }
        .grafico-stat-item.negativo .grafico-stat-value { color: #ef4444; }
        
        /* Análise Histórica */
        .analise-hist-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; }
        .analise-hist-card { background: #0f172a; border-radius: 12px; padding: 1rem; border: 1px solid #334155; }
        .analise-hist-card-title { font-size: 0.9rem; font-weight: 700; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .analise-hist-card-title .icon { font-size: 1.2rem; }
        .analise-hist-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 0.75rem; }
        .analise-hist-stat { text-align: center; padding: 0.5rem; background: #1e293b; border-radius: 8px; }
        .analise-hist-stat-value { font-size: 1.1rem; font-weight: 700; color: #f1f5f9; }
        .analise-hist-stat-label { font-size: 0.65rem; color: #64748b; }
        .analise-hist-bar { height: 8px; background: #1e293b; border-radius: 4px; overflow: hidden; margin-top: 0.5rem; }
        .analise-hist-bar-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
        .analise-hist-dist { display: flex; justify-content: space-between; font-size: 0.7rem; color: #64748b; margin-top: 0.25rem; }
        .analise-hist-freq { display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top: 0.5rem; }
        .analise-hist-freq-item { padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
        .analise-hist-loading { text-align: center; padding: 2rem; color: #f59e0b; }
        
        /* Probabilidades / Estudo de Combinações */
        .prob-config { background: #0f172a; border-radius: 12px; padding: 1.25rem; border: 1px solid #334155; margin-bottom: 1.5rem; }
        .prob-config-title { font-size: 1rem; font-weight: 700; color: #f1f5f9; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .prob-field { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: #1e293b; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid #334155; }
        .prob-field-label { font-size: 0.85rem; color: #f1f5f9; }
        .prob-field-label small { color: #64748b; font-size: 0.75rem; display: block; margin-top: 0.2rem; }
        .prob-field-label .var { color: #f59e0b; font-weight: 700; }
        .prob-field input { width: 80px; padding: 0.5rem; font-size: 1rem; font-weight: 700; text-align: center; background: #0f172a; border: 2px solid #334155; border-radius: 8px; color: #f1f5f9; }
        .prob-field input:focus { border-color: #6366f1; outline: none; }
        .prob-field input:disabled { background: #1e293b; color: #64748b; cursor: not-allowed; }
        .prob-field.disabled { opacity: 0.6; }
        .prob-advanced-toggle { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; cursor: pointer; font-size: 0.8rem; color: #94a3b8; }
        .prob-advanced-toggle input { accent-color: #6366f1; }
        .prob-resultado { background: linear-gradient(135deg, #1e293b, #0f172a); border: 2px solid #6366f1; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .prob-resultado-title { font-size: 0.9rem; color: #94a3b8; margin-bottom: 1rem; text-align: center; }
        .prob-resultado-main { text-align: center; margin-bottom: 1.5rem; }
        .prob-resultado-percent { font-size: 2rem; font-weight: 700; color: #22c55e; }
        .prob-resultado-chance { font-size: 1rem; color: #f1f5f9; margin-top: 0.5rem; }
        .prob-resultado-chance strong { color: #f59e0b; }
        .prob-formula { background: #0f172a; border-radius: 12px; padding: 1.5rem; text-align: center; margin-bottom: 1.5rem; border: 1px solid #334155; }
        .prob-formula-title { font-size: 0.85rem; color: #8b5cf6; font-weight: 600; margin-bottom: 1rem; }
        .prob-formula-math { display: flex; align-items: center; justify-content: center; gap: 0.5rem; flex-wrap: wrap; }
        .prob-formula-var { font-size: 1.5rem; font-style: italic; color: #f1f5f9; }
        .prob-formula-eq { font-size: 1.5rem; color: #64748b; margin: 0 0.5rem; }
        .prob-frac { display: inline-flex; flex-direction: column; align-items: center; vertical-align: middle; }
        .prob-frac-num { border-bottom: 2px solid #64748b; padding-bottom: 0.3rem; }
        .prob-frac-den { padding-top: 0.3rem; }
        .prob-comb { display: inline-flex; align-items: center; font-size: 1.1rem; }
        .prob-comb-paren { font-size: 2rem; color: #64748b; line-height: 1; }
        .prob-comb-inner { display: inline-flex; flex-direction: column; align-items: center; padding: 0 0.3rem; }
        .prob-comb-top { color: #ef4444; font-weight: 700; }
        .prob-comb-bot { color: #3b82f6; font-weight: 700; }
        .prob-times { font-size: 1.5rem; color: #64748b; margin: 0 0.5rem; }
        .prob-tabela { margin-bottom: 1.5rem; }
        .prob-tabela table { width: 100%; border-collapse: collapse; }
        .prob-tabela th, .prob-tabela td { padding: 0.75rem; text-align: center; border: 1px solid #334155; font-size: 0.8rem; }
        .prob-tabela th { background: #8B008B; color: white; font-weight: 600; }
        .prob-tabela tr:nth-child(even) { background: #0f172a; }
        .prob-tabela tr:nth-child(odd) { background: #1e293b; }
        .prob-tabela tr:hover { background: #334155; }
        .prob-tabela .highlight { background: rgba(34,197,94,0.2); color: #22c55e; font-weight: 700; }
        .prob-tabela .premio { color: #f59e0b; }
        .prob-comparativo { margin-bottom: 1.5rem; }
        .prob-grafico { height: 300px; background: #0f172a; border-radius: 12px; padding: 1rem; border: 1px solid #334155; }
        .prob-info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .prob-info-card { background: #0f172a; border-radius: 10px; padding: 1rem; border: 1px solid #334155; text-align: center; }
        .prob-info-card-value { font-size: 1.5rem; font-weight: 700; }
        .prob-info-card-label { font-size: 0.75rem; color: #64748b; margin-top: 0.25rem; }
        
        /* Mesclagem Estratégica */
        .mescla-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .mescla-box { background: #0f172a; border: 2px solid #334155; border-radius: 12px; padding: 1rem; }
        .mescla-box.sorteadas { border-color: #22c55e; }
        .mescla-box.ausentes { border-color: #ef4444; }
        .mescla-box-title { font-size: 0.9rem; font-weight: 700; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .mescla-box.sorteadas .mescla-box-title { color: #22c55e; }
        .mescla-box.ausentes .mescla-box-title { color: #ef4444; }
        .mescla-balls { display: flex; flex-wrap: wrap; gap: 0.4rem; }
        .mescla-ball { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; position: relative; }
        .mescla-ball.sorteada { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
        .mescla-ball.ausente { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .mescla-ball.selected { box-shadow: 0 0 0 3px #fff, 0 0 0 5px #6366f1; transform: scale(1.1); }
        .mescla-ball .temp-badge { position: absolute; top: -4px; right: -4px; font-size: 0.5rem; padding: 1px 3px; border-radius: 3px; }
        .mescla-ball .temp-badge.quente { background: #f97316; color: white; }
        .mescla-ball .temp-badge.morno { background: #eab308; color: black; }
        .mescla-ball .temp-badge.frio { background: #3b82f6; color: white; }
        .mescla-config { background: #1e293b; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; }
        .mescla-config-title { font-size: 1rem; font-weight: 700; color: #f1f5f9; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .mescla-config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .mescla-range-group { background: #0f172a; border-radius: 8px; padding: 1rem; }
        .mescla-range-label { font-size: 0.8rem; color: #94a3b8; margin-bottom: 0.5rem; }
        .mescla-range-inputs { display: flex; gap: 0.5rem; align-items: center; }
        .mescla-range-inputs select { flex: 1; }
        .mescla-range-inputs span { color: #64748b; font-size: 0.8rem; }
        .mescla-temp-section { background: #1e293b; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; }
        .mescla-temp-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .mescla-temp-box { background: #0f172a; border-radius: 8px; padding: 1rem; }
        .mescla-temp-title { font-size: 0.85rem; font-weight: 600; margin-bottom: 0.75rem; }
        .mescla-temp-options { display: flex; flex-direction: column; gap: 0.5rem; }
        .mescla-temp-opt { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.4rem; border-radius: 6px; transition: background 0.2s; }
        .mescla-temp-opt:hover { background: #1e293b; }
        .mescla-temp-opt input { accent-color: #6366f1; }
        .mescla-temp-opt label { font-size: 0.8rem; color: #cbd5e1; cursor: pointer; }
        .mescla-estrategias { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; margin-bottom: 1.5rem; }
        .mescla-estr-btn { background: #1e293b; border: 2px solid #334155; border-radius: 8px; padding: 0.75rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .mescla-estr-btn:hover { border-color: #6366f1; background: #2d3a4f; }
        .mescla-estr-btn.active { border-color: #6366f1; background: linear-gradient(135deg, #4f46e5, #6366f1); }
        .mescla-estr-name { font-size: 0.85rem; font-weight: 700; color: #f1f5f9; margin-bottom: 0.25rem; }
        .mescla-estr-desc { font-size: 0.65rem; color: #94a3b8; }
        .mescla-preview { background: #0f172a; border: 1px solid #334155; border-radius: 10px; padding: 1rem; margin-bottom: 1.5rem; }
        .mescla-preview-title { font-size: 0.85rem; color: #94a3b8; margin-bottom: 0.75rem; }
        .mescla-preview-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap; }
        .mescla-preview-label { font-size: 0.75rem; min-width: 100px; }
        .mescla-preview-nums { display: flex; gap: 0.3rem; flex-wrap: wrap; }
        .mescla-preview-num { padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        .mescla-preview-num.sort { background: rgba(34,197,94,0.2); color: #22c55e; }
        .mescla-preview-num.aus { background: rgba(239,68,68,0.2); color: #ef4444; }
        .mescla-filtros { background: #1e293b; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; }
        .mescla-filtros-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; }
        .mescla-filtro-item { background: #0f172a; border-radius: 8px; padding: 0.75rem; }
        .mescla-filtro-label { font-size: 0.7rem; color: #64748b; margin-bottom: 0.4rem; }
        .mescla-filtro-inputs { display: flex; gap: 0.3rem; }
        .mescla-filtro-inputs input { width: 100%; padding: 0.4rem; font-size: 0.8rem; background: #1e293b; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9; text-align: center; }
        .mescla-gerar { display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; margin-bottom: 1.5rem; }
        .mescla-resultado { margin-top: 1rem; }
        @media (max-width: 768px) {
            .mescla-stats { grid-template-columns: 1fr; }
            .mescla-temp-grid { grid-template-columns: 1fr; }
            .mescla-ball { width: 32px; height: 32px; font-size: 0.7rem; }
        }
        
        /* Cards de Frequência - Estilo Profissional */
        .freq-card { background: #0f172a; border: 2px solid #334155; border-radius: 10px; padding: 0.6rem 0.4rem; text-align: center; transition: all 0.2s; }
        .freq-card:hover { transform: scale(1.03); }
        .freq-card-num { font-size: 1.5rem; font-weight: 800; color: #f1f5f9; margin-bottom: 0.2rem; }
        .freq-card-count { font-size: 0.85rem; color: #94a3b8; margin-bottom: 0.4rem; }
        .freq-card-status { font-size: 0.65rem; font-weight: 700; padding: 0.2rem 0.5rem; border-radius: 4px; display: inline-block; }
        
        /* Status Quente (verde) */
        .freq-card.freq-quente { border-color: #22c55e; background: linear-gradient(135deg, #0f172a, rgba(34,197,94,0.1)); }
        .freq-card.freq-quente .freq-card-num { color: #22c55e; }
        .freq-card.freq-quente .freq-card-status { background: #22c55e; color: #000; }
        
        /* Status Morno (amarelo) */
        .freq-card.freq-morno { border-color: #f59e0b; background: linear-gradient(135deg, #0f172a, rgba(245,158,11,0.1)); }
        .freq-card.freq-morno .freq-card-num { color: #f59e0b; }
        .freq-card.freq-morno .freq-card-status { background: #f59e0b; color: #000; }
        
        /* Status Frio (vermelho) */
        .freq-card.freq-frio { border-color: #ef4444; background: linear-gradient(135deg, #0f172a, rgba(239,68,68,0.1)); }
        .freq-card.freq-frio .freq-card-num { color: #ef4444; }
        .freq-card.freq-frio .freq-card-status { background: #ef4444; color: #fff; }
        
        .anum { aspect-ratio: 1; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 700; color: white; font-size: 1.4rem; min-height: 60px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: transform 0.2s; }
        .anum:hover { transform: scale(1.05); }
        .anum span { font-size: 1.4rem; font-weight: 800; }
        .anum small { font-size: 0.75rem; opacity: 0.9; margin-top: 2px; }
        .alert { padding: 0.75rem; border-radius: 8px; margin-bottom: 0.75rem; font-size: 0.85rem; }
        .alert-i { background: rgba(99,102,241,0.1); border: 1px solid #6366f1; color: #6366f1; }
        .alert-s { background: rgba(34,197,94,0.1); border: 1px solid #22c55e; color: #22c55e; }
        .empty { text-align: center; padding: 2rem; color: #64748b; }
        .empty-i { font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.3; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; }
        .modal.show { display: flex; }
        .mbox { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 1.25rem; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto; }
        .mhead { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .mclose { background: none; border: none; color: #64748b; font-size: 1.3rem; cursor: pointer; }
        .crow { display: flex; justify-content: space-between; padding: 0.4rem 0; border-bottom: 1px solid #334155; font-size: 0.8rem; }
        .toast { position: fixed; bottom: 15px; right: 15px; background: #1e293b; border: 1px solid #10b981; padding: 0.75rem 1rem; border-radius: 8px; display: none; z-index: 1001; font-size: 0.85rem; }
        .toast.show { display: block; }
        .ditem { background: #1e293b; border: 1px solid #334155; border-radius: 10px; padding: 1rem; cursor: pointer; transition: all 0.2s; }
        .ditem:hover { border-color: #10b981; transform: translateY(-2px); }
        .dtitle { font-weight: 600; color: #10b981; margin-bottom: 0.25rem; font-size: 0.9rem; }
        .ddesc { font-size: 0.75rem; color: #64748b; }
        .djogos { font-size: 0.8rem; color: #f59e0b; font-weight: 600; }
        .dcusto { font-size: 0.7rem; color: #22c55e; margin-top: 0.25rem; }
        .desd-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.75rem; max-height: 400px; overflow-y: auto; padding-right: 0.5rem; }
        
        /* Fechamento com Garantia */
        .fech-config { background: #0f172a; border: 1px solid #334155; border-radius: 10px; padding: 1rem; }
        .fech-info { background: linear-gradient(135deg, #1e293b, rgba(16,185,129,0.1)); border: 1px solid #10b981; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
        .fech-info-row { display: flex; justify-content: space-between; padding: 0.4rem 0; border-bottom: 1px solid #334155; }
        .fech-info-row:last-child { border-bottom: none; }
        .fech-info-label { color: #94a3b8; font-size: 0.85rem; }
        .fech-info-value { font-weight: 600; font-size: 0.9rem; }
        .fech-info-value.lucro { color: #22c55e; }
        .fech-info-value.prejuizo { color: #ef4444; }
        .fech-info-value.neutro { color: #f59e0b; }
        .fech-tabela { overflow-x: auto; }
        .fech-tabela table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .fech-tabela th { background: #334155; color: #f1f5f9; padding: 0.6rem; text-align: left; font-weight: 600; }
        .fech-tabela td { padding: 0.5rem 0.6rem; border-bottom: 1px solid #334155; }
        .fech-tabela tr:hover { background: rgba(16,185,129,0.1); }
        .fech-tabela tr.lucro td { background: rgba(34,197,94,0.1); }
        .fech-tabela tr.prejuizo td { background: rgba(239,68,68,0.05); }
        .fech-tabela .badge-lucro { background: #22c55e; color: #000; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
        .fech-tabela .badge-prejuizo { background: #ef4444; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
        .fech-tabela .btn-usar { background: #6366f1; color: #fff; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; }
        .fech-tabela .btn-usar:hover { background: #4f46e5; }
        .fech-selecao { margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #334155; }
        
        /* Fechamento Inteligente */
        .smart-box { background: #0f172a; border: 1px solid #334155; border-radius: 10px; padding: 1rem; text-align: center; }
        .smart-box.ausentes-box { border-color: #ef4444; background: rgba(239,68,68,0.05); }
        .smart-box.sorteadas-box { border-color: #22c55e; background: rgba(34,197,94,0.05); }
        .smart-title { font-weight: 700; font-size: 0.9rem; margin-bottom: 0.25rem; }
        .ausentes-box .smart-title { color: #ef4444; }
        .sorteadas-box .smart-title { color: #22c55e; }
        .smart-desc { font-size: 0.75rem; color: #64748b; margin-bottom: 0.75rem; }
        .smart-balls { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
        .smart-ball { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.75rem; }
        .smart-ball.aus { background: rgba(239,68,68,0.2); border: 2px solid #ef4444; color: #ef4444; }
        .smart-ball.sort { background: rgba(34,197,94,0.2); border: 2px solid #22c55e; color: #22c55e; }
        .smart-config { background: #1e293b; border: 1px solid #334155; border-radius: 10px; padding: 1rem; margin-top: 1rem; }
        .smart-config-title { font-weight: 600; color: #f59e0b; margin-bottom: 1rem; font-size: 0.9rem; }
        .smart-info { background: linear-gradient(135deg, #0f172a, rgba(99,102,241,0.1)); border: 1px solid #6366f1; border-radius: 8px; padding: 1rem; margin: 1rem 0; }
        .smart-info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; }
        .smart-info-item { text-align: center; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 6px; }
        .smart-info-value { font-size: 1.1rem; font-weight: 700; color: #f1f5f9; }
        .smart-info-label { font-size: 0.7rem; color: #94a3b8; margin-top: 0.2rem; }
        .smart-info-value.lucro { color: #22c55e; }
        .smart-info-value.prejuizo { color: #ef4444; }
        .smart-manual { background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
        .smart-sel-grid { display: flex; flex-wrap: wrap; gap: 6px; }
        .smart-sel-btn { width: 36px; height: 36px; border-radius: 50%; border: 2px solid #22c55e; background: rgba(34,197,94,0.1); color: #22c55e; font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
        .smart-sel-btn:hover { background: rgba(34,197,94,0.3); }
        .smart-sel-btn.selected { background: #22c55e; color: #000; }
        .desd-info-box { background: linear-gradient(135deg, #0f172a, rgba(16,185,129,0.1)); border: 1px solid #10b981; border-radius: 10px; padding: 1rem; margin-bottom: 1rem; }
        .desd-info-row { display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #334155; font-size: 0.85rem; }
        .desd-info-row:last-child { border-bottom: none; }
        .desd-info-label { color: #94a3b8; }
        .desd-info-value { color: #10b981; font-weight: 600; }
        .mold-info { font-size: 0.75rem; color: #f59e0b; margin-top: 0.5rem; padding: 0.5rem; background: rgba(245,158,11,0.1); border-radius: 6px; }
        @media (max-width: 600px) { 
            nav button { padding: 6px 10px; font-size: 0.75rem; } 
            .numgrid { max-width: 100%; }
            
            /* Frequência responsiva */
            .agrid { grid-template-columns: repeat(5, 1fr); gap: 6px; }
            .freq-card { padding: 0.4rem 0.2rem; border-radius: 8px; }
            .freq-card-num { font-size: 1.1rem; }
            .freq-card-count { font-size: 0.7rem; margin-bottom: 0.3rem; }
            .freq-card-status { font-size: 0.55rem; padding: 0.15rem 0.3rem; }
            
            /* Análise do Resultado responsiva */
            .stats-grid-new { grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
            .stat-card { padding: 0.5rem; }
            .stat-card-value { font-size: 1rem; }
            .stat-card-title { font-size: 0.65rem; }
            .stat-card-ideal { font-size: 0.55rem; }
            .stat-card-status { font-size: 0.6rem; }
            
            /* Tendências responsiva */
            .tend-num { width: 40px; height: 48px; font-size: 1.1rem; }
            .tend-num small { font-size: 0.6rem; }
        }
        
        /* Estatística Posicional */
        .pos-tabs { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 1rem; }
        .pos-tab { padding: 8px 12px; border: 1px solid #334155; border-radius: 6px; background: #1e293b; color: #94a3b8; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.2s; }
        .pos-tab:hover { border-color: #10b981; color: #f1f5f9; }
        .pos-tab.active { background: #10b981; border-color: #10b981; color: white; }
        .pos-chart-container { background: #0f172a; border-radius: 10px; padding: 1rem; margin-bottom: 1rem; overflow-x: auto; }
        .pos-chart { display: flex; align-items: flex-end; gap: 6px; min-height: 200px; padding-bottom: 30px; position: relative; }
        .pos-bar-wrapper { display: flex; flex-direction: column; align-items: center; min-width: 32px; }
        .pos-bar { width: 28px; border-radius: 4px 4px 0 0; transition: all 0.3s ease; cursor: pointer; position: relative; }
        .pos-bar:hover { opacity: 0.8; transform: scaleY(1.02); }
        .pos-bar-label { font-size: 0.7rem; color: #64748b; margin-top: 6px; font-weight: 600; }
        .pos-bar-value { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); font-size: 0.65rem; color: #f1f5f9; font-weight: 700; white-space: nowrap; }
        .pos-bar.highlight { box-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }
        .pos-summary { background: #0f172a; border-radius: 10px; padding: 1rem; }
        .pos-summary-title { font-size: 0.85rem; font-weight: 600; color: #10b981; margin-bottom: 0.75rem; }
        .pos-summary-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
        .pos-summary-item { background: #1e293b; border-radius: 6px; padding: 8px; text-align: center; }
        .pos-summary-pos { font-size: 0.65rem; color: #64748b; }
        .pos-summary-num { font-size: 1.1rem; font-weight: 700; color: #10b981; }
        .pos-summary-pct { font-size: 0.65rem; color: #f59e0b; }
        
        /* Números Ausentes */
        .ausentes-grid { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .ausente-num { width: 42px; height: 42px; border-radius: 50%; background: linear-gradient(135deg, #ef4444, #dc2626); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; color: white; box-shadow: 0 2px 8px rgba(239,68,68,0.4); animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 2px 8px rgba(239,68,68,0.4); } 50% { box-shadow: 0 2px 16px rgba(239,68,68,0.7); } }
        .ausentes-empty { color: #22c55e; font-size: 0.9rem; text-align: center; padding: 1rem; }
        
        /* Ciclo de Fechamento */
        .ciclo-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
        .ciclo-item { background: #0f172a; border-radius: 8px; padding: 8px 4px; text-align: center; position: relative; border: 2px solid transparent; transition: all 0.2s; }
        .ciclo-item.atrasado { border-color: #ef4444; background: rgba(239,68,68,0.1); }
        .ciclo-item.alerta { border-color: #f59e0b; background: rgba(245,158,11,0.1); }
        .ciclo-item.normal { border-color: #334155; }
        .ciclo-item.recente { border-color: #22c55e; background: rgba(34,197,94,0.1); }
        .ciclo-num { font-size: 1rem; font-weight: 700; color: #f1f5f9; }
        .ciclo-val { font-size: 0.7rem; margin-top: 2px; }
        .ciclo-val.atrasado { color: #ef4444; }
        .ciclo-val.alerta { color: #f59e0b; }
        .ciclo-val.normal { color: #64748b; }
        .ciclo-val.recente { color: #22c55e; }
        .ciclo-legend { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #334155; }
        .ciclo-leg-item { display: flex; align-items: center; gap: 5px; font-size: 0.7rem; color: #94a3b8; }
        .ciclo-leg-dot { width: 12px; height: 12px; border-radius: 3px; }
        .ciclo-leg-dot.recente { background: #22c55e; }
        .ciclo-leg-dot.normal { background: #334155; }
        .ciclo-leg-dot.alerta { background: #f59e0b; }
        .ciclo-leg-dot.atrasado { background: #ef4444; }
        
        /* Tabela de Ciclos Mazusoft */
        .ciclo-table-wrapper { overflow-x: auto; max-height: 500px; overflow-y: auto; border: 1px solid #334155; border-radius: 8px; }
        .ciclo-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .ciclo-table th, .ciclo-table td { padding: 6px 4px; text-align: center; border: 1px solid #334155; min-width: 32px; }
        .ciclo-table th { background: #0f172a; color: #94a3b8; font-weight: 600; position: sticky; top: 0; z-index: 10; }
        .ciclo-table th.dez-header { background: #1e293b; color: #10b981; }
        .ciclo-table td.conc-cell { background: #0f172a; color: #94a3b8; font-weight: 600; position: sticky; left: 0; z-index: 5; }
        .ciclo-table td.saiu { background: #10b981; color: white; font-weight: 700; }
        .ciclo-table td.nao-saiu { background: #1e293b; color: #334155; }
        .ciclo-table td.fechou { background: #f59e0b !important; color: #000 !important; font-weight: 700; }
        .ciclo-table tr.ciclo-fechou { border-bottom: 3px solid #f59e0b; }
        .ciclo-table tr:hover td:not(.conc-cell) { opacity: 0.85; }
        
        /* Legenda de Colunas */
        .ciclo-colunas-legend { background: #0f172a; border: 1px solid #334155; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
        .ciclo-col-title { font-size: 0.85rem; color: #94a3b8; margin-bottom: 0.75rem; font-weight: 600; }
        .ciclo-col-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 0.5rem; }
        .ciclo-col-item { display: flex; align-items: center; gap: 0.5rem; background: #1e293b; border: 2px solid; border-radius: 6px; padding: 0.4rem 0.6rem; font-size: 0.75rem; color: #f1f5f9; }
        .ciclo-col-dot { width: 14px; height: 14px; border-radius: 3px; flex-shrink: 0; }
        .ciclo-col-item strong { color: inherit; }
        
        /* Separadores verticais por linha do volante */
        .ciclo-table td.linha-sep { border-right: 3px solid #FFA500 !important; }
        .ciclo-table td.faltantes-cell { background: #0f172a; text-align: left; padding: 4px 8px; white-space: nowrap; }
        .falta-num { display: inline-block; background: linear-gradient(135deg, #ef4444, #b91c1c); color: white; width: 22px; height: 22px; line-height: 22px; text-align: center; border-radius: 4px; font-size: 0.65rem; font-weight: 700; margin: 1px; }
        .ciclo-status { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; padding: 1rem; background: #0f172a; border-radius: 8px; }
        .ciclo-status-item { text-align: center; }
        .ciclo-status-value { font-size: 1.5rem; font-weight: 700; }
        .ciclo-status-value.aberto { color: #ef4444; }
        .ciclo-status-value.fechado { color: #22c55e; }
        .ciclo-status-label { font-size: 0.7rem; color: #64748b; }
        .ciclo-hist { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-top: 1rem; }
        .ciclo-hist-item { background: #1e293b; border: 1px solid #334155; border-radius: 6px; padding: 6px 10px; font-size: 0.75rem; }
        .ciclo-hist-item span { color: #10b981; font-weight: 600; }
    </style>
</head>
<body>
    <header>
        <div class="header-inner">
            <div class="logo">🍀 Lotofácil <span class="badge">v3</span></div>
            <div class="status-bar">
                <span class="status-indicator" id="statusIndicator" title="Status dos dados">
                    <span class="status-dot" id="statusDot"></span>
                    <span class="status-text" id="statusText">Carregando...</span>
                </span>
                <span class="last-update" id="lastUpdate"></span>
                <button class="btn-refresh" onclick="forceRefresh()" title="Atualizar dados">🔄</button>
            </div>
            <nav id="nav">
                <button class="active" data-sec="inicio">Início</button>
                <button data-sec="gerador">Gerador</button>
                <button data-sec="mesclagem">Mesclagem</button>
                <button data-sec="desd">Desdobrar</button>
                <button data-sec="jogos">Meus Jogos</button>
                <button data-sec="stats">Estatísticas</button>
                <button data-sec="fechamento">Fechamento</button>
                <button data-sec="probabilidades">Probabilidades</button>
            </nav>
        </div>
    </header>

    <main>
        <!-- INICIO -->
        <section id="inicio">
            <!-- Banner de Acumulado -->
            <div class="acumulado-banner hidden" id="acumuladoBanner"></div>
            
            <div class="card result-card-full">
                <div class="result-header">
                    <div>
                        <div class="result-title">Último Resultado</div>
                        <div class="result-num" id="rnum">Carregando...</div>
                        <div class="result-date" id="rdate"></div>
                    </div>
                    <div class="result-prize" id="rprize"></div>
                </div>
                
                <!-- Volante + Linhas/Colunas + Estatísticas lado a lado -->
                <div class="resultado-content">
                    <!-- Coluna Esquerda: Volante -->
                    <div class="volante-container">
                        <div class="volante-grid" id="volanteGrid"></div>
                        <div class="volante-legend">
                            <span class="vleg-item"><span class="vleg-dot sorteado"></span>Sorteado</span>
                            <span class="vleg-item"><span class="vleg-dot moldura-dot"></span>Moldura</span>
                            <span class="vleg-item"><span class="vleg-dot miolo-dot"></span>Miolo</span>
                        </div>
                    </div>
                    
                    <!-- Coluna Direita: Linhas, Colunas e Stats -->
                    <div class="resultado-stats">
                        <div class="lc-box">
                            <div class="lc-title">Por Linha</div>
                            <div class="lc-grid" id="linhasGrid"></div>
                        </div>
                        <div class="lc-box">
                            <div class="lc-title">Por Coluna</div>
                            <div class="lc-grid" id="colunasGrid"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Estatísticas Detalhadas com Indicador de Padrão -->
                <div class="stats-detailed-new">
                    <div class="stats-title">📊 Análise do Resultado</div>
                    <div class="stats-grid-new">
                        <div class="stat-card" id="cardPares">
                            <div class="stat-card-header">
                                <span class="stat-card-icon">🔢</span>
                                <span class="stat-card-title">Pares / Ímpares</span>
                            </div>
                            <div class="stat-card-value" id="statPares">-</div>
                            <div class="stat-card-ideal">Ideal: 7/8 ou 8/7</div>
                            <div class="stat-card-status" id="statusPares"></div>
                        </div>
                        
                        <div class="stat-card" id="cardMoldura">
                            <div class="stat-card-header">
                                <span class="stat-card-icon">🔲</span>
                                <span class="stat-card-title">Moldura / Miolo</span>
                            </div>
                            <div class="stat-card-value" id="statMoldura">-</div>
                            <div class="stat-card-ideal">Ideal: 9-11 / 4-6</div>
                            <div class="stat-card-status" id="statusMoldura"></div>
                        </div>
                        
                        <div class="stat-card" id="cardPrimos">
                            <div class="stat-card-header">
                                <span class="stat-card-icon">🔵</span>
                                <span class="stat-card-title">Primos</span>
                            </div>
                            <div class="stat-card-value" id="statPrimos">-</div>
                            <div class="stat-card-ideal">Ideal: 4-6 de 9</div>
                            <div class="stat-card-status" id="statusPrimos"></div>
                        </div>
                        
                        <div class="stat-card" id="cardFibo">
                            <div class="stat-card-header">
                                <span class="stat-card-icon">🌀</span>
                                <span class="stat-card-title">Fibonacci</span>
                            </div>
                            <div class="stat-card-value" id="statFibo">-</div>
                            <div class="stat-card-ideal">Ideal: 3-5 de 7</div>
                            <div class="stat-card-status" id="statusFibo"></div>
                        </div>
                        
                        <div class="stat-card" id="cardMult3">
                            <div class="stat-card-header">
                                <span class="stat-card-icon">✖️</span>
                                <span class="stat-card-title">Múltiplos de 3</span>
                            </div>
                            <div class="stat-card-value" id="statMult3">-</div>
                            <div class="stat-card-ideal">Ideal: 4-6 de 8</div>
                            <div class="stat-card-status" id="statusMult3"></div>
                        </div>
                        
                        <div class="stat-card" id="cardSoma">
                            <div class="stat-card-header">
                                <span class="stat-card-icon">➕</span>
                                <span class="stat-card-title">Soma Total</span>
                            </div>
                            <div class="stat-card-value" id="statSoma">-</div>
                            <div class="stat-card-ideal">Ideal: 170-220</div>
                            <div class="stat-card-status" id="statusSoma"></div>
                        </div>
                        
                        <div class="stat-card" id="cardRepet">
                            <div class="stat-card-header">
                                <span class="stat-card-icon">🔄</span>
                                <span class="stat-card-title">Repetidas</span>
                            </div>
                            <div class="stat-card-value" id="statRepet">-</div>
                            <div class="stat-card-ideal">Ideal: 5-10 de 15</div>
                            <div class="stat-card-status" id="statusRepet"></div>
                        </div>
                        
                        <div class="stat-card" id="cardSeq">
                            <div class="stat-card-header">
                                <span class="stat-card-icon">📊</span>
                                <span class="stat-card-title">Sequências</span>
                            </div>
                            <div class="stat-card-value" id="statSeq">-</div>
                            <div class="stat-card-ideal">Ideal: 2-4 pares</div>
                            <div class="stat-card-status" id="statusSeq"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Números em ordem de sorteio -->
                <div class="ordem-sorteio">
                    <div class="os-title">Dezenas Sorteadas (ordem crescente)</div>
                    <div class="balls" id="rballs"></div>
                    <div class="resultado-csn" id="resultadoCSN"></div>
                </div>
                
                <!-- Números Ausentes do Último Sorteio -->
                <div class="ausentes-ultimo">
                    <div class="os-title">Dezenas que NÃO saíram</div>
                    <div class="ausentes-balls" id="rAusentes"></div>
                </div>
                
                <!-- Rateio de Premiações -->
                <div class="rateio-section">
                    <div class="rateio-box-full" id="rateioBox"></div>
                </div>
            </div>
            
            <div class="grid2">
                <div class="card">
                    <div class="card-title">📊 Tendências (10 últimos sorteios)</div>
                    <div id="homeStats">Carregando...</div>
                </div>
                <div class="card">
                    <div class="card-title">📋 Resumo</div>
                    <div class="grid3">
                        <div class="stat"><div class="stat-v" id="totJogos">0</div><div class="stat-l">Jogos Salvos</div></div>
                        <div class="stat"><div class="stat-v" id="maxAcerto">-</div><div class="stat-l">Maior Acerto</div></div>
                        <div class="stat"><div class="stat-v" id="totPremios">0</div><div class="stat-l">Prêmios</div></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- GERADOR -->
        <section id="gerador" class="hidden">
            <div class="grid2">
                <div>
                    <div class="card">
                        <div class="card-title">Seleção Manual</div>
                        <div class="tabs" id="modeTabs">
                            <button class="tab active" data-mode="normal">Normal</button>
                            <button class="tab" data-mode="fix">Fixar</button>
                            <button class="tab" data-mode="exc">Excluir</button>
                        </div>
                        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.75rem;">
                            <div class="cnt">Sel: <span class="cnt-v" id="cntSel">0</span></div>
                            <div class="cnt" style="background:rgba(99,102,241,0.2);">Fix: <span class="cnt-v" id="cntFix" style="color:#6366f1;">0</span></div>
                            <div class="cnt" style="background:rgba(239,68,68,0.2);">Exc: <span class="cnt-v" id="cntExc" style="color:#ef4444;">0</span></div>
                        </div>
                        <div class="numgrid" id="numGrid"></div>
                        <div class="mold-info">🔶 Moldura (bordas): 1,2,3,4,5,6,10,11,15,16,20,21,22,23,24,25</div>
                        <div class="btns">
                            <button class="btn btn-s" onclick="clearSel()">Limpar</button>
                            <button class="btn btn-s" onclick="randSel()">🎲 Aleatório</button>
                            <button class="btn btn-p" onclick="saveManual()">💾 Salvar</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title">⚡ Gerador Automático</div>
                        <div class="grid2">
                            <div class="fgroup"><label class="flabel">Quantidade</label><select class="fsel" id="gQtd"><option value="1">1</option><option value="5" selected>5</option><option value="10">10</option><option value="15">15</option><option value="20">20</option><option value="50">50</option></select></div>
                            <div class="fgroup"><label class="flabel">Dezenas</label><select class="fsel" id="gDez"><option value="15" selected>15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option></select></div>
                        </div>
                        <div class="fbox">
                            <div class="fbox-t">Pares</div>
                            <div class="grid2">
                                <div class="fgroup"><label class="flabel">Mín</label><select class="fsel" id="minPar"><option value="5">5</option><option value="6" selected>6</option><option value="7">7</option></select></div>
                                <div class="fgroup"><label class="flabel">Máx</label><select class="fsel" id="maxPar"><option value="7">7</option><option value="8" selected>8</option><option value="9">9</option></select></div>
                            </div>
                        </div>
                        <div class="fbox">
                            <div class="fbox-t">Primos (2,3,5,7,11,13,17,19,23)</div>
                            <div class="grid2">
                                <div class="fgroup"><label class="flabel">Mín</label><select class="fsel" id="minPri"><option value="3">3</option><option value="4" selected>4</option><option value="5">5</option></select></div>
                                <div class="fgroup"><label class="flabel">Máx</label><select class="fsel" id="maxPri"><option value="5">5</option><option value="6" selected>6</option><option value="7">7</option></select></div>
                            </div>
                        </div>
                        <div class="fbox">
                            <div class="fbox-t">Soma (média ~195)</div>
                            <div class="grid2">
                                <div class="fgroup"><label class="flabel">Mín</label><input type="number" class="finput" id="minSoma" value="170"></div>
                                <div class="fgroup"><label class="flabel">Máx</label><input type="number" class="finput" id="maxSoma" value="220"></div>
                            </div>
                        </div>
                        <div class="fbox">
                            <div class="fbox-t">Moldura (16 números das bordas)</div>
                            <div class="grid2">
                                <div class="fgroup"><label class="flabel">Mín na Moldura</label><select class="fsel" id="minMold"><option value="7">7</option><option value="8">8</option><option value="9" selected>9</option><option value="10">10</option></select></div>
                                <div class="fgroup"><label class="flabel">Máx na Moldura</label><select class="fsel" id="maxMold"><option value="10">10</option><option value="11" selected>11</option><option value="12">12</option><option value="13">13</option></select></div>
                            </div>
                        </div>
                        <div class="fbox">
                            <div class="fbox-t">Sequências</div>
                            <div class="grid2">
                                <div class="fgroup"><label class="flabel">Máx Consecutivos</label><select class="fsel" id="maxSeq"><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option></select></div>
                                <div class="fgroup"><label class="flabel">Repetir Último</label><select class="fsel" id="repUlt"><option value="0">Não</option><option value="5">Mín 5</option><option value="6" selected>Mín 6</option><option value="7">Mín 7</option></select></div>
                            </div>
                        </div>
                        <label style="display:flex;align-items:center;gap:6px;font-size:0.8rem;color:#94a3b8;margin-top:0.5rem;cursor:pointer;">
                            <input type="checkbox" id="useFix" checked style="width:16px;height:16px;"> Usar fixos/excluídos
                        </label>
                        <button class="btn btn-p" onclick="generate()" style="width:100%;margin-top:1rem;">⚡ Gerar</button>
                    </div>
                    <div class="card">
                        <div class="card-title">📍 Geração Posicional Avançada</div>
                        <p style="color:#94a3b8;font-size:0.8rem;margin-bottom:1rem;">Gera jogos baseados na frequência estatística de cada posição (1ª a 15ª dezena).</p>
                        
                        <!-- Controles Básicos -->
                        <div class="grid2">
                            <div class="fgroup">
                                <label class="flabel">Quantidade de Jogos</label>
                                <select class="fsel" id="gPosQtd">
                                    <option value="1">1 jogo</option>
                                    <option value="5" selected>5 jogos</option>
                                    <option value="10">10 jogos</option>
                                    <option value="15">15 jogos</option>
                                    <option value="20">20 jogos</option>
                                    <option value="50">50 jogos</option>
                                </select>
                            </div>
                            <div class="fgroup">
                                <label class="flabel">Base de Concursos</label>
                                <select class="fsel" id="gPosRange">
                                    <option value="10">Últimos 10</option>
                                    <option value="25" selected>Últimos 25</option>
                                    <option value="50">Últimos 50</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid2">
                            <div class="fgroup">
                                <label class="flabel">Intensidade do Peso</label>
                                <select class="fsel" id="gPosIntens">
                                    <option value="leve">Leve (mais variado)</option>
                                    <option value="medio" selected>Médio (equilibrado)</option>
                                    <option value="forte">Forte (favorece frequentes)</option>
                                </select>
                            </div>
                            <div class="fgroup">
                                <label class="flabel">Posições Estatísticas</label>
                                <select class="fsel" id="gPosMix">
                                    <option value="15" selected>Todas (15)</option>
                                    <option value="12">12 posições + 3 aleatórias</option>
                                    <option value="10">10 posições + 5 aleatórias</option>
                                    <option value="8">8 posições + 7 aleatórias</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Pesos por Região -->
                        <div class="fbox">
                            <div class="fbox-t">Peso por Região do Jogo</div>
                            <div class="grid3">
                                <div class="fgroup">
                                    <label class="flabel">Início (1ª-5ª)</label>
                                    <select class="fsel" id="gPosPesoIni">
                                        <option value="0.5">Baixo</option>
                                        <option value="1" selected>Normal</option>
                                        <option value="1.5">Alto</option>
                                        <option value="2">Muito Alto</option>
                                    </select>
                                </div>
                                <div class="fgroup">
                                    <label class="flabel">Meio (6ª-10ª)</label>
                                    <select class="fsel" id="gPosPesoMeio">
                                        <option value="0.5">Baixo</option>
                                        <option value="1" selected>Normal</option>
                                        <option value="1.5">Alto</option>
                                        <option value="2">Muito Alto</option>
                                    </select>
                                </div>
                                <div class="fgroup">
                                    <label class="flabel">Fim (11ª-15ª)</label>
                                    <select class="fsel" id="gPosPesoFim">
                                        <option value="0.5">Baixo</option>
                                        <option value="1" selected>Normal</option>
                                        <option value="1.5">Alto</option>
                                        <option value="2">Muito Alto</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filtros Específicos -->
                        <div class="fbox">
                            <div class="fbox-t">Filtros Específicos</div>
                            <div class="grid2">
                                <div class="fgroup">
                                    <label class="flabel">Mín. Números Quentes (Top 10)</label>
                                    <select class="fsel" id="gPosMinQuentes">
                                        <option value="0">Sem mínimo</option>
                                        <option value="5">Mínimo 5</option>
                                        <option value="6" selected>Mínimo 6</option>
                                        <option value="7">Mínimo 7</option>
                                        <option value="8">Mínimo 8</option>
                                    </select>
                                </div>
                                <div class="fgroup">
                                    <label class="flabel">Máx. Salto entre Números</label>
                                    <select class="fsel" id="gPosMaxSalto">
                                        <option value="0">Sem limite</option>
                                        <option value="5">Máx. 5</option>
                                        <option value="6" selected>Máx. 6</option>
                                        <option value="7">Máx. 7</option>
                                        <option value="8">Máx. 8</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid3">
                                <div class="fgroup">
                                    <label class="flabel">Mín. no Início (01-08)</label>
                                    <select class="fsel" id="gPosMinIni">
                                        <option value="0">Sem mínimo</option>
                                        <option value="3">Mínimo 3</option>
                                        <option value="4" selected>Mínimo 4</option>
                                        <option value="5">Mínimo 5</option>
                                    </select>
                                </div>
                                <div class="fgroup">
                                    <label class="flabel">Mín. no Meio (09-17)</label>
                                    <select class="fsel" id="gPosMinMeio">
                                        <option value="0">Sem mínimo</option>
                                        <option value="4">Mínimo 4</option>
                                        <option value="5" selected>Mínimo 5</option>
                                        <option value="6">Mínimo 6</option>
                                    </select>
                                </div>
                                <div class="fgroup">
                                    <label class="flabel">Mín. no Fim (18-25)</label>
                                    <select class="fsel" id="gPosMinFim">
                                        <option value="0">Sem mínimo</option>
                                        <option value="3">Mínimo 3</option>
                                        <option value="4" selected>Mínimo 4</option>
                                        <option value="5">Mínimo 5</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Checkboxes -->
                        <div style="margin:0.75rem 0;">
                            <label style="display:flex;align-items:center;gap:6px;font-size:0.8rem;color:#94a3b8;cursor:pointer;margin-bottom:0.5rem;">
                                <input type="checkbox" id="gPosUseFix" checked style="width:16px;height:16px;"> Respeitar fixos/excluídos
                            </label>
                            <label style="display:flex;align-items:center;gap:6px;font-size:0.8rem;color:#94a3b8;cursor:pointer;margin-bottom:0.5rem;">
                                <input type="checkbox" id="gPosValidar" checked style="width:16px;height:16px;"> Validar filtros gerais (soma, pares, etc.)
                            </label>
                            <label style="display:flex;align-items:center;gap:6px;font-size:0.8rem;color:#94a3b8;cursor:pointer;margin-bottom:0.5rem;">
                                <input type="checkbox" id="gPosEvitarFrios" checked style="width:16px;height:16px;"> Evitar números frios (freq. zero)
                            </label>
                            <label style="display:flex;align-items:center;gap:6px;font-size:0.8rem;color:#94a3b8;cursor:pointer;">
                                <input type="checkbox" id="gPosSimular" checked style="width:16px;height:16px;"> Simular acertos históricos
                            </label>
                        </div>
                        
                        <button class="btn btn-a" onclick="generatePosicional()" style="width:100%;">📍 Gerar por Estatística Posicional</button>
                        
                        <!-- Resultados -->
                        <div id="posGenInfo" style="margin-top:1rem;"></div>
                        <div id="posGenList" style="margin-top:1rem;"></div>
                        <div class="btns hidden" id="posGenBtns">
                            <button class="btn btn-p" onclick="saveAllPosGen()">💾 Salvar Todos</button>
                            <button class="btn btn-w" onclick="exportPosGenExcel()">📊 Excel</button>
                            <button class="btn btn-a" onclick="exportPosGenTxt()">📄 TXT</button>
                            <button class="btn btn-s" onclick="clearPosGen()">🗑️ Limpar</button>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="card">
                        <div class="card-title">Jogos Gerados</div>
                        <div id="genList"><div class="empty"><div class="empty-i">🎲</div><p>Nenhum jogo</p></div></div>
                        <div class="btns hidden" id="genBtns">
                            <button class="btn btn-p" onclick="saveAllGen()">💾 Salvar Todos</button>
                            <button class="btn btn-w" onclick="exportGenExcel()">📊 Excel</button>
                            <button class="btn btn-a" onclick="exportGenTxt()">📄 TXT</button>
                            <button class="btn btn-s" onclick="clearGen()">🗑️ Limpar</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- MESCLAGEM ESTRATÉGICA -->
        <section id="mesclagem" class="hidden">
            <div class="card">
                <div class="card-title">🔀 Mesclagem Estratégica</div>
                <p style="color:#94a3b8;font-size:0.85rem;margin-bottom:1rem;">
                    Combine dezenas sorteadas com ausentes do último concurso. Estatisticamente, 8-10 dezenas se repetem entre sorteios consecutivos.
                </p>
                
                <!-- Estatísticas do Último Sorteio -->
                <div class="mescla-stats" id="mesclaStats">
                    <div class="mescla-box sorteadas">
                        <div class="mescla-box-title">✅ 15 Dezenas Sorteadas</div>
                        <div class="mescla-balls" id="mesclaSorteadas"></div>
                    </div>
                    <div class="mescla-box ausentes">
                        <div class="mescla-box-title">❌ 10 Dezenas Ausentes</div>
                        <div class="mescla-balls" id="mesclaAusentes"></div>
                    </div>
                </div>
                
                <!-- Estratégias Pré-definidas -->
                <div class="mescla-config-title">⚡ Estratégias Rápidas</div>
                <div class="mescla-estrategias">
                    <div class="mescla-estr-btn" onclick="setMesclaEstrategia('conservadora')">
                        <div class="mescla-estr-name">🛡️ Conservadora</div>
                        <div class="mescla-estr-desc">9-11 sort. + 4-6 aus.</div>
                    </div>
                    <div class="mescla-estr-btn active" onclick="setMesclaEstrategia('equilibrada')">
                        <div class="mescla-estr-name">⚖️ Equilibrada</div>
                        <div class="mescla-estr-desc">8-10 sort. + 5-7 aus.</div>
                    </div>
                    <div class="mescla-estr-btn" onclick="setMesclaEstrategia('ousada')">
                        <div class="mescla-estr-name">🎲 Ousada</div>
                        <div class="mescla-estr-desc">6-8 sort. + 7-9 aus.</div>
                    </div>
                    <div class="mescla-estr-btn" onclick="setMesclaEstrategia('ciclo')">
                        <div class="mescla-estr-name">🔄 Ciclo</div>
                        <div class="mescla-estr-desc">7-9 sort. + 6-8 aus.</div>
                    </div>
                    <div class="mescla-estr-btn" onclick="setMesclaEstrategia('personalizada')">
                        <div class="mescla-estr-name">🎯 Personalizada</div>
                        <div class="mescla-estr-desc">Configure abaixo</div>
                    </div>
                </div>
                
                <!-- Configuração de Quantidades -->
                <div class="mescla-config">
                    <div class="mescla-config-title">⚙️ Configuração de Quantidades</div>
                    <div class="mescla-config-grid">
                        <div class="mescla-range-group">
                            <div class="mescla-range-label">Dezenas SORTEADAS (repetir do último)</div>
                            <div class="mescla-range-inputs">
                                <select class="fsel" id="mesclaMinSort" onchange="updateMesclaPreview()">
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8" selected>8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                    <option value="13">13</option>
                                </select>
                                <span>a</span>
                                <select class="fsel" id="mesclaMaxSort" onchange="updateMesclaPreview()">
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10" selected>10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                    <option value="13">13</option>
                                </select>
                            </div>
                        </div>
                        <div class="mescla-range-group">
                            <div class="mescla-range-label">Dezenas AUSENTES (não saíram)</div>
                            <div class="mescla-range-inputs">
                                <select class="fsel" id="mesclaMinAus" onchange="updateMesclaPreview()">
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5" selected>5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                </select>
                                <span>a</span>
                                <select class="fsel" id="mesclaMaxAus" onchange="updateMesclaPreview()">
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7" selected>7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Filtro de Temperatura -->
                <div class="mescla-temp-section">
                    <div class="mescla-config-title">🌡️ Filtro de Temperatura (Frequência nos últimos 10 sorteios)</div>
                    <div class="mescla-temp-grid">
                        <div class="mescla-temp-box">
                            <div class="mescla-temp-title" style="color:#22c55e;">Das SORTEADAS, priorizar:</div>
                            <div class="mescla-temp-options">
                                <div class="mescla-temp-opt">
                                    <input type="radio" name="tempSort" id="tempSortTodas" value="todas">
                                    <label for="tempSortTodas">Todas iguais (aleatório)</label>
                                </div>
                                <div class="mescla-temp-opt">
                                    <input type="radio" name="tempSort" id="tempSortQuentes" value="quentes" checked>
                                    <label for="tempSortQuentes">🔥 Mais quentes (maior frequência)</label>
                                </div>
                                <div class="mescla-temp-opt">
                                    <input type="radio" name="tempSort" id="tempSortFrias" value="frias">
                                    <label for="tempSortFrias">❄️ Mais frias (menor frequência)</label>
                                </div>
                            </div>
                        </div>
                        <div class="mescla-temp-box">
                            <div class="mescla-temp-title" style="color:#ef4444;">Das AUSENTES, priorizar:</div>
                            <div class="mescla-temp-options">
                                <div class="mescla-temp-opt">
                                    <input type="radio" name="tempAus" id="tempAusTodas" value="todas">
                                    <label for="tempAusTodas">Todas iguais (aleatório)</label>
                                </div>
                                <div class="mescla-temp-opt">
                                    <input type="radio" name="tempAus" id="tempAusQuentes" value="quentes">
                                    <label for="tempAusQuentes">🔥 Mais quentes (saíram recente)</label>
                                </div>
                                <div class="mescla-temp-opt">
                                    <input type="radio" name="tempAus" id="tempAusFrias" value="frias" checked>
                                    <label for="tempAusFrias">❄️ Mais frias (estão "devendo")</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Filtro Posicional -->
                <div class="mescla-temp-section">
                    <div class="mescla-config-title">📍 Filtro Posicional (Estatística por Posição 1ª a 15ª)</div>
                    <p style="color:#94a3b8;font-size:0.75rem;margin-bottom:1rem;">
                        Prioriza números que mais aparecem em cada posição (1ª a 15ª bola em ordem crescente) nos últimos sorteios.
                    </p>
                    <div class="mescla-config-grid">
                        <div class="mescla-range-group">
                            <div class="mescla-range-label">Usar estatística posicional</div>
                            <div class="mescla-temp-options">
                                <div class="mescla-temp-opt">
                                    <input type="checkbox" id="mesclaUsarPosicional" onchange="togglePosicionalOptions()">
                                    <label for="mesclaUsarPosicional">Ativar filtro posicional</label>
                                </div>
                            </div>
                        </div>
                        <div class="mescla-range-group">
                            <div class="mescla-range-label">Base de análise</div>
                            <select class="fsel" id="mesclaPosRange">
                                <option value="10">Últimos 10 sorteios</option>
                                <option value="25" selected>Últimos 25 sorteios</option>
                                <option value="50">Últimos 50 sorteios</option>
                                <option value="100">Últimos 100 sorteios</option>
                            </select>
                        </div>
                    </div>
                    <div id="mesclaPosicionalConfig" class="hidden" style="margin-top:1rem;">
                        <div class="mescla-config-grid">
                            <div class="mescla-range-group">
                                <div class="mescla-range-label" style="color:#22c55e;">SORTEADAS - Dezenas com melhor posicional</div>
                                <div class="mescla-range-inputs">
                                    <span style="font-size:0.75rem;color:#94a3b8;">Mínimo:</span>
                                    <select class="fsel" id="mesclaMinPosSort">
                                        <option value="0">0</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3" selected>3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                    </select>
                                    <span style="font-size:0.7rem;color:#64748b;">dezenas top posicional</span>
                                </div>
                            </div>
                            <div class="mescla-range-group">
                                <div class="mescla-range-label" style="color:#ef4444;">AUSENTES - Dezenas com melhor posicional</div>
                                <div class="mescla-range-inputs">
                                    <span style="font-size:0.75rem;color:#94a3b8;">Mínimo:</span>
                                    <select class="fsel" id="mesclaMinPosAus">
                                        <option value="0">0</option>
                                        <option value="1">1</option>
                                        <option value="2" selected>2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                    </select>
                                    <span style="font-size:0.7rem;color:#64748b;">dezenas top posicional</span>
                                </div>
                            </div>
                        </div>
                        <div class="mescla-preview" style="margin-top:1rem;">
                            <div class="mescla-preview-title">📍 Melhores Posicionais por Grupo</div>
                            <div class="mescla-preview-row">
                                <span class="mescla-preview-label" style="color:#22c55e;">Sorteadas Top:</span>
                                <div class="mescla-preview-nums" id="mesclaPosSortPreview"></div>
                            </div>
                            <div class="mescla-preview-row">
                                <span class="mescla-preview-label" style="color:#ef4444;">Ausentes Top:</span>
                                <div class="mescla-preview-nums" id="mesclaPosAusPreview"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Filtros Estatísticos -->
                <div class="mescla-filtros">
                    <div class="mescla-config-title">📊 Filtros Estatísticos</div>
                    <div class="mescla-filtros-grid">
                        <div class="mescla-filtro-item">
                            <div class="mescla-filtro-label">Pares (de 15)</div>
                            <div class="mescla-filtro-inputs">
                                <input type="number" id="mesclaMinPar" value="6" min="0" max="15">
                                <input type="number" id="mesclaMaxPar" value="9" min="0" max="15">
                            </div>
                        </div>
                        <div class="mescla-filtro-item">
                            <div class="mescla-filtro-label">Primos (de 9)</div>
                            <div class="mescla-filtro-inputs">
                                <input type="number" id="mesclaMinPrimo" value="3" min="0" max="9">
                                <input type="number" id="mesclaMaxPrimo" value="6" min="0" max="9">
                            </div>
                        </div>
                        <div class="mescla-filtro-item">
                            <div class="mescla-filtro-label">Fibonacci (de 7)</div>
                            <div class="mescla-filtro-inputs">
                                <input type="number" id="mesclaMinFibo" value="3" min="0" max="7">
                                <input type="number" id="mesclaMaxFibo" value="5" min="0" max="7">
                            </div>
                        </div>
                        <div class="mescla-filtro-item">
                            <div class="mescla-filtro-label">Moldura (de 16)</div>
                            <div class="mescla-filtro-inputs">
                                <input type="number" id="mesclaMinMold" value="9" min="0" max="16">
                                <input type="number" id="mesclaMaxMold" value="11" min="0" max="16">
                            </div>
                        </div>
                        <div class="mescla-filtro-item">
                            <div class="mescla-filtro-label">Soma Total</div>
                            <div class="mescla-filtro-inputs">
                                <input type="number" id="mesclaMinSoma" value="170" min="120" max="260">
                                <input type="number" id="mesclaMaxSoma" value="220" min="120" max="260">
                            </div>
                        </div>
                        <div class="mescla-filtro-item">
                            <div class="mescla-filtro-label">Múltiplos de 3 (de 8)</div>
                            <div class="mescla-filtro-inputs">
                                <input type="number" id="mesclaMinMult3" value="3" min="0" max="8">
                                <input type="number" id="mesclaMaxMult3" value="6" min="0" max="8">
                            </div>
                        </div>
                        <div class="mescla-filtro-item">
                            <div class="mescla-filtro-label">Sequências (pares consec.)</div>
                            <div class="mescla-filtro-inputs">
                                <input type="number" id="mesclaMinSeq" value="2" min="0" max="14">
                                <input type="number" id="mesclaMaxSeq" value="5" min="0" max="14">
                            </div>
                        </div>
                        <div class="mescla-filtro-item">
                            <div class="mescla-filtro-label">Salto Máximo</div>
                            <div class="mescla-filtro-inputs">
                                <input type="number" id="mesclaMaxSalto" value="6" min="1" max="10">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Preview da Seleção -->
                <div class="mescla-preview">
                    <div class="mescla-preview-title">📈 Preview da Seleção Prioritária</div>
                    <div class="mescla-preview-row">
                        <span class="mescla-preview-label" style="color:#22c55e;">Sorteadas:</span>
                        <div class="mescla-preview-nums" id="mesclaPreviewSort"></div>
                    </div>
                    <div class="mescla-preview-row">
                        <span class="mescla-preview-label" style="color:#ef4444;">Ausentes:</span>
                        <div class="mescla-preview-nums" id="mesclaPreviewAus"></div>
                    </div>
                </div>
                
                <!-- Geração -->
                <div class="mescla-gerar">
                    <div class="fgroup" style="min-width:150px;">
                        <label class="flabel">Quantidade de Jogos</label>
                        <select class="fsel" id="mesclaQtdJogos">
                            <option value="5">5 jogos</option>
                            <option value="10" selected>10 jogos</option>
                            <option value="15">15 jogos</option>
                            <option value="20">20 jogos</option>
                            <option value="30">30 jogos</option>
                            <option value="50">50 jogos</option>
                        </select>
                    </div>
                    <div class="fgroup" style="min-width:180px;">
                        <label class="flabel">Usar como Base para Desdobramento</label>
                        <select class="fsel" id="mesclaBaseDesd">
                            <option value="0">Não (jogos de 15)</option>
                            <option value="16">Sim - Base 16 dezenas</option>
                            <option value="17">Sim - Base 17 dezenas</option>
                            <option value="18">Sim - Base 18 dezenas</option>
                            <option value="19">Sim - Base 19 dezenas</option>
                            <option value="20">Sim - Base 20 dezenas</option>
                        </select>
                    </div>
                    <button class="btn btn-p" onclick="gerarMesclagem()" style="margin-top:auto;">🎯 Gerar Jogos</button>
                </div>
                
                <!-- Diagnóstico -->
                <div id="mesclaDiagnostico"></div>
                
                <!-- Resultado -->
                <div class="mescla-resultado" id="mesclaResultado"></div>
            </div>
        </section>

        <!-- DESDOBRAR -->
        <section id="desd" class="hidden">
            <div class="card">
                <div class="card-title">🎯 Desdobramentos e Fechamentos (61 matrizes)</div>
                <p style="color:#94a3b8;font-size:0.85rem;margin-bottom:1rem;">Matrizes matemáticas que distribuem dezenas em múltiplos jogos com garantias de acerto.</p>
                
                <!-- Filtros -->
                <div class="fbox">
                    <div class="fbox-t">Filtrar Matrizes</div>
                    <div class="grid4">
                        <div class="fgroup">
                            <label class="flabel">Dezenas</label>
                            <select class="fsel" id="filtroDesd">
                                <option value="0">Todas</option>
                                <option value="16">16 dezenas</option>
                                <option value="17">17 dezenas</option>
                                <option value="18">18 dezenas</option>
                                <option value="19">19 dezenas</option>
                                <option value="20">20 dezenas</option>
                                <option value="21">21 dezenas</option>
                                <option value="22">22 dezenas</option>
                                <option value="23">23 dezenas</option>
                                <option value="24">24 dezenas</option>
                                <option value="25">25 dezenas</option>
                            </select>
                        </div>
                        <div class="fgroup">
                            <label class="flabel">Garantia Mínima</label>
                            <select class="fsel" id="filtroGarantia">
                                <option value="0">Todas</option>
                                <option value="11">11 pontos</option>
                                <option value="12">12 pontos</option>
                                <option value="13">13 pontos</option>
                                <option value="14">14 pontos</option>
                            </select>
                        </div>
                        <div class="fgroup">
                            <label class="flabel">Máx. Jogos</label>
                            <select class="fsel" id="filtroJogos">
                                <option value="0">Todos</option>
                                <option value="10">Até 10</option>
                                <option value="20">Até 20</option>
                                <option value="30">Até 30</option>
                                <option value="50">Até 50</option>
                            </select>
                        </div>
                        <div class="fgroup">
                            <label class="flabel">Ordenar</label>
                            <select class="fsel" id="filtroOrdem">
                                <option value="dezenas">Por Dezenas</option>
                                <option value="jogos">Por Qtd Jogos</option>
                                <option value="garantia">Por Garantia</option>
                                <option value="custo">Por Custo</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-s btn-sm" onclick="filtrarDesd()" style="margin-top:0.5rem;">🔍 Filtrar</button>
                </div>
                
                <div id="desdCount" style="color:#94a3b8;font-size:0.8rem;margin-bottom:0.75rem;"></div>
                <div class="desd-grid" id="desdList"></div>
            </div>
            <div class="card hidden" id="desdCfg">
                <div class="card-title">Configurar Desdobramento</div>
                <div class="desd-info-box" id="desdInfoBox"></div>
                <p style="color:#94a3b8;font-size:0.85rem;margin-bottom:0.75rem;" id="desdInfo"></p>
                <div class="cnt" style="margin-bottom:0.75rem;">Selecionadas: <span class="cnt-v" id="desdCnt">0</span> / <span id="desdReq">18</span></div>
                <div class="numgrid" id="desdGrid"></div>
                <div class="btns">
                    <button class="btn btn-s" onclick="clearDesd()">Limpar</button>
                    <button class="btn btn-s" onclick="randomDesd()">🎲 Aleatório</button>
                    <button class="btn btn-p" onclick="applyDesd()">🎯 Gerar Jogos</button>
                </div>
            </div>
            <div class="card hidden" id="desdRes">
                <div class="card-title">Jogos Gerados</div>
                <div id="desdResumo"></div>
                <div id="desdGames"></div>
                <div class="btns">
                    <button class="btn btn-p" onclick="saveDesdGames()">💾 Salvar Todos</button>
                    <button class="btn btn-w" onclick="exportDesdExcel()">📊 Excel</button>
                    <button class="btn btn-a" onclick="exportDesdTxt()">📄 TXT</button>
                </div>
            </div>
        </section>

        <!-- MEUS JOGOS -->
        <section id="jogos" class="hidden">
            <div class="jogos-container">
                <!-- Coluna Principal -->
                <div class="jogos-main">
                    <div class="card">
                        <div class="card-title">Meus Jogos</div>
                        
                        <!-- Alerta de Jogos Repetidos -->
                        <div class="alert-repetidos hidden" id="alertRepetidos"></div>
                        
                        <div clos</"grid2" style="margin-bottom:1rem;">
                            <div class="fgroup"><label class="flabel">Conferir com</label><select class="fsel" id="confSel"><option value="ultimo">Último Resultado</option></select></div>
                            <div style="display:flex;align-items:flex-end;gap:6px;">
                                <button class="btn btn-p" onclick="checkGames()">🔍 Conferir</button>
                                <button class="btn btn-a" onclick="openBatch()">📊 Múltiplos</button>
                            </div>
                        </div>
                        <div class="btns" style="margin-bottom:1rem;">
                            <button class="btn btn-w btn-sm" onclick="exportSavedExcel()">📊 Excel</button>
                            <button class="btn btn-a btn-sm" onclick="exportSavedTxt()">📄 TXT</button>
                            <button class="btn btn-s btn-sm" onclick="exportJ()">💾 JSON</button>
                            <button class="btn btn-s btn-sm" onclick="importJ()" title="JSON, TXT, CSV, Excel">📥 Importar</button>
                            <button class="btn btn-d btn-sm" onclick="clearAllJ()">🗑️ Limpar</button>
                        </div>
                        
                        <!-- Análise Histórica -->
                        <div class="analise-historica" style="margin-bottom:1rem;padding:1rem;background:#0f172a;border-radius:10px;border:1px solid #334155;">
                            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem;">
                                <div>
                                    <div style="font-size:0.9rem;font-weight:600;color:#f1f5f9;">🏆 Análise Histórica</div>
                                    <div style="font-size:0.75rem;color:#94a3b8;">Verifica se seus jogos já foram sorteados (15 pontos) em toda história</div>
                                </div>
                                <button class="btn btn-p btn-sm" onclick="analisarHistorico()">🔍 Analisar</button>
                            </div>
                            <div id="analiseHistoricoResultado" style="margin-top:0.75rem;"></div>
                        </div>
                        
                        <div id="savedList"><div class="empty"><div class="empty-i">📋</div><p>Nenhum jogo salvo</p></div></div>
                    </div>
                </div>
                
                <!-- Painel de Estatísticas -->
                <div class="jogos-stats">
                    <div class="card stats-panel">
                        <div class="card-title">📊 Resumo</div>
                        
                        <div class="stats-panel-item total">
                            <div class="stats-panel-icon">🎰</div>
                            <div class="stats-panel-info">
                                <div class="stats-panel-value" id="statsTotalJogos">0</div>
                                <div class="stats-panel-label">Total  </Jogos</div>
                            </div>
                        </div>
                        
                        <div class="stats-panel-divider"></div>
                        <div class="stats-panel-subtitle">🏆 Premiações</div>
                        
                        <div class="stats-panel-item pts15">
                            <div class="stats-panel-pts">15 pts</div>
                            <div class="stats-panel-qty" id="statsQty15">0</div>
                        </div>
                        <div class="stats-panel-item pts14">
                            <div class="stats-panel-pts">14 pts</div>
                            <div class="stats-panel-qty" id="statsQty14">0</div>
                        </div>
                        <div class="stats-panel-item pts13">
                            <div class="stats-panel-pts">13 pts</div>
                            <div class="stats-panel-qty" id="statsQty13">0</div>
                        </div>
                        <div class="stats-panel-item pts12">
                            <div class="stats-panel-pts">12 pts</div>
                            <div class="stats-panel-qty" id="statsQty12">0</div>
                        </div>
                        <div class="stats-panel-item pts11">
                            <div class="stats-panel-pts">11 pts</div>
                            <div class="stats-panel-qty" id="statsQty11">0</div>
                        </div>
                        
                        <div class="stats-panel-divider"></div>
                        <div class="stats-panel-subtitle">💰 Financeiro</div>
                        
                        <div class="stats-panel-item gasto">
                            <div class="stats-panel-label2">Total Gasto</div>
                            <div class="stats-panel-money negative" id="statsTotalGasto">R$ 0,00</div>
                        </div>
                        <div class="stats-panel-item premio">
                            <div class="stats-panel-label2">Total Prêmios</div>
                            <div class="stats-panel-money positive" id="statsTotalPremio">R$ 0,00</div>
                        </div>
                        
                        <div class="stats-panel-divider"></div>
                        
                        <div class="stats-panel-item saldo">
                            <div class="stats-panel-label2">SALDO</div>
                            <div class="stats-panel-saldo" id="statsSaldo">R$ 0,00</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ESTATÍSTICAS -->
        <!-- FECHAMENTO COM GARANTIA -->
        <section id="fechamento" class="hidden">
            <!-- FECHAMENTO INTELIGENTE - AUSENTES + SORTEADAS -->
            <div class="card">
                <div class="card-title">🎯 Fechamento Inteligente (Ausentes + Sorteadas)</div>
                <p style="color:#94a3b8;font-size:0.85rem;margin-bottom:1rem;">
                    Combine as 10 dezenas ausentes do último sorteio com algumas das sorteadas para criar fechamentos estratégicos.
                </p>
                
                <!-- Exibir Ausentes e Sorteadas -->
                <div class="grid2" style="margin-bottom:1rem;">
                    <div class="smart-box ausentes-box">
                        <div class="smart-title">❌ 10 Dezenas Ausentes</div>
                        <div class="smart-desc">Não saíram no último sorteio</div>
                        <div class="smart-balls" id="smartAusentes"></div>
                    </div>
                    <div class="smart-box sorteadas-box">
                        <div class="smart-title">✅ 15 Dezenas Sorteadas</div>
                        <div class="smart-desc">Saíram no último sorteio</div>
                        <div class="smart-balls" id="smartSorteadas"></div>
                    </div>
                </div>
                
                <!-- Configuração -->
                <div class="smart-config">
                    <div class="smart-config-title">⚙️ Configurar Fechamento</div>
                    <div class="grid3" style="margin-bottom:1rem;">
                        <div class="fgroup">
                            <label class="flabel">Sorteadas a adicionar</label>
                            <select class="fsel" id="smartSortAdd" onchange="updateSmartFech()">
                                <option value="6">+6 sorteadas (16 total)</option>
                                <option value="7">+7 sorteadas (17 total)</option>
                                <option value="8" selected>+8 sorteadas (18 total)</option>
                                <option value="9">+9 sorteadas (19 total)</option>
                                <option value="10">+10 sorteadas (20 total)</option>
                            </select>
                        </div>
                        <div class="fgroup">
                            <label class="flabel">Estratégia</label>
                            <select class="fsel" id="smartEstrategia" onchange="updateSmartFech()">
                                <option value="economica">💵 Econômica (menos jogos)</option>
                                <option value="equilibrada" selected>⚖️ Equilibrada</option>
                                <option value="agressiva">🎯 Agressiva (maior prêmio)</option>
                            </select>
                        </div>
                        <div class="fgroup">
                            <label class="flabel">Seleção das sorteadas</label>
                            <select class="fsel" id="smartSelecao" onchange="updateSmartFech()">
                                <option value="quentes">🔥 Mais frequentes</option>
                                <option value="aleatorio" selected>🎲 Aleatório</option>
                                <option value="manual">✋ Manual</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Seleção manual das sorteadas -->
                    <div class="smart-manual hidden" id="smartManual">
                        <div class="flabel" style="margin-bottom:0.5rem;">Selecione as sorteadas que deseja usar:</div>
                        <div class="smart-sel-grid" id="smartSelGrid"></div>
                    </div>
                    
                    <!-- Filtro Posicional -->
                    <div class="smart-posicional" style="margin-top:1rem;padding:1rem;background:#0f172a;border-radius:10px;border:1px solid #334155;">
                        <div class="flabel" style="margin-bottom:0.75rem;display:flex;align-items:center;gap:0.5rem;">
                            <input type="checkbox" id="smartUsarPosicional" onchange="toggleSmartPosicional()">
                            <label for="smartUsarPosicional" style="cursor:pointer;">📍 Usar Filtro Posicional</label>
                        </div>
                        <div id="smartPosConfig" class="hidden">
                            <p style="color:#94a3b8;font-size:0.75rem;margin-bottom:0.75rem;">
                                Prioriza dezenas que mais aparecem em cada posição (1ª a 15ª) nos últimos sorteios.
                            </p>
                            <div class="grid3" style="gap:0.75rem;">
                                <div class="fgroup">
                                    <label class="flabel">Base de análise</label>
                                    <select class="fsel" id="smartPosRange" onchange="updateSmartPosPreview()">
                                        <option value="10">Últimos 10</option>
                                        <option value="25" selected>Últimos 25</option>
                                        <option value="50">Últimos 50</option>
                                    </select>
                                </div>
                                <div class="fgroup">
                                    <label class="flabel">Mín. Ausentes Top Posicional</label>
                                    <select class="fsel" id="smartMinPosAus">
                                        <option value="0">0</option>
                                        <option value="1">1</option>
                                        <option value="2" selected>2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                    </select>
                                </div>
                                <div class="fgroup">
                                    <label class="flabel">Mín. Sorteadas Top Posicional</label>
                                    <select class="fsel" id="smartMinPosSort">
                                        <option value="0">0</option>
                                        <option value="1">1</option>
                                        <option value="2" selected>2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                    </select>
                                </div>
                            </div>
                            <div style="margin-top:0.75rem;padding:0.75rem;background:#1e293b;border-radius:8px;">
                                <div style="font-size:0.75rem;color:#94a3b8;margin-bottom:0.5rem;">📊 Top Posicionais (por score):</div>
                                <div style="display:flex;gap:1rem;flex-wrap:wrap;">
                                    <div>
                                        <span style="font-size:0.7rem;color:#ef4444;">Ausentes:</span>
                                        <span id="smartPosAusPreview" style="font-size:0.75rem;color:#f1f5f9;"></span>
                                    </div>
                                    <div>
                                        <span style="font-size:0.7rem;color:#22c55e;">Sorteadas:</span>
                                        <span id="smartPosSortPreview" style="font-size:0.75rem;color:#f1f5f9;"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Info da estratégia -->
                    <div class="smart-info" id="smartInfo"></div>
                    
                    <div class="btns">
                        <button class="btn btn-p" onclick="gerarSmartFechamento()">🎯 Gerar Fechamento Inteligente</button>
                    </div>
                </div>
            </div>
            
            <!-- Estratégias Disponíveis -->
            <div class="card">
                <div class="card-title">📊 Estratégias Disponíveis</div>
                <p style="color:#94a3b8;font-size:0.8rem;margin-bottom:1rem;">
                    Comparativo das estratégias usando 10 ausentes + sorteadas (condição: acertar 15 das dezenas)
                </p>
                <div class="fech-tabela" id="smartTabela"></div>
            </div>
            
            <!-- Resultado do fechamento inteligente -->
            <div class="card hidden" id="smartResultado">
                <div class="card-title">🎯 Jogos Gerados (Fechamento Inteligente)</div>
                <div id="smartResumo"></div>
                <div id="smartJogos"></div>
                <div class="btns">
                    <button class="btn btn-p" onclick="salvarSmartFechamento()">💾 Salvar Todos</button>
                    <button class="btn btn-w" onclick="exportSmartExcel()">📊 Excel</button>
                    <button class="btn btn-a" onclick="exportSmartTxt()">📄 TXT</button>
                </div>
            </div>
            
            <hr style="border:none;border-top:2px dashed #334155;margin:1.5rem 0;">
            
            <!-- FECHAMENTO MANUAL -->
            <div class="card">
                <div class="card-title">💰 Fechamento Manual (Escolha suas dezenas)</div>
                <p style="color:#94a3b8;font-size:0.85rem;margin-bottom:1rem;">
                    Gere jogos otimizados que garantem lucro se você acertar a condição estabelecida.
                </p>
                
                <div class="fech-config">
                    <div class="grid3" style="margin-bottom:1rem;">
                        <div class="fgroup">
                            <label class="flabel">Dezenas a jogar</label>
                            <select class="fsel" id="fechDezenas" onchange="updateFechOptions()">
                                <option value="16">16 dezenas</option>
                                <option value="17">17 dezenas</option>
                                <option value="18" selected>18 dezenas</option>
                                <option value="19">19 dezenas</option>
                                <option value="20">20 dezenas</option>
                                <option value="21">21 dezenas</option>
                                <option value="22">22 dezenas</option>
                                <option value="23">23 dezenas</option>
                                <option value="24">24 dezenas</option>
                                <option value="25">25 dezenas</option>
                            </select>
                        </div>
                        <div class="fgroup">
                            <label class="flabel">Se acertar</label>
                            <select class="fsel" id="fechCondicao" onchange="updateFechGarantias()">
                                <option value="15">15 das dezenas</option>
                                <option value="14">14 das dezenas</option>
                                <option value="13">13 das dezenas</option>
                            </select>
                        </div>
                        <div class="fgroup">
                            <label class="flabel">Garantia mínima</label>
                            <select class="fsel" id="fechGarantia">
                                <option value="14">14 pontos</option>
                                <option value="13">13 pontos</option>
                                <option value="12">12 pontos</option>
                                <option value="11">11 pontos</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Info do fechamento selecionado -->
                    <div class="fech-info" id="fechInfo"></div>
                    
                    <!-- Seleção de dezenas -->
                    <div class="fech-selecao hidden" id="fechSelecao">
                        <div class="card-title" style="font-size:0.9rem;">Selecione suas dezenas</div>
                        <div class="cnt" style="margin-bottom:0.75rem;">
                            Selecionadas: <span class="cnt-v" id="fechCnt">0</span> / <span id="fechReq">18</span>
                        </div>
                        <div class="numgrid" id="fechGrid"></div>
                        <div class="btns" style="margin-top:1rem;">
                            <button class="btn btn-s" onclick="clearFech()">Limpar</button>
                            <button class="btn btn-s" onclick="randomFech()">🎲 Aleatório</button>
                            <button class="btn btn-p" onclick="gerarFechamento()">💰 Gerar Fechamento</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tabela de fechamentos disponíveis -->
            <div class="card">
                <div class="card-title">📋 Tabela de Fechamentos Disponíveis</div>
                <p style="color:#94a3b8;font-size:0.8rem;margin-bottom:1rem;">
                    Fechamentos que garantem lucro (prêmio > custo dos jogos)
                </p>
                <div class="fech-tabela" id="fechTabela"></div>
            </div>
            
            <!-- Resultado do fechamento -->
            <div class="card hidden" id="fechResultado">
                <div class="card-title">🎯 Jogos Gerados</div>
                <div id="fechResumo"></div>
                <div id="fechJogos"></div>
                <div class="btns">
                    <button class="btn btn-p" onclick="salvarFechamento()">💾 Salvar Todos</button>
                    <button class="btn btn-w" onclick="exportFechExcel()">📊 Excel</button>
                    <button class="btn btn-a" onclick="exportFechTxt()">📄 TXT</button>
                </div>
            </div>
        </section>

        <section id="stats" class="hidden">
            <div class="card">
                <div class="card-title">📊 Análise (10 últimos sorteios)</div>
                <div class="grid4" style="margin-bottom:1rem;">
                    <div class="stat"><div class="stat-v" id="avgPar">-</div><div class="stat-l">Média Pares</div></div>
                    <div class="stat"><div class="stat-v" id="avgPri">-</div><div class="stat-l">Média Primos</div></div>
                    <div class="stat"><div class="stat-v" id="avgSoma">-</div><div class="stat-l">Média Soma</div></div>
                    <div class="stat"><div class="stat-v" id="avgMold">-</div><div class="stat-l">Média Moldura</div></div>
                </div>
                <div class="card-title">Frequência</div>
                <div class="agrid" id="freqGrid"></div>
            </div>
            
            <!-- GRÁFICO DE EVOLUÇÃO DO CSN -->
            <div class="card">
                <div class="card-title">📈 Evolução do CSN (Últimos Sorteios)</div>
                <p style="color:#94a3b8;font-size:0.8rem;margin-bottom:1rem;">
                    Acompanhe a variação do índice CSN (Combinatorial Sequence Number) ao longo dos sorteios. O CSN varia de 1 a 3.268.760.
                </p>
                <div class="grafico-controls">
                    <div class="fgroup">
                        <label class="flabel">Quantidade de Sorteios</label>
                        <select class="fsel" id="graficoQtd" onchange="atualizarGraficoCSN()">
                            <option value="5">Últimos 5</option>
                            <option value="10" selected>Últimos 10</option>
                            <option value="25">Últimos 25</option>
                            <option value="50">Últimos 50</option>
                        </select>
                    </div>
                </div>
                <div class="grafico-container">
                    <canvas id="graficoLinha"></canvas>
                </div>
                <div class="grafico-stats" id="graficoStats"></div>
            </div>
            
            <!-- ESTATÍSTICA POSICIONAL -->
            <div class="card">
                <div class="card-title">📍 Estatística Posicional (25 últimos sorteios)</div>
                <p style="color:#94a3b8;font-size:0.8rem;margin-bottom:1rem;">Mostra os números que mais aparecem em cada posição (1ª a 15ª bola sorteada em ordem crescente)</p>
                <div class="pos-tabs" id="posTabs"></div>
                <div class="pos-chart-container">
                    <div class="pos-chart" id="posChart"></div>
                </div>
                <div class="pos-summary" id="posSummary"></div>
            </div>
            
            <!-- NÚMEROS AUSENTES E CICLO DE FECHAMENTO -->
            <div class="grid2">
                <div class="card">
                    <div class="card-title">🚫 Números Ausentes (10 últimos sorteios)</div>
                    <p style="color:#94a3b8;font-size:0.8rem;margin-bottom:1rem;">Números que NÃO saíram nos últimos 10 sorteios</p>
                    <div id="ausentesGrid" class="ausentes-grid"></div>
                    <div id="ausentesInfo" style="margin-top:1rem;"></div>
                </div>
                <div class="card">
                    <div class="card-title">🔄 Atraso das Dezenas</div>
                    <p style="color:#94a3b8;font-size:0.8rem;margin-bottom:1rem;">Quantos sorteios desde a última aparição</p>
                    <div id="cicloInfo" style="margin-bottom:1rem;"></div>
                    <div id="cicloGrid" class="ciclo-grid"></div>
                </div>
            </div>
            
            <!-- TABELA DE CICLOS ESTILO MAZUSOFT -->
            <div class="card">
                <div class="card-title">🔄 Tabela de Ciclos de Fechamento</div>
                <p style="color:#94a3b8;font-size:0.8rem;margin-bottom:1rem;">
                    Visualização dos ciclos: quando todos os 25 números saem pelo menos uma vez, o ciclo fecha.<br>
                    <span style="color:#10b981;">●</span> Saiu no concurso | 
                    <span style="color:#1e293b;border:1px solid #334155;padding:0 4px;border-radius:2px;">○</span> Não saiu |
                    <span style="color:#f59e0b;">▼</span> Ciclo fechou
                </p>
                <div id="cicloStatus" style="margin-bottom:1rem;"></div>
                <div class="ciclo-table-wrapper">
                    <table class="ciclo-table" id="cicloTable">
                        <thead id="cicloTableHead"></thead>
                        <tbody id="cicloTableBody"></tbody>
                    </table>
                </div>
                <div id="cicloLegend" style="margin-top:1rem;"></div>
            </div>
            
            <div class="grid2">
                <div class="card"><div class="card-title">🔥 Quentes</div><div id="hotList"></div></div>
                <div class="card"><div class="card-title">❄️ Frias</div><div id="coldList"></div></div>
            </div>
            
            <div class="card">
                <div class="card-title">📈 Histórico</div>
                <div id="histList"></div>
            </div>
        </section>
        
        <!-- PROBABILIDADES / ESTUDO DE COMBINAÇÕES -->
        <section id="probabilidades" class="hidden">
            <div class="card">
                <div class="card-title">🎲 Estudo de Combinações - Calculadora de Probabilidades</div>
                <p style="color:#94a3b8;font-size:0.85rem;margin-bottom:1rem;">
                    Calcule a probabilidade de acertar uma quantidade específica de números usando a <strong style="color:#8b5cf6;">Distribuição Hipergeométrica</strong>.
                </p>
                
                <!-- Configuração -->
                <div class="prob-config">
                    <div class="prob-config-title">⚙️ Configuração de Dados</div>
                    
                    <!-- Modo Avançado Toggle -->
                    <div class="prob-advanced-toggle">
                        <input type="checkbox" id="probModoAvancado" onchange="toggleProbAvancado()">
                        <label for="probModoAvancado">Modo Avançado (editar Universo e Sorteados)</label>
                    </div>
                    
                    <div class="prob-field disabled" id="probFieldUniverso">
                        <div class="prob-field-label">
                            <span><span class="var">[u]</span> Universo</span>
                            <small>Quantidade de números disponíveis na Lotofácil</small>
                        </div>
                        <input type="number" id="probUniverso" value="25" min="1" max="200" disabled onchange="calcularProbabilidade()">
                    </div>
                    
                    <div class="prob-field disabled" id="probFieldSorteados">
                        <div class="prob-field-label">
                            <span><span class="var">[s]</span> Sorteados</span>
                            <small>Quantidade de números sorteados na Lotofácil</small>
                        </div>
                        <input type="number" id="probSorteados" value="15" min="1" max="100" disabled onchange="calcularProbabilidade()">
                    </div>
                    
                    <div class="prob-field">
                        <div class="prob-field-label">
                            <span><span class="var">[k]</span> Aposta</span>
                            <small>Quantidade de números da aposta analisada</small>
                        </div>
                        <input type="number" id="probAposta" value="15" min="15" max="20" onchange="calcularProbabilidade()">
                    </div>
                    
                    <div class="prob-field">
                        <div class="prob-field-label">
                            <span><span class="var">[t]</span> Acertos</span>
                            <small>Quantidade de números certos para cálculo</small>
                        </div>
                        <input type="number" id="probAcertos" value="15" min="11" max="15" onchange="calcularProbabilidade()">
                    </div>
                    
                    <button class="btn btn-p" onclick="calcularProbabilidade()" style="width:100%;margin-top:1rem;">🎯 Calcular Probabilidade</button>
                </div>
                
                <!-- Resultado Principal -->
                <div class="prob-resultado" id="probResultado">
                    <div class="prob-resultado-title">Probabilidade da aposta com <strong id="probResK">15</strong> números acertar <strong id="probResT">15</strong> pontos</div>
                    <div class="prob-resultado-main">
                        <div class="prob-resultado-percent" id="probResPercent">0,0000032%</div>
                        <div class="prob-resultado-chance">Uma chance em <strong id="probResChance">3.268.760</strong></div>
                    </div>
                </div>
                
                <!-- Fórmula Matemática -->
                <div class="prob-formula">
                    <div class="prob-formula-title">📐 Distribuição Hipergeométrica</div>
                    <div class="prob-formula-math" id="probFormula">
                        <span class="prob-formula-var">P<sub>k,t</sub></span>
                        <span class="prob-formula-eq">=</span>
                        <div class="prob-frac">
                            <div class="prob-frac-num" id="probFormulaNum">
                                <span class="prob-comb">
                                    <span class="prob-comb-paren">(</span>
                                    <span class="prob-comb-inner">
                                        <span class="prob-comb-top" id="formulaK">15</span>
                                        <span class="prob-comb-bot" id="formulaT">15</span>
                                    </span>
                                    <span class="prob-comb-paren">)</span>
                                </span>
                                <span class="prob-times">×</span>
                                <span class="prob-comb">
                                    <span class="prob-comb-paren">(</span>
                                    <span class="prob-comb-inner">
                                        <span class="prob-comb-top" id="formulaUK">10</span>
                                        <span class="prob-comb-bot" id="formulaST">0</span>
                                    </span>
                                    <span class="prob-comb-paren">)</span>
                                </span>
                            </div>
                            <div class="prob-frac-den">
                                <span class="prob-comb">
                                    <span class="prob-comb-paren">(</span>
                                    <span class="prob-comb-inner">
                                        <span class="prob-comb-top" id="formulaU">25</span>
                                        <span class="prob-comb-bot" id="formulaS">15</span>
                                    </span>
                                    <span class="prob-comb-paren">)</span>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top:1rem;font-size:0.75rem;color:#64748b;">
                        <span id="probFormulaCalc"></span>
                    </div>
                </div>
            </div>
            
            <!-- Tabela de Probabilidades -->
            <div class="card">
                <div class="card-title">📊 Tabela Completa de Probabilidades</div>
                <p style="color:#94a3b8;font-size:0.8rem;margin-bottom:1rem;">
                    Probabilidades para cada faixa de acertos (11 a 15 pontos) com a aposta selecionada.
                </p>
                <div class="prob-tabela">
                    <table id="probTabelaAcertos">
                        <thead>
                            <tr>
                                <th>Acertos</th>
                                <th>Probabilidade</th>
                                <th>Chance (1 em X)</th>
                                <th>Prêmio Médio</th>
                            </tr>
                        </thead>
                        <tbody id="probTabelaAcertosBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Comparativo de Apostas -->
            <div class="card">
                <div class="card-title">📈 Comparativo entre Apostas (15 a 20 números)</div>
                <p style="color:#94a3b8;font-size:0.8rem;margin-bottom:1rem;">
                    Compare custo, probabilidades e retorno esperado para diferentes tamanhos de aposta.
                </p>
                <div class="prob-tabela prob-comparativo">
                    <table id="probTabelaComparativo">
                        <thead>
                            <tr>
                                <th>Aposta</th>
                                <th>Jogos</th>
                                <th>Custo</th>
                                <th>Prob. 15 pts</th>
                                <th>Prob. 14 pts</th>
                                <th>Prob. 13 pts</th>
                                <th>Prob. 11+ pts</th>
                            </tr>
                        </thead>
                        <tbody id="probTabelaComparativoBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Custo x Probabilidade x Retorno -->
            <div class="card">
                <div class="card-title">💰 Análise Custo x Probabilidade x Retorno</div>
                <div class="prob-info-grid" id="probAnaliseRetorno">
                </div>
            </div>
            
            <!-- Gráfico -->
            <div class="card">
                <div class="card-title">📉 Gráfico de Probabilidades por Acertos</div>
                <div class="prob-grafico">
                    <canvas id="probGrafico"></canvas>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal -->
    <div class="modal" id="batchModal">
        <div class="mbox">
            <div class="mhead">
                <div style="font-weight:600;">📊 Conferência em Lote</div>
                <button class="mclose" onclick="closeBatch()">×</button>
            </div>
            <div class="fgroup"><label class="flabel">Concursos</label><select class="fsel" id="batchQtd"><option value="5">5</option><option value="10" selected>10</option><option value="20">20</option></select></div>
            <button class="btn btn-p" onclick="execBatch()" style="width:100%;">🔍 Conferir</button>
            <div id="batchRes" style="margin-top:1rem;"></div>
        </div>
    </div>
    <div class="toast" id="toast"></div>

<script>
var PRIMOS = [2,3,5,7,11,13,17,19,23];
var MOLDURA = [1,2,3,4,5,6,10,11,15,16,20,21,22,23,24,25];
var MIOLO = [7,8,9,12,13,14,17,18,19];
var FIBONACCI = [1,2,3,5,8,13,21];
var MULT3 = [3,6,9,12,15,18,21,24];
var posStats = null;
var currentPos = 1;

var DATA = {
    last: null,
    all: [],
    l10: [],
    sel: [],
    fix: [],
    exc: [],
    mode: 'normal',
    dsel: [],
    curDesd: null,
    gen: [],
    genPos: [],
    dgen: [],
    saved: JSON.parse(localStorage.getItem('lf_v3') || '[]'),
    // Controle de cache e status
    source: 'loading', // 'api', 'cache', 'example'
    lastUpdateTime: null,
    cacheKey: 'lf_v3_cache',
    cacheTimeKey: 'lf_v3_cache_time'
};

// Fechamentos com Garantia de Lucro
// Estrutura: dezenas, condicao (acertar X das dezenas), garantia (pontos), jogos, acuracia
var FECHAMENTOS = [
    // 16 dezenas
    {dez: 16, cond: 13, gar: 11, jogos: 4, acc: 100},
    {dez: 16, cond: 14, gar: 12, jogos: 6, acc: 100},
    {dez: 16, cond: 15, gar: 13, jogos: 8, acc: 100},
    {dez: 16, cond: 15, gar: 14, jogos: 16, acc: 100},
    
    // 17 dezenas
    {dez: 17, cond: 13, gar: 11, jogos: 5, acc: 100},
    {dez: 17, cond: 14, gar: 12, jogos: 8, acc: 100},
    {dez: 17, cond: 14, gar: 13, jogos: 12, acc: 100},
    {dez: 17, cond: 15, gar: 13, jogos: 10, acc: 100},
    {dez: 17, cond: 15, gar: 14, jogos: 20, acc: 100},
    
    // 18 dezenas
    {dez: 18, cond: 13, gar: 11, jogos: 4, acc: 100},
    {dez: 18, cond: 14, gar: 12, jogos: 6, acc: 100},
    {dez: 18, cond: 14, gar: 13, jogos: 12, acc: 100},
    {dez: 18, cond: 15, gar: 12, jogos: 6, acc: 100},
    {dez: 18, cond: 15, gar: 13, jogos: 10, acc: 100},
    {dez: 18, cond: 15, gar: 14, jogos: 24, acc: 100},
    
    // 19 dezenas
    {dez: 19, cond: 13, gar: 11, jogos: 5, acc: 100},
    {dez: 19, cond: 14, gar: 12, jogos: 8, acc: 100},
    {dez: 19, cond: 14, gar: 13, jogos: 15, acc: 100},
    {dez: 19, cond: 15, gar: 12, jogos: 4, acc: 100},
    {dez: 19, cond: 15, gar: 13, jogos: 10, acc: 100},
    {dez: 19, cond: 15, gar: 14, jogos: 38, acc: 100},
    
    // 20 dezenas
    {dez: 20, cond: 13, gar: 11, jogos: 6, acc: 100},
    {dez: 20, cond: 14, gar: 11, jogos: 4, acc: 100},
    {dez: 20, cond: 14, gar: 12, jogos: 10, acc: 100},
    {dez: 20, cond: 14, gar: 13, jogos: 20, acc: 100},
    {dez: 20, cond: 15, gar: 11, jogos: 3, acc: 100},
    {dez: 20, cond: 15, gar: 12, jogos: 4, acc: 100},
    {dez: 20, cond: 15, gar: 13, jogos: 15, acc: 100},
    {dez: 20, cond: 15, gar: 14, jogos: 8, acc: 100},
    
    // 21 dezenas
    {dez: 21, cond: 14, gar: 11, jogos: 6, acc: 100},
    {dez: 21, cond: 14, gar: 12, jogos: 12, acc: 100},
    {dez: 21, cond: 15, gar: 11, jogos: 4, acc: 100},
    {dez: 21, cond: 15, gar: 12, jogos: 6, acc: 100},
    {dez: 21, cond: 15, gar: 13, jogos: 20, acc: 100},
    {dez: 21, cond: 15, gar: 14, jogos: 56, acc: 100},
    
    // 22 dezenas
    {dez: 22, cond: 14, gar: 11, jogos: 8, acc: 100},
    {dez: 22, cond: 14, gar: 12, jogos: 18, acc: 100},
    {dez: 22, cond: 15, gar: 11, jogos: 6, acc: 100},
    {dez: 22, cond: 15, gar: 12, jogos: 10, acc: 100},
    {dez: 22, cond: 15, gar: 13, jogos: 28, acc: 100},
    {dez: 22, cond: 15, gar: 14, jogos: 77, acc: 100},
    
    // 23 dezenas
    {dez: 23, cond: 14, gar: 11, jogos: 10, acc: 100},
    {dez: 23, cond: 15, gar: 11, jogos: 10, acc: 100},
    {dez: 23, cond: 15, gar: 12, jogos: 15, acc: 100},
    {dez: 23, cond: 15, gar: 13, jogos: 40, acc: 100},
    {dez: 23, cond: 15, gar: 14, jogos: 100, acc: 100},
    
    // 24 dezenas
    {dez: 24, cond: 14, gar: 11, jogos: 14, acc: 100},
    {dez: 24, cond: 15, gar: 11, jogos: 14, acc: 100},
    {dez: 24, cond: 15, gar: 12, jogos: 22, acc: 100},
    {dez: 24, cond: 15, gar: 13, jogos: 55, acc: 100},
    {dez: 24, cond: 15, gar: 14, jogos: 130, acc: 100},
    
    // 25 dezenas
    {dez: 25, cond: 15, gar: 11, jogos: 20, acc: 100},
    {dez: 25, cond: 15, gar: 12, jogos: 32, acc: 100},
    {dez: 25, cond: 15, gar: 13, jogos: 75, acc: 100},
    {dez: 25, cond: 15, gar: 14, jogos: 165, acc: 100}
];

// Prêmios por faixa (valores atualizados 2025)
// 11, 12, 13 pts = valores fixos | 14, 15 pts = variável (média)
var PREMIOS_MEDIOS = {
    15: 1500000,  // Variável - média aproximada
    14: 1500,     // Variável - média aproximada
    13: 35,       // Fixo
    12: 14,       // Fixo
    11: 7         // Fixo
};

// Valor da aposta simples (atualizado julho/2025)
var VALOR_JOGO = 3.50;

var DESD = [
    // 16 dezenas
    {id:1, n:"16-15-11-11", d:16, g:"11pts c/11 acertos", j:3, ac:100},
    {id:2, n:"16-15-11-12", d:16, g:"11pts c/12 acertos", j:2, ac:100},
    {id:3, n:"16-15-12-13", d:16, g:"12pts c/13 acertos", j:5, ac:100},
    
    // 17 dezenas
    {id:4, n:"17-15-11-11", d:17, g:"11pts c/11 acertos", j:7, ac:100},
    {id:5, n:"17-15-11-12", d:17, g:"11pts c/12 acertos", j:5, ac:100},
    {id:6, n:"17-15-11-13", d:17, g:"11pts c/13 acertos", j:3, ac:100},
    {id:7, n:"17-15-12-13", d:17, g:"12pts c/13 acertos", j:8, ac:100},
    {id:8, n:"17-15-12-14", d:17, g:"12pts c/14 acertos", j:4, ac:100},
    
    // 18 dezenas
    {id:9, n:"18-15-11-12", d:18, g:"11pts c/12 acertos", j:10, ac:100},
    {id:10, n:"18-15-11-13", d:18, g:"11pts c/13 acertos", j:4, ac:100},
    {id:11, n:"18-15-12-13", d:18, g:"12pts c/13 acertos", j:13, ac:100},
    {id:12, n:"18-15-12-14", d:18, g:"12pts c/14 acertos", j:6, ac:100},
    {id:13, n:"18-15-13-14", d:18, g:"13pts c/14 acertos", j:12, ac:100},
    {id:14, n:"18-15-13-15", d:18, g:"13pts c/15 acertos", j:6, ac:100},
    {id:15, n:"18-15-14-15", d:18, g:"14pts c/15 acertos", j:24, ac:100},
    
    // 19 dezenas
    {id:16, n:"19-15-11-12", d:19, g:"11pts c/12 acertos", j:19, ac:100},
    {id:17, n:"19-15-11-13", d:19, g:"11pts c/13 acertos", j:6, ac:100},
    {id:18, n:"19-15-11-14", d:19, g:"11pts c/14 acertos", j:3, ac:100},
    {id:19, n:"19-15-12-13", d:19, g:"12pts c/13 acertos", j:18, ac:100},
    {id:20, n:"19-15-12-14", d:19, g:"12pts c/14 acertos", j:10, ac:100},
    {id:21, n:"19-15-12-15", d:19, g:"12pts c/15 acertos", j:4, ac:100},
    {id:22, n:"19-15-13-15", d:19, g:"13pts c/15 acertos", j:10, ac:100},
    {id:23, n:"19-15-14-15", d:19, g:"14pts c/15 acertos", j:38, ac:100},
    
    // 20 dezenas
    {id:24, n:"20-15-11-12", d:20, g:"11pts c/12 acertos", j:35, ac:100},
    {id:25, n:"20-15-11-13", d:20, g:"11pts c/13 acertos", j:10, ac:100},
    {id:26, n:"20-15-11-14", d:20, g:"11pts c/14 acertos", j:4, ac:100},
    {id:27, n:"20-15-11-15", d:20, g:"11pts c/15 acertos", j:3, ac:100},
    {id:28, n:"20-15-12-13", d:20, g:"12pts c/13 acertos", j:25, ac:100},
    {id:29, n:"20-15-12-14", d:20, g:"12pts c/14 acertos", j:15, ac:100},
    {id:30, n:"20-15-12-15", d:20, g:"12pts c/15 acertos", j:4, ac:100},
    {id:31, n:"20-15-13-14", d:20, g:"13pts c/14 acertos", j:30, ac:100},
    {id:32, n:"20-15-13-15", d:20, g:"13pts c/15 acertos", j:15, ac:100},
    {id:33, n:"20-15-14-15", d:20, g:"14pts c/15 acertos", j:8, ac:100},
    
    // 21 dezenas
    {id:34, n:"21-15-11-13", d:21, g:"11pts c/13 acertos", j:18, ac:100},
    {id:35, n:"21-15-11-14", d:21, g:"11pts c/14 acertos", j:8, ac:100},
    {id:36, n:"21-15-11-15", d:21, g:"11pts c/15 acertos", j:4, ac:100},
    {id:37, n:"21-15-12-14", d:21, g:"12pts c/14 acertos", j:20, ac:100},
    {id:38, n:"21-15-12-15", d:21, g:"12pts c/15 acertos", j:6, ac:100},
    {id:39, n:"21-15-13-15", d:21, g:"13pts c/15 acertos", j:20, ac:100},
    {id:40, n:"21-15-14-15", d:21, g:"14pts c/15 acertos", j:56, ac:100},
    
    // 22 dezenas
    {id:41, n:"22-15-11-13", d:22, g:"11pts c/13 acertos", j:30, ac:100},
    {id:42, n:"22-15-11-14", d:22, g:"11pts c/14 acertos", j:15, ac:100},
    {id:43, n:"22-15-11-15", d:22, g:"11pts c/15 acertos", j:6, ac:100},
    {id:44, n:"22-15-12-14", d:22, g:"12pts c/14 acertos", j:30, ac:100},
    {id:45, n:"22-15-12-15", d:22, g:"12pts c/15 acertos", j:10, ac:100},
    {id:46, n:"22-15-13-15", d:22, g:"13pts c/15 acertos", j:28, ac:100},
    {id:47, n:"22-15-14-15", d:22, g:"14pts c/15 acertos", j:77, ac:100},
    
    // 23 dezenas
    {id:48, n:"23-15-11-14", d:23, g:"11pts c/14 acertos", j:22, ac:100},
    {id:49, n:"23-15-11-15", d:23, g:"11pts c/15 acertos", j:10, ac:100},
    {id:50, n:"23-15-12-15", d:23, g:"12pts c/15 acertos", j:15, ac:100},
    {id:51, n:"23-15-13-15", d:23, g:"13pts c/15 acertos", j:40, ac:100},
    {id:52, n:"23-15-14-15", d:23, g:"14pts c/15 acertos", j:100, ac:100},
    
    // 24 dezenas
    {id:53, n:"24-15-11-14", d:24, g:"11pts c/14 acertos", j:35, ac:100},
    {id:54, n:"24-15-11-15", d:24, g:"11pts c/15 acertos", j:14, ac:100},
    {id:55, n:"24-15-12-15", d:24, g:"12pts c/15 acertos", j:22, ac:100},
    {id:56, n:"24-15-13-15", d:24, g:"13pts c/15 acertos", j:55, ac:100},
    {id:57, n:"24-15-14-15", d:24, g:"14pts c/15 acertos", j:130, ac:100},
    
    // 25 dezenas (todas)
    {id:58, n:"25-15-11-15", d:25, g:"11pts c/15 acertos", j:20, ac:100},
    {id:59, n:"25-15-12-15", d:25, g:"12pts c/15 acertos", j:32, ac:100},
    {id:60, n:"25-15-13-15", d:25, g:"13pts c/15 acertos", j:75, ac:100},
    {id:61, n:"25-15-14-15", d:25, g:"14pts c/15 acertos", j:165, ac:100}
];

document.addEventListener('DOMContentLoaded', function() {
    setupNav();
    setupModeTabs();
    initNumGrid();
    initDesd();
    initFechamento();
    initSmartFechamento();
    initMesclagem();
    initProbabilidades();
    loadData();
    updateSavedUI();
});

function setupNav() {
    document.querySelectorAll('#nav button').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var sec = this.getAttribute('data-sec');
            document.querySelectorAll('#nav button').forEach(function(b) { b.classList.remove('active'); });
            this.classList.add('active');
            document.querySelectorAll('main section').forEach(function(s) { s.classList.add('hidden'); });
            document.getElementById(sec).classList.remove('hidden');
        });
    });
}

function setupModeTabs() {
    document.querySelectorAll('#modeTabs .tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
            DATA.mode = this.getAttribute('data-mode');
            document.querySelectorAll('#modeTabs .tab').forEach(function(t) { t.classList.remove('active'); });
            this.classList.add('active');
        });
    });
}

function initNumGrid() {
    var grid = document.getElementById('numGrid');
    grid.innerHTML = '';
    for (var i = 1; i <= 25; i++) {
        var btn = document.createElement('button');
        btn.className = 'numbtn';
        if (MOLDURA.indexOf(i) > -1) btn.className += ' mold';
        btn.textContent = i < 10 ? '0' + i : i;
        btn.setAttribute('data-n', i);
        btn.addEventListener('click', function() { toggleNum(parseInt(this.getAttribute('data-n'))); });
        grid.appendChild(btn);
    }
}

function toggleNum(n) {
    if (DATA.mode === 'fix') {
        DATA.sel = DATA.sel.filter(function(x) { return x !== n; });
        DATA.exc = DATA.exc.filter(function(x) { return x !== n; });
        var idx = DATA.fix.indexOf(n);
        if (idx > -1) DATA.fix.splice(idx, 1);
        else if (DATA.fix.length < 14) DATA.fix.push(n);
    } else if (DATA.mode === 'exc') {
        DATA.sel = DATA.sel.filter(function(x) { return x !== n; });
        DATA.fix = DATA.fix.filter(function(x) { return x !== n; });
        var idx = DATA.exc.indexOf(n);
        if (idx > -1) DATA.exc.splice(idx, 1);
        else if (DATA.exc.length < 10) DATA.exc.push(n);
    } else {
        DATA.fix = DATA.fix.filter(function(x) { return x !== n; });
        DATA.exc = DATA.exc.filter(function(x) { return x !== n; });
        var idx = DATA.sel.indexOf(n);
        if (idx > -1) DATA.sel.splice(idx, 1);
        else if (DATA.sel.length < 20) DATA.sel.push(n);
    }
    updateSelUI();
}

function updateSelUI() {
    document.querySelectorAll('#numGrid .numbtn').forEach(function(btn) {
        var n = parseInt(btn.getAttribute('data-n'));
        btn.classList.remove('sel', 'fix', 'exc');
        if (MOLDURA.indexOf(n) > -1) btn.classList.add('mold');
        if (DATA.fix.indexOf(n) > -1) btn.classList.add('fix');
        else if (DATA.exc.indexOf(n) > -1) btn.classList.add('exc');
        else if (DATA.sel.indexOf(n) > -1) btn.classList.add('sel');
    });
    document.getElementById('cntSel').textContent = DATA.sel.length;
    document.getElementById('cntFix').textContent = DATA.fix.length;
    document.getElementById('cntExc').textContent = DATA.exc.length;
}

function clearSel() { DATA.sel = []; DATA.fix = []; DATA.exc = []; updateSelUI(); }

function randSel() {
    DATA.sel = [];
    var av = [];
    for (var i = 1; i <= 25; i++) {
        if (DATA.fix.indexOf(i) === -1 && DATA.exc.indexOf(i) === -1) av.push(i);
    }
    var need = 15 - DATA.fix.length;
    while (DATA.sel.length < need && av.length > 0) {
        var idx = Math.floor(Math.random() * av.length);
        DATA.sel.push(av.splice(idx, 1)[0]);
    }
    updateSelUI();
}

function loadData() {
    updateStatus('loading', 'Carregando...');
    
    // Tentar carregar do cache primeiro (se não expirado)
    var cached = loadFromCache();
    if (cached && !isCacheExpired()) {
        applyData(cached, 'cache');
        // Buscar atualização em background
        fetchFromAPI(true);
    } else {
        fetchFromAPI(false);
    }
}

function fetchFromAPI(background) {
    if (!background) {
        updateStatus('loading', 'Conectando API...');
    }
    
    var btnRefresh = document.querySelector('.btn-refresh');
    if (btnRefresh) btnRefresh.classList.add('loading');
    
    // API principal
    var apiPrimaria = 'https://loteriascaixa-api.herokuapp.com/api/lotofacil/latest';
    // API alternativa
    var apiAlternativa = 'https://servicebus2.caixa.gov.br/portaldeloterias/api/lotofacil/';
    
    fetch(apiPrimaria, { timeout: 10000 })
        .then(function(r) { 
            if (!r.ok) throw new Error('API Error');
            return r.json(); 
        })
        .then(function(d) {
            DATA.last = { 
                c: d.concurso, 
                dt: d.data, 
                n: d.dezenas.map(function(x) { return parseInt(x); }).sort(function(a,b) { return a-b; }),
                premio: d.valorEstimadoProximoConcurso ? formatCurrency(d.valorEstimadoProximoConcurso) : null,
                acumulado: d.acumulou || false,
                rateio: parseRateio(d)
            };
            loadHist();
        })
        .catch(function() {
            // Tentar API alternativa
            tryAlternativeAPI(apiAlternativa, background);
        });
}

function tryAlternativeAPI(url, background) {
    if (!background) {
        updateStatus('loading', 'Tentando API alternativa...');
    }
    
    fetch(url)
        .then(function(r) { 
            if (!r.ok) throw new Error('API Alt Error');
            return r.json(); 
        })
        .then(function(d) {
            DATA.last = { 
                c: d.numero || d.concurso, 
                dt: d.dataApuracao || d.data, 
                n: (d.listaDezenas || d.dezenas).map(function(x) { return parseInt(x); }).sort(function(a,b) { return a-b; })
            };
            loadHist();
        })
        .catch(function() {
            // Verificar se tem cache
            var cached = loadFromCache();
            if (cached) {
                applyData(cached, 'cache');
                toast('Usando dados em cache (API indisponível)', true);
            } else {
                loadExample();
            }
            
            var btnRefresh = document.querySelector('.btn-refresh');
            if (btnRefresh) btnRefresh.classList.remove('loading');
        });
}

function loadHist() {
    updateStatus('loading', 'Carregando histórico...');
    
    var promises = [];
    for (var i = 0; i < 50; i++) {
        (function(idx) {
            promises.push(
                fetch('https://loteriascaixa-api.herokuapp.com/api/lotofacil/' + (DATA.last.c - idx))
                    .then(function(r) { return r.ok ? r.json() : null; })
                    .catch(function() { return null; })
            );
        })(i);
    }
    Promise.all(promises).then(function(results) {
        DATA.all = results.filter(function(r) { return r !== null; }).map(function(d) {
            return { 
                c: d.concurso, 
                dt: d.data, 
                n: d.dezenas.map(function(x) { return parseInt(x); }).sort(function(a,b) { return a-b; }) 
            };
        });
        DATA.l10 = DATA.all.slice(0, 10);
        
        // Salvar no cache
        saveToCache();
        
        // Aplicar dados
        applyData(null, 'api');
        
        var btnRefresh = document.querySelector('.btn-refresh');
        if (btnRefresh) btnRefresh.classList.remove('loading');
    });
}

function applyData(cached, source) {
    if (cached) {
        DATA.last = cached.last;
        DATA.all = cached.all;
        DATA.l10 = cached.l10;
    }
    
    DATA.source = source;
    DATA.lastUpdateTime = new Date();
    
    showLast();
    updateStats();
    updatePosStats();
    updateAusentesECiclo();
    fillConfSel();
    updateSavedUI();
    initMesclagem();
    updateStatusFromSource(source);
    
    // Atualizar fechamento inteligente
    if (typeof updateSmartDisplay === 'function') {
        updateSmartDisplay();
        renderSmartTabela();
        updateSmartFech();
    }
}

function loadExample() {
    DATA.last = { c: 3542, dt: "19/11/2025", n: [1,3,4,5,7,8,10,11,13,15,18,19,21,23,25] };
    DATA.l10 = [
        {c:3542,dt:"19/11/2025",n:[1,3,4,5,7,8,10,11,13,15,18,19,21,23,25]},
        {c:3541,dt:"18/11/2025",n:[2,4,5,6,8,9,11,12,14,16,18,20,22,24,25]},
        {c:3540,dt:"16/11/2025",n:[1,2,3,6,7,9,10,12,14,17,19,21,22,23,24]},
        {c:3539,dt:"15/11/2025",n:[3,4,5,7,8,10,11,13,15,17,18,20,21,23,25]},
        {c:3538,dt:"14/11/2025",n:[1,2,4,6,8,9,11,13,14,16,18,19,21,24,25]},
        {c:3537,dt:"13/11/2025",n:[2,3,5,6,7,9,10,12,15,17,19,20,22,23,24]},
        {c:3536,dt:"12/11/2025",n:[1,4,5,7,8,10,11,13,14,16,18,20,21,23,25]},
        {c:3535,dt:"11/11/2025",n:[2,3,4,6,8,9,11,12,15,17,19,21,22,24,25]},
        {c:3534,dt:"09/11/2025",n:[1,3,5,6,7,9,10,13,14,16,18,20,22,23,24]},
        {c:3533,dt:"08/11/2025",n:[2,4,5,7,8,10,11,12,15,17,19,21,23,24,25]}
    ];
    DATA.all = DATA.l10;
    
    applyData(null, 'example');
}

// Funções de Cache
function saveToCache() {
    try {
        var cacheData = {
            last: DATA.last,
            all: DATA.all,
            l10: DATA.l10
        };
        localStorage.setItem(DATA.cacheKey, JSON.stringify(cacheData));
        localStorage.setItem(DATA.cacheTimeKey, new Date().toISOString());
    } catch (e) {
        console.warn('Erro ao salvar cache:', e);
    }
}

function loadFromCache() {
    try {
        var cached = localStorage.getItem(DATA.cacheKey);
        if (cached) {
            return JSON.parse(cached);
        }
    } catch (e) {
        console.warn('Erro ao carregar cache:', e);
    }
    return null;
}

function isCacheExpired() {
    try {
        var cacheTime = localStorage.getItem(DATA.cacheTimeKey);
        if (!cacheTime) return true;
        
        var cached = new Date(cacheTime);
        var now = new Date();
        var diffHours = (now - cached) / (1000 * 60 * 60);
        
        // Cache expira após 2 horas
        return diffHours > 2;
    } catch (e) {
        return true;
    }
}

function getCacheAge() {
    try {
        var cacheTime = localStorage.getItem(DATA.cacheTimeKey);
        if (!cacheTime) return null;
        
        var cached = new Date(cacheTime);
        var now = new Date();
        var diffMinutes = Math.floor((now - cached) / (1000 * 60));
        
        if (diffMinutes < 1) return 'agora';
        if (diffMinutes < 60) return diffMinutes + ' min';
        
        var diffHours = Math.floor(diffMinutes / 60);
        if (diffHours < 24) return diffHours + 'h';
        
        return Math.floor(diffHours / 24) + 'd';
    } catch (e) {
        return null;
    }
}

// Funções de Status
function updateStatus(type, text) {
    var dot = document.getElementById('statusDot');
    var textEl = document.getElementById('statusText');
    
    if (dot) {
        dot.className = 'status-dot';
        if (type === 'online') dot.classList.add('online');
        else if (type === 'offline') dot.classList.add('offline');
        else if (type === 'cached') dot.classList.add('cached');
    }
    
    if (textEl) {
        textEl.textContent = text;
    }
}

function updateStatusFromSource(source) {
    var lastUpdateEl = document.getElementById('lastUpdate');
    var now = new Date();
    var timeStr = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    
    if (source === 'api') {
        updateStatus('online', 'API Online');
        if (lastUpdateEl) lastUpdateEl.textContent = 'Atualizado às ' + timeStr;
    } else if (source === 'cache') {
        var age = getCacheAge();
        updateStatus('cached', 'Cache');
        if (lastUpdateEl) lastUpdateEl.textContent = age ? 'Dados de ' + age + ' atrás' : '';
    } else if (source === 'example') {
        updateStatus('offline', 'Modo Offline');
        if (lastUpdateEl) lastUpdateEl.textContent = 'Dados de exemplo';
    }
}

function forceRefresh() {
    // Limpar cache
    try {
        localStorage.removeItem(DATA.cacheKey);
        localStorage.removeItem(DATA.cacheTimeKey);
    } catch (e) {}
    
    toast('Atualizando dados...');
    fetchFromAPI(false);
}

// Calcular CSN (índice único da combinação) usando coeficiente binomial
// ==================== PROBABILIDADES ====================

var probGraficoChart = null;

// Coeficiente binomial C(n, k)
function binomial(n, k) {
    if (k > n || k < 0) return 0;
    if (k === 0 || k === n) return 1;
    
    // Otimização: usar o menor k
    if (k > n - k) k = n - k;
    
    var result = 1;
    for (var i = 0; i < k; i++) {
        result = result * (n - i) / (i + 1);
    }
    return Math.round(result);
}

// Probabilidade Hipergeométrica P(X = t)
function probabilidadeHipergeometrica(u, s, k, t) {
    // u = universo (25)
    // s = sorteados (15)
    // k = aposta (15-20)
    // t = acertos desejados
    
    // P = C(k,t) * C(u-k, s-t) / C(u,s)
    var numerador = binomial(k, t) * binomial(u - k, s - t);
    var denominador = binomial(u, s);
    
    if (denominador === 0) return 0;
    return numerador / denominador;
}

// Quantidade de jogos para aposta de k números
function calcularQtdJogos(k) {
    return binomial(k, 15);
}

function toggleProbAvancado() {
    var avancado = document.getElementById('probModoAvancado').checked;
    
    var fieldUniverso = document.getElementById('probFieldUniverso');
    var fieldSorteados = document.getElementById('probFieldSorteados');
    var inputUniverso = document.getElementById('probUniverso');
    var inputSorteados = document.getElementById('probSorteados');
    var inputAposta = document.getElementById('probAposta');
    var inputAcertos = document.getElementById('probAcertos');
    
    if (avancado) {
        // Modo Avançado - libera tudo para outras loterias
        fieldUniverso.classList.remove('disabled');
        fieldSorteados.classList.remove('disabled');
        inputUniverso.disabled = false;
        inputSorteados.disabled = false;
        
        // Liberar limites para outras loterias
        inputUniverso.max = 200;
        inputSorteados.max = 100;
        inputAposta.max = 200;
        inputAposta.min = 1;
        inputAcertos.max = 100;
        inputAcertos.min = 0;
    } else {
        // Modo Normal - apenas Lotofácil
        fieldUniverso.classList.add('disabled');
        fieldSorteados.classList.add('disabled');
        inputUniverso.disabled = true;
        inputSorteados.disabled = true;
        inputUniverso.value = 25;
        inputSorteados.value = 15;
        
        // Limites da Lotofácil
        inputAposta.max = 20;
        inputAposta.min = 15;
        inputAcertos.max = 15;
        inputAcertos.min = 11;
        
        // Ajustar valores se estiverem fora do limite
        if (parseInt(inputAposta.value) > 20) inputAposta.value = 20;
        if (parseInt(inputAposta.value) < 15) inputAposta.value = 15;
        if (parseInt(inputAcertos.value) > 15) inputAcertos.value = 15;
        if (parseInt(inputAcertos.value) < 11) inputAcertos.value = 11;
    }
    
    calcularProbabilidade();
}

function calcularProbabilidade() {
    var u = parseInt(document.getElementById('probUniverso').value) || 25;
    var s = parseInt(document.getElementById('probSorteados').value) || 15;
    var k = parseInt(document.getElementById('probAposta').value) || 15;
    var t = parseInt(document.getElementById('probAcertos').value) || 15;
    
    // Validações - apenas limites lógicos
    if (k > u) {
        document.getElementById('probAposta').value = u;
        k = u;
    }
    if (k < 1) {
        document.getElementById('probAposta').value = 1;
        k = 1;
    }
    if (t > s) {
        document.getElementById('probAcertos').value = s;
        t = s;
    }
    if (t > k) {
        document.getElementById('probAcertos').value = k;
        t = k;
    }
    if (t < 0) {
        document.getElementById('probAcertos').value = 0;
        t = 0;
    }
    
    // Calcular probabilidade
    var prob = probabilidadeHipergeometrica(u, s, k, t);
    var percentual = (prob * 100).toFixed(10);
    var chance = prob > 0 ? Math.round(1 / prob) : 0;
    
    // Atualizar resultado principal
    document.getElementById('probResK').textContent = k;
    document.getElementById('probResT').textContent = t;
    document.getElementById('probResPercent').textContent = percentual.replace('.', ',') + '%';
    document.getElementById('probResChance').textContent = chance.toLocaleString('pt-BR');
    
    // Atualizar fórmula
    document.getElementById('formulaK').textContent = k;
    document.getElementById('formulaT').textContent = t;
    document.getElementById('formulaUK').textContent = u - k;
    document.getElementById('formulaST').textContent = s - t;
    document.getElementById('formulaU').textContent = u;
    document.getElementById('formulaS').textContent = s;
    
    // Cálculo detalhado
    var cKT = binomial(k, t);
    var cUKST = binomial(u - k, s - t);
    var cUS = binomial(u, s);
    var calcHtml = 'C(' + k + ',' + t + ') × C(' + (u-k) + ',' + (s-t) + ') / C(' + u + ',' + s + ') = ';
    calcHtml += cKT.toLocaleString('pt-BR') + ' × ' + cUKST.toLocaleString('pt-BR') + ' / ' + cUS.toLocaleString('pt-BR');
    calcHtml += ' = ' + (cKT * cUKST).toLocaleString('pt-BR') + ' / ' + cUS.toLocaleString('pt-BR');
    document.getElementById('probFormulaCalc').innerHTML = calcHtml;
    
    // Atualizar tabela de acertos
    atualizarTabelaAcertos(u, s, k);
    
    // Atualizar comparativo
    atualizarTabelaComparativo(u, s);
    
    // Atualizar análise de retorno
    atualizarAnaliseRetorno(u, s, k);
    
    // Atualizar gráfico
    atualizarGraficoProbabilidade(u, s, k);
}

function atualizarTabelaAcertos(u, s, k) {
    var premiosMedios = {
        15: 1500000,
        14: 1500,
        13: 30,
        12: 12,
        11: 6
    };
    
    var html = '';
    
    // Calcular range de acertos possíveis
    var maxAcertos = Math.min(s, k);
    var minAcertos = Math.max(0, s - (u - k));
    
    for (var t = maxAcertos; t >= minAcertos && t >= 0; t--) {
        var prob = probabilidadeHipergeometrica(u, s, k, t);
        var percentual = (prob * 100);
        var chance = prob > 0 ? Math.round(1 / prob) : 0;
        var premio = premiosMedios[t] || 0;
        
        var isHighlight = t === parseInt(document.getElementById('probAcertos').value);
        
        html += '<tr class="' + (isHighlight ? 'highlight' : '') + '">';
        html += '<td><strong>' + t + ' pontos</strong></td>';
        html += '<td>' + percentual.toFixed(8).replace('.', ',') + '%</td>';
        html += '<td>1 em ' + (chance > 0 ? chance.toLocaleString('pt-BR') : '∞') + '</td>';
        html += '<td class="premio">' + (premio > 0 ? 'R$ ' + premio.toLocaleString('pt-BR', {minimumFractionDigits: 2}) : '-') + '</td>';
        html += '</tr>';
    }
    
    if (html === '') {
        html = '<tr><td colspan="4" style="text-align:center;color:#64748b;">Nenhum acerto possível com esta configuração</td></tr>';
    }
    
    document.getElementById('probTabelaAcertosBody').innerHTML = html;
}

function atualizarTabelaComparativo(u, s) {
    var custoBase = 3.00;
    var html = '';
    
    for (var k = 15; k <= 20; k++) {
        var jogos = calcularQtdJogos(k);
        var custo = jogos * custoBase;
        
        var prob15 = probabilidadeHipergeometrica(u, s, k, 15);
        var prob14 = probabilidadeHipergeometrica(u, s, k, 14);
        var prob13 = probabilidadeHipergeometrica(u, s, k, 13);
        
        // Probabilidade de acertar 11 ou mais
        var prob11mais = 0;
        for (var t = 11; t <= 15; t++) {
            prob11mais += probabilidadeHipergeometrica(u, s, k, t);
        }
        
        var isSelected = k === parseInt(document.getElementById('probAposta').value);
        
        html += '<tr class="' + (isSelected ? 'highlight' : '') + '">';
        html += '<td><strong>' + k + ' números</strong></td>';
        html += '<td>' + jogos.toLocaleString('pt-BR') + '</td>';
        html += '<td>R$ ' + custo.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '</td>';
        html += '<td>' + (prob15 * 100).toFixed(8).replace('.', ',') + '%</td>';
        html += '<td>' + (prob14 * 100).toFixed(6).replace('.', ',') + '%</td>';
        html += '<td>' + (prob13 * 100).toFixed(4).replace('.', ',') + '%</td>';
        html += '<td>' + (prob11mais * 100).toFixed(2).replace('.', ',') + '%</td>';
        html += '</tr>';
    }
    
    document.getElementById('probTabelaComparativoBody').innerHTML = html;
}

function atualizarAnaliseRetorno(u, s, k) {
    var custoBase = 3.00;
    var jogos = calcularQtdJogos(k);
    var custo = jogos * custoBase;
    
    var premiosMedios = {
        15: 1500000,
        14: 1500,
        13: 30,
        12: 12,
        11: 6
    };
    
    // Calcular retorno esperado
    var retornoEsperado = 0;
    for (var t = 11; t <= 15; t++) {
        var prob = probabilidadeHipergeometrica(u, s, k, t);
        retornoEsperado += prob * premiosMedios[t];
    }
    
    var lucroEsperado = retornoEsperado - custo;
    var roi = ((retornoEsperado / custo) - 1) * 100;
    
    // Probabilidade de prêmio
    var probPremio = 0;
    for (var t = 11; t <= 15; t++) {
        probPremio += probabilidadeHipergeometrica(u, s, k, t);
    }
    
    var html = '';
    
    html += '<div class="prob-info-card">';
    html += '<div class="prob-info-card-value" style="color:#6366f1;">' + jogos.toLocaleString('pt-BR') + '</div>';
    html += '<div class="prob-info-card-label">Jogos na Aposta de ' + k + '</div>';
    html += '</div>';
    
    html += '<div class="prob-info-card">';
    html += '<div class="prob-info-card-value" style="color:#ef4444;">R$ ' + custo.toLocaleString('pt-BR', {minimumFractionDigits: 2}) + '</div>';
    html += '<div class="prob-info-card-label">Custo Total</div>';
    html += '</div>';
    
    html += '<div class="prob-info-card">';
    html += '<div class="prob-info-card-value" style="color:#f59e0b;">' + (probPremio * 100).toFixed(2).replace('.', ',') + '%</div>';
    html += '<div class="prob-info-card-label">Chance de Prêmio (11+ pts)</div>';
    html += '</div>';
    
    html += '<div class="prob-info-card">';
    html += '<div class="prob-info-card-value" style="color:#22c55e;">R$ ' + retornoEsperado.toFixed(2).replace('.', ',') + '</div>';
    html += '<div class="prob-info-card-label">Retorno Esperado</div>';
    html += '</div>';
    
    html += '<div class="prob-info-card">';
    html += '<div class="prob-info-card-value" style="color:' + (lucroEsperado >= 0 ? '#22c55e' : '#ef4444') + ';">R$ ' + lucroEsperado.toFixed(2).replace('.', ',') + '</div>';
    html += '<div class="prob-info-card-label">Lucro/Prejuízo Esperado</div>';
    html += '</div>';
    
    html += '<div class="prob-info-card">';
    html += '<div class="prob-info-card-value" style="color:' + (roi >= 0 ? '#22c55e' : '#ef4444') + ';">' + roi.toFixed(2).replace('.', ',') + '%</div>';
    html += '<div class="prob-info-card-label">ROI (Retorno sobre Investimento)</div>';
    html += '</div>';
    
    document.getElementById('probAnaliseRetorno').innerHTML = html;
}

function atualizarGraficoProbabilidade(u, s, k) {
    var ctx = document.getElementById('probGrafico').getContext('2d');
    
    // Calcular range de acertos possíveis
    var maxAcertos = Math.min(s, k);
    var minAcertos = Math.max(0, s - (u - k));
    
    var labels = [];
    var dados = [];
    var cores = [];
    var coresPaleta = ['#ef4444', '#f59e0b', '#eab308', '#84cc16', '#22c55e', '#14b8a6', '#06b6d4', '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899', '#f43f5e'];
    
    var idx = 0;
    for (var t = minAcertos; t <= maxAcertos; t++) {
        var prob = probabilidadeHipergeometrica(u, s, k, t) * 100;
        labels.push(t + ' pts');
        dados.push(prob > 0 ? prob : 0.0000001); // Valor mínimo para escala log
        cores.push(coresPaleta[idx % coresPaleta.length]);
        idx++;
    }
    
    if (probGraficoChart) {
        probGraficoChart.destroy();
    }
    
    // Verificar se há dados para exibir
    if (dados.length === 0) {
        return;
    }
    
    probGraficoChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Probabilidade (%)',
                data: dados,
                backgroundColor: cores,
                borderColor: cores,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y.toFixed(8) + '%';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    type: 'logarithmic',
                    grid: {
                        color: '#334155'
                    },
                    ticks: {
                        color: '#94a3b8',
                        callback: function(value) {
                            return value.toExponential(2);
                        }
                    }
                },
                x: {
                    grid: {
                        color: '#334155'
                    },
                    ticks: {
                        color: '#94a3b8'
                    }
                }
            }
        }
    });
}

// Inicializar ao carregar a página
function initProbabilidades() {
    calcularProbabilidade();
}

function calcularCSN(numeros) {
    // Ordenar números
    var nums = numeros.slice().sort(function(a, b) { return a - b; });
    
    // Função para calcular combinação C(n, k)
    function binomial(n, k) {
        if (k > n || k < 0) return 0;
        if (k === 0 || k === n) return 1;
        
        var result = 1;
        for (var i = 0; i < k; i++) {
            result = result * (n - i) / (i + 1);
        }
        return Math.round(result);
    }
    
    // Calcular índice usando sistema combinadico
    // CSN = 1 + soma de C(nums[i]-1, i+1) para i de 0 a 14
    var csn = 1;
    for (var i = 0; i < nums.length; i++) {
        csn += binomial(nums[i] - 1, i + 1);
    }
    
    return csn;
}

function formatCurrency(value) {
    if (!value) return null;
    return 'R$ ' + value.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
}

function parseRateio(d) {
    var rateio = [];
    
    // Mapeamento: faixa 1 = 15 pontos, faixa 2 = 14 pontos, etc.
    var faixaParaPontos = { 1: 15, 2: 14, 3: 13, 4: 12, 5: 11 };
    
    // Tentar diferentes estruturas da API
    if (d.premiacoes && Array.isArray(d.premiacoes)) {
        d.premiacoes.forEach(function(p) {
            var faixa = parseInt(p.faixa) || 0;
            var pontos = faixaParaPontos[faixa] || (16 - faixa); // fallback
            
            // Se descricao contém "15 acertos", usar isso
            if (p.descricao && p.descricao.match(/(\d+)\s*acerto/i)) {
                pontos = parseInt(p.descricao.match(/(\d+)\s*acerto/i)[1]);
            }
            
            rateio.push({
                faixa: pontos + ' pontos',
                acertos: pontos,
                ganhadores: p.ganhadores || p.numeroDeGanhadores || 0,
                valor: p.valorPremio || p.premio || 0
            });
        });
    } else if (d.rateioPremio || d.rateio) {
        var rat = d.rateioPremio || d.rateio;
        if (Array.isArray(rat)) {
            rat.forEach(function(p, idx) {
                var pontos = 15 - idx;
                rateio.push({
                    faixa: pontos + ' pontos',
                    acertos: pontos,
                    ganhadores: p.ganhadores || 0,
                    valor: p.valor || p.valorPremio || 0
                });
            });
        }
    }
    
    // Se não encontrou, criar estrutura padrão
    if (rateio.length === 0) {
        // Verificar campos individuais
        if (d.valorPremio15 !== undefined || d.ganhadores15 !== undefined) {
            for (var i = 15; i >= 11; i--) {
                rateio.push({
                    faixa: i + ' pontos',
                    acertos: i,
                    ganhadores: d['ganhadores' + i] || 0,
                    valor: d['valorPremio' + i] || d['premio' + i] || 0
                });
            }
        }
    }
    
    return rateio.length > 0 ? rateio : null;
}

function showLast() {
    if (!DATA.last) return;
    
    var nums = DATA.last.n;
    
    // Header
    document.getElementById('rnum').textContent = 'Concurso ' + DATA.last.c;
    document.getElementById('rdate').textContent = DATA.last.dt;
    
    // Banner de Acumulado
    var acumuladoBanner = document.getElementById('acumuladoBanner');
    if (DATA.last.acumulado) {
        acumuladoBanner.classList.remove('hidden');
        acumuladoBanner.innerHTML = '<div class="acumulado-content"><span class="acumulado-icon">🔥</span><span class="acumulado-text">ACUMULOU!</span><span class="acumulado-desc">Ninguém acertou 15 pontos no último concurso</span></div>';
    } else {
        acumuladoBanner.classList.add('hidden');
    }
    
    // Prêmio (se disponível)
    var prizeEl = document.getElementById('rprize');
    if (DATA.last.acumulado) {
        prizeEl.innerHTML = '<div class="result-prize-label">💰 Prêmio Acumulado (próximo concurso)</div><div class="result-prize-value">' + (DATA.last.premio || 'Aguardando') + '</div>';
        prizeEl.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
        prizeEl.classList.add('acumulado-prize');
    } else if (DATA.last.premio) {
        prizeEl.innerHTML = '<div class="result-prize-label">Prêmio Estimado (próximo concurso)</div><div class="result-prize-value">' + DATA.last.premio + '</div>';
        prizeEl.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
        prizeEl.classList.remove('acumulado-prize');
    } else {
        prizeEl.innerHTML = '<div class="result-prize-label">Lotofácil</div><div class="result-prize-value">🍀</div>';
        prizeEl.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        prizeEl.classList.remove('acumulado-prize');
    }
    
    // Rateio de premiações (layout horizontal)
    var rateioEl = document.getElementById('rateioBox');
    if (DATA.last.rateio && DATA.last.rateio.length > 0) {
        var rateioHtml = '<div class="rateio-title">💰 Rateio de Premiações</div>';
        rateioHtml += '<div class="rateio-grid">';
        DATA.last.rateio.forEach(function(r) {
            var ptsClass = 'rateio-pts pts' + r.acertos;
            var valorStr = r.valor > 0 ? formatCurrency(r.valor) : 'Acumulou';
            var ganhStr = r.ganhadores > 0 ? r.ganhadores.toLocaleString('pt-BR') + (r.ganhadores === 1 ? ' ganhador' : ' ganhadores') : 'Nenhum';
            
            rateioHtml += '<div class="rateio-item-h">';
            rateioHtml += '<div class="' + ptsClass + '">' + r.acertos + ' pontos</div>';
            rateioHtml += '<div class="rateio-valor">' + valorStr + '</div>';
            rateioHtml += '<div class="rateio-ganh">' + ganhStr + '</div>';
            rateioHtml += '</div>';
        });
        rateioHtml += '</div>';
        rateioEl.innerHTML = rateioHtml;
        rateioEl.style.display = 'block';
    } else {
        rateioEl.innerHTML = '<div class="rateio-title">💰 Rateio</div><div style="color:#64748b;font-size:0.75rem;text-align:center;padding:0.5rem;">Dados não disponíveis na API</div>';
        rateioEl.style.display = 'block';
    }
    
    // Volante 5x5
    var volanteHtml = '';
    for (var i = 1; i <= 25; i++) {
        var sorteado = nums.indexOf(i) > -1;
        var isMoldura = MOLDURA.indexOf(i) > -1;
        var isMiolo = MIOLO.indexOf(i) > -1;
        var isPar = i % 2 === 0;
        
        var classes = 'volante-num';
        if (sorteado) classes += ' sorteado';
        if (isMoldura) classes += ' moldura';
        if (isMiolo) classes += ' miolo';
        
        volanteHtml += '<div class="' + classes + '">';
        volanteHtml += (i < 10 ? '0' + i : i);
        volanteHtml += '</div>';
    }
    document.getElementById('volanteGrid').innerHTML = volanteHtml;
    
    // Estatísticas por Linha
    var linhas = [0, 0, 0, 0, 0];
    var colunas = [0, 0, 0, 0, 0];
    nums.forEach(function(n) {
        var linha = Math.floor((n - 1) / 5);
        var coluna = (n - 1) % 5;
        linhas[linha]++;
        colunas[coluna]++;
    });
    
    var linhasHtml = '';
    linhas.forEach(function(qtd, idx) {
        linhasHtml += '<div class="lc-item linha"><span>L' + (idx + 1) + '</span><span>' + qtd + '</span></div>';
    });
    document.getElementById('linhasGrid').innerHTML = linhasHtml;
    
    var colunasHtml = '';
    colunas.forEach(function(qtd, idx) {
        colunasHtml += '<div class="lc-item coluna"><span>C' + (idx + 1) + '</span><span>' + qtd + '</span></div>';
    });
    document.getElementById('colunasGrid').innerHTML = colunasHtml;
    
    // Estatísticas Detalhadas com Indicador de Padrão
    
    // Pares / Ímpares (ideal: 7/8 ou 8/7)
    var pares = nums.filter(function(x) { return x % 2 === 0; }).length;
    var impares = 15 - pares;
    var paresDentro = pares >= 6 && pares <= 9;
    document.getElementById('statPares').textContent = pares + ' / ' + impares;
    document.getElementById('cardPares').className = 'stat-card ' + (paresDentro ? 'dentro' : 'fora');
    document.getElementById('statusPares').textContent = paresDentro ? '✓ PADRÃO' : '✗ FORA DO PADRÃO';
    
    // Moldura / Miolo (ideal: 9-11 moldura)
    var moldura = nums.filter(function(x) { return MOLDURA.indexOf(x) > -1; }).length;
    var miolo = nums.filter(function(x) { return MIOLO.indexOf(x) > -1; }).length;
    var molduraDentro = moldura >= 9 && moldura <= 11;
    document.getElementById('statMoldura').textContent = moldura + ' / ' + miolo;
    document.getElementById('cardMoldura').className = 'stat-card ' + (molduraDentro ? 'dentro' : 'fora');
    document.getElementById('statusMoldura').textContent = molduraDentro ? '✓ PADRÃO' : '✗ FORA DO PADRÃO';
    
    // Primos (ideal: 4-6 de 9)
    var primos = nums.filter(function(x) { return PRIMOS.indexOf(x) > -1; }).length;
    var primosDentro = primos >= 4 && primos <= 6;
    document.getElementById('statPrimos').textContent = primos + ' de 9';
    document.getElementById('cardPrimos').className = 'stat-card ' + (primosDentro ? 'dentro' : 'fora');
    document.getElementById('statusPrimos').textContent = primosDentro ? '✓ PADRÃO' : '✗ FORA DO PADRÃO';
    
    // Fibonacci (ideal: 3-5 de 7)
    var fibo = nums.filter(function(x) { return FIBONACCI.indexOf(x) > -1; }).length;
    var fiboDentro = fibo >= 3 && fibo <= 5;
    document.getElementById('statFibo').textContent = fibo + ' de 7';
    document.getElementById('cardFibo').className = 'stat-card ' + (fiboDentro ? 'dentro' : 'fora');
    document.getElementById('statusFibo').textContent = fiboDentro ? '✓ PADRÃO' : '✗ FORA DO PADRÃO';
    
    // Múltiplos de 3 (ideal: 4-6 de 8)
    var mult3 = nums.filter(function(x) { return MULT3.indexOf(x) > -1; }).length;
    var mult3Dentro = mult3 >= 4 && mult3 <= 6;
    document.getElementById('statMult3').textContent = mult3 + ' de 8';
    document.getElementById('cardMult3').className = 'stat-card ' + (mult3Dentro ? 'dentro' : 'fora');
    document.getElementById('statusMult3').textContent = mult3Dentro ? '✓ PADRÃO' : '✗ FORA DO PADRÃO';
    
    // Soma (ideal: 170-220)
    var soma = nums.reduce(function(a, b) { return a + b; }, 0);
    var somaDentro = soma >= 170 && soma <= 220;
    document.getElementById('statSoma').textContent = soma;
    document.getElementById('cardSoma').className = 'stat-card ' + (somaDentro ? 'dentro' : 'fora');
    document.getElementById('statusSoma').textContent = somaDentro ? '✓ PADRÃO' : '✗ FORA DO PADRÃO';
    
    // Repetidas do concurso anterior (ideal: 5-10 de 15)
    var repetidas = 0;
    var repetDentro = false;
    if (DATA.all && DATA.all.length > 1 && DATA.all[1] && DATA.all[1].n) {
        var anterior = DATA.all[1].n;
        repetidas = nums.filter(function(x) { return anterior.indexOf(x) > -1; }).length;
        repetDentro = repetidas >= 5 && repetidas <= 10;
        document.getElementById('statRepet').textContent = repetidas + ' de 15';
        document.getElementById('cardRepet').className = 'stat-card ' + (repetDentro ? 'dentro' : 'fora');
        document.getElementById('statusRepet').textContent = repetDentro ? '✓ PADRÃO' : '✗ FORA DO PADRÃO';
    } else {
        document.getElementById('statRepet').textContent = '-';
        document.getElementById('cardRepet').className = 'stat-card';
        document.getElementById('statusRepet').textContent = 'Aguardando';
    }
    
    // Sequências (ideal: 2-4 pares consecutivos)
    var sequencias = 0;
    var sorted = nums.slice().sort(function(a, b) { return a - b; });
    for (var i = 1; i < sorted.length; i++) {
        if (sorted[i] === sorted[i-1] + 1) sequencias++;
    }
    var seqDentro = sequencias >= 2 && sequencias <= 4;
    document.getElementById('statSeq').textContent = sequencias + ' pares';
    document.getElementById('cardSeq').className = 'stat-card ' + (seqDentro ? 'dentro' : 'fora');
    document.getElementById('statusSeq').textContent = seqDentro ? '✓ PADRÃO' : '✗ FORA DO PADRÃO';
    
    // Bolas sorteadas
    var ballsHtml = '';
    nums.forEach(function(x) {
        ballsHtml += '<div class="ball">' + (x < 10 ? '0' + x : x) + '</div>';
    });
    document.getElementById('rballs').innerHTML = ballsHtml;
    
    // CSN do resultado oficial
    var csnResultado = calcularCSN(nums);
    document.getElementById('resultadoCSN').innerHTML = '<span class="csn-label">CSN:</span> <span class="csn-value">' + csnResultado.toLocaleString('pt-BR') + '</span>';
    
    // Números ausentes (não sorteados)
    var ausentes = [];
    for (var n = 1; n <= 25; n++) {
        if (nums.indexOf(n) === -1) {
            ausentes.push(n);
        }
    }
    
    // Calcular "temperatura" dos ausentes (quantos sorteios sem sair nos últimos 10)
    var ausentesHtml = '';
    ausentes.forEach(function(n) {
        var atraso = 0;
        if (DATA.l10 && DATA.l10.length > 0) {
            for (var i = 0; i < DATA.l10.length; i++) {
                if (DATA.l10[i].n.indexOf(n) === -1) {
                    atraso++;
                } else {
                    break;
                }
            }
        }
        
        var classe = 'ball-aus';
        var title = '';
        if (atraso >= 5) {
            classe += ' quente';
            title = 'Quente! ' + atraso + ' sorteios sem sair';
        } else if (atraso >= 3) {
            classe += ' morno';
            title = 'Morno: ' + atraso + ' sorteios sem sair';
        } else {
            classe += ' frio';
            title = 'Saiu recentemente';
        }
        
        ausentesHtml += '<div class="' + classe + '" title="' + title + '">' + (n < 10 ? '0' + n : n) + '</div>';
    });
    document.getElementById('rAusentes').innerHTML = ausentesHtml;
}

function fillConfSel() {
    var sel = document.getElementById('confSel');
    sel.innerHTML = '<option value="ultimo">Último Resultado</option>';
    DATA.all.forEach(function(r) {
        var opt = document.createElement('option');
        opt.value = r.c;
        opt.textContent = r.c + ' - ' + r.dt;
        sel.appendChild(opt);
    });
}

function updateStats() {
    if (DATA.l10.length === 0) return;
    
    var freq = {};
    for (var i = 1; i <= 25; i++) freq[i] = 0;
    
    var tP = 0, tPr = 0, tS = 0, tM = 0;
    DATA.l10.forEach(function(r) {
        r.n.forEach(function(x) { freq[x]++; });
        tP += r.n.filter(function(x) { return x % 2 === 0; }).length;
        tPr += r.n.filter(function(x) { return PRIMOS.indexOf(x) > -1; }).length;
        tS += r.n.reduce(function(a, b) { return a + b; }, 0);
        tM += r.n.filter(function(x) { return MOLDURA.indexOf(x) > -1; }).length;
    });
    
    document.getElementById('avgPar').textContent = (tP / 10).toFixed(1);
    document.getElementById('avgPri').textContent = (tPr / 10).toFixed(1);
    document.getElementById('avgSoma').textContent = Math.round(tS / 10);
    document.getElementById('avgMold').textContent = (tM / 10).toFixed(1);
    
    var sorted = Object.keys(freq).map(function(n) { return { n: parseInt(n), f: freq[n] }; }).sort(function(a, b) { return b.f - a.f; });
    var maxF = sorted[0].f;
    var minF = sorted[sorted.length - 1].f;
    
    // Grid de frequência com cards profissionais
    var html = '';
    for (var i = 1; i <= 25; i++) {
        var f = freq[i];
        var int = maxF === minF ? 0.5 : (f - minF) / (maxF - minF);
        
        // Determinar status baseado na frequência
        var statusText, statusClass;
        if (int >= 0.7) {
            statusText = 'QUENTE';
            statusClass = 'freq-quente';
        } else if (int >= 0.3) {
            statusText = 'MORNO';
            statusClass = 'freq-morno';
        } else {
            statusText = 'FRIO';
            statusClass = 'freq-frio';
        }
        
        html += '<div class="freq-card ' + statusClass + '">';
        html += '<div class="freq-card-num">' + (i < 10 ? '0' + i : i) + '</div>';
        html += '<div class="freq-card-count">' + f + 'x</div>';
        html += '<div class="freq-card-status">' + statusText + '</div>';
        html += '</div>';
    }
    document.getElementById('freqGrid').innerHTML = html;
    
    html = '';
    sorted.slice(0, 8).forEach(function(x) {
        html += '<div class="freq"><div class="fnum hot">' + (x.n < 10 ? '0' + x.n : x.n) + '</div><div style="flex:1;"><div style="font-size:0.8rem;">Dezena ' + x.n + '</div><div style="font-size:0.7rem;color:#64748b;">' + x.f + 'x (' + (x.f * 10) + '%)</div><div class="fbar"><div class="ffill hot" style="width:' + (x.f / maxF * 100) + '%"></div></div></div></div>';
    });
    document.getElementById('hotList').innerHTML = html;
    
    html = '';
    sorted.slice(-8).reverse().forEach(function(x) {
        html += '<div class="freq"><div class="fnum cold">' + (x.n < 10 ? '0' + x.n : x.n) + '</div><div style="flex:1;"><div style="font-size:0.8rem;">Dezena ' + x.n + '</div><div style="font-size:0.7rem;color:#64748b;">' + x.f + 'x (' + (x.f * 10) + '%)</div><div class="fbar"><div class="ffill cold" style="width:' + (x.f / maxF * 100) + '%"></div></div></div></div>';
    });
    document.getElementById('coldList').innerHTML = html;
    
    html = '';
    DATA.l10.forEach(function(r) {
        var p = r.n.filter(function(x) { return x % 2 === 0; }).length;
        var pr = r.n.filter(function(x) { return PRIMOS.indexOf(x) > -1; }).length;
        var s = r.n.reduce(function(a, b) { return a + b; }, 0);
        var m = r.n.filter(function(x) { return MOLDURA.indexOf(x) > -1; }).length;
        var mi = r.n.filter(function(x) { return MIOLO.indexOf(x) > -1; }).length;
        var fib = r.n.filter(function(x) { return FIBONACCI.indexOf(x) > -1; }).length;
        
        html += '<div style="padding:0.75rem 0;border-bottom:1px solid #334155;">';
        html += '<div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;flex-wrap:wrap;gap:0.3rem;">';
        html += '<span style="font-weight:600;font-size:0.9rem;color:#f1f5f9;">Conc. ' + r.c + '</span>';
        html += '<span style="font-size:0.7rem;color:#94a3b8;">P:' + p + ' Pr:' + pr + ' Σ:' + s + ' M:' + m + '</span>';
        html += '</div>';
        
        // Dezenas
        html += '<div style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:0.5rem;">';
        r.n.forEach(function(x) { html += '<span style="background:#334155;padding:2px 6px;border-radius:4px;font-size:0.75rem;font-weight:500;">' + (x < 10 ? '0' + x : x) + '</span>'; });
        html += '</div>';
        
        // Estatísticas detalhadas em badges
        html += '<div style="display:flex;flex-wrap:wrap;gap:0.4rem;">';
        html += '<span style="background:rgba(99,102,241,0.2);color:#818cf8;padding:2px 6px;border-radius:4px;font-size:0.65rem;font-weight:600;">Pares: ' + p + '</span>';
        html += '<span style="background:rgba(236,72,153,0.2);color:#f472b6;padding:2px 6px;border-radius:4px;font-size:0.65rem;font-weight:600;">Primos: ' + pr + '</span>';
        html += '<span style="background:rgba(139,92,246,0.2);color:#a78bfa;padding:2px 6px;border-radius:4px;font-size:0.65rem;font-weight:600;">Moldura: ' + m + '</span>';
        html += '<span style="background:rgba(245,158,11,0.2);color:#fbbf24;padding:2px 6px;border-radius:4px;font-size:0.65rem;font-weight:600;">Miolo: ' + mi + '</span>';
        html += '<span style="background:rgba(16,185,129,0.2);color:#34d399;padding:2px 6px;border-radius:4px;font-size:0.65rem;font-weight:600;">Fibo: ' + fib + '</span>';
        html += '<span style="background:rgba(59,130,246,0.2);color:#60a5fa;padding:2px 6px;border-radius:4px;font-size:0.65rem;font-weight:600;">Σ ' + s + '</span>';
        html += '</div>';
        
        html += '</div>';
    });
    document.getElementById('histList').innerHTML = html;
    
    html = '<div class="tendencias-section">';
    html += '<div class="tendencias-row"><span class="tendencias-label">🔥 Quentes (mais frequentes):</span>';
    html += '<div class="tendencias-nums">';
    sorted.slice(0, 6).forEach(function(x) {
        html += '<span class="tend-num quente">' + (x.n < 10 ? '0' + x.n : x.n) + '<small>' + x.f + 'x</small></span>';
    });
    html += '</div></div>';
    html += '<div class="tendencias-row"><span class="tendencias-label">❄️ Frias (menos frequentes):</span>';
    html += '<div class="tendencias-nums">';
    sorted.slice(-6).forEach(function(x) {
        html += '<span class="tend-num fria">' + (x.n < 10 ? '0' + x.n : x.n) + '<small>' + x.f + 'x</small></span>';
    });
    html += '</div></div></div>';
    document.getElementById('homeStats').innerHTML = html;
    
    // Inicializar gráfico CSN
    atualizarGraficoCSN();
}

// Variável global para o gráfico
var graficoLinhaChart = null;

function atualizarGraficoCSN() {
    if (!DATA.all || DATA.all.length < 5) return;
    
    var qtd = parseInt(document.getElementById('graficoQtd').value) || 10;
    
    var concursos = DATA.all.slice(0, qtd).reverse();
    
    var labels = [];
    var dados = [];
    
    concursos.forEach(function(c) {
        labels.push(c.c.toString());
        var csn = calcularCSN(c.n);
        dados.push(csn);
    });
    
    // Calcular estatísticas
    var minimo = Math.min.apply(null, dados);
    var maximo = Math.max.apply(null, dados);
    var soma = dados.reduce(function(a, b) { return a + b; }, 0);
    var media = Math.round(soma / dados.length);
    var atual = dados[dados.length - 1];
    
    // Calcular variação
    var variacao = dados.length > 1 ? dados[dados.length - 1] - dados[dados.length - 2] : 0;
    var variacaoStr = variacao >= 0 ? '+' + variacao.toLocaleString('pt-BR') : variacao.toLocaleString('pt-BR');
    var variacaoClass = variacao >= 0 ? 'positivo' : 'negativo';
    
    // Atualizar estatísticas
    var statsHtml = '';
    statsHtml += '<div class="grafico-stat-item minimo"><div class="grafico-stat-value">' + minimo.toLocaleString('pt-BR') + '</div><div class="grafico-stat-label">CSN Mínimo</div></div>';
    statsHtml += '<div class="grafico-stat-item maximo"><div class="grafico-stat-value">' + maximo.toLocaleString('pt-BR') + '</div><div class="grafico-stat-label">CSN Máximo</div></div>';
    statsHtml += '<div class="grafico-stat-item media"><div class="grafico-stat-value">' + media.toLocaleString('pt-BR') + '</div><div class="grafico-stat-label">CSN Médio</div></div>';
    statsHtml += '<div class="grafico-stat-item atual"><div class="grafico-stat-value">' + atual.toLocaleString('pt-BR') + '</div><div class="grafico-stat-label">CSN Atual</div></div>';
    statsHtml += '<div class="grafico-stat-item ' + variacaoClass + '"><div class="grafico-stat-value">' + variacaoStr + '</div><div class="grafico-stat-label">Variação</div></div>';
    document.getElementById('graficoStats').innerHTML = statsHtml;
    
    var ctx = document.getElementById('graficoLinha').getContext('2d');
    
    // Destruir gráfico anterior se existir
    if (graficoLinhaChart) {
        graficoLinhaChart.destroy();
    }
    
    // Criar novo gráfico
    graficoLinhaChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'CSN (Índice da Combinação)',
                data: dados,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16,185,129,0.15)',
                borderWidth: 3,
                fill: true,
                tension: 0.3,
                pointRadius: 6,
                pointHoverRadius: 9,
                pointBackgroundColor: '#10b981',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: '#94a3b8',
                        font: { size: 12 }
                    }
                },
                tooltip: {
                    backgroundColor: '#1e293b',
                    titleColor: '#f1f5f9',
                    bodyColor: '#10b981',
                    borderColor: '#10b981',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: false,
                    callbacks: {
                        title: function(context) {
                            return 'Concurso ' + context[0].label;
                        },
                        label: function(context) {
                            return 'CSN: ' + context.raw.toLocaleString('pt-BR');
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { color: '#334155' },
                    ticks: { 
                        color: '#94a3b8',
                        font: { size: 11, weight: 'bold' }
                    },
                    title: {
                        display: true,
                        text: 'Concurso',
                        color: '#64748b'
                    }
                },
                y: {
                    grid: { color: '#334155' },
                    ticks: { 
                        color: '#94a3b8',
                        callback: function(value) {
                            if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                            if (value >= 1000) return (value / 1000).toFixed(0) + 'K';
                            return value;
                        }
                    },
                    title: {
                        display: true,
                        text: 'CSN',
                        color: '#64748b'
                    },
                    min: 0,
                    max: 3268760
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}

// ==================== MESCLAGEM ESTRATÉGICA ====================

var FIBONACCI = [1, 2, 3, 5, 8, 13, 21];
var MULTIPLOS3 = [3, 6, 9, 12, 15, 18, 21, 24];

var mesclagemData = {
    sorteadas: [],
    ausentes: [],
    freqSort: {},
    freqAus: {},
    jogosGerados: []
};

function initMesclagem() {
    if (!DATA.last || !DATA.l10) return;
    
    var nums = DATA.last.n.slice().sort(function(a,b) { return a-b; });
    mesclagemData.sorteadas = nums;
    
    // Ausentes
    var aus = [];
    for (var i = 1; i <= 25; i++) {
        if (nums.indexOf(i) === -1) aus.push(i);
    }
    mesclagemData.ausentes = aus;
    
    // Calcular frequências nos últimos 10 sorteios
    var freq = {};
    for (var i = 1; i <= 25; i++) freq[i] = 0;
    DATA.l10.forEach(function(r) {
        r.n.forEach(function(n) { freq[n]++; });
    });
    
    mesclagemData.freqSort = {};
    mesclagemData.freqAus = {};
    nums.forEach(function(n) { mesclagemData.freqSort[n] = freq[n]; });
    aus.forEach(function(n) { mesclagemData.freqAus[n] = freq[n]; });
    
    // Calcular dados posicionais
    calcularDadosPosicionais();
    
    renderMesclagemBalls();
    updateMesclaPreview();
    updatePosicionalPreview();
}

function calcularDadosPosicionais() {
    var range = parseInt(document.getElementById('mesclaPosRange').value) || 25;
    var concursos = DATA.all.slice(0, range);
    
    if (concursos.length < 5) return;
    
    // Calcular frequência por posição
    var freqPorPos = [];
    for (var pos = 0; pos < 15; pos++) {
        var freq = {};
        for (var n = 1; n <= 25; n++) freq[n] = 0;
        freqPorPos.push(freq);
    }
    
    concursos.forEach(function(c) {
        var sorted = c.n.slice().sort(function(a,b) { return a-b; });
        sorted.forEach(function(n, pos) {
            freqPorPos[pos][n]++;
        });
    });
    
    // Para cada número, calcular seu "score posicional" (soma das frequências nas posições onde ele pode aparecer)
    mesclagemData.scorePosicional = {};
    for (var n = 1; n <= 25; n++) {
        var score = 0;
        var maxFreqPos = 0;
        var melhorPos = -1;
        
        freqPorPos.forEach(function(freq, pos) {
            if (freq[n] > maxFreqPos) {
                maxFreqPos = freq[n];
                melhorPos = pos + 1;
            }
            score += freq[n];
        });
        
        mesclagemData.scorePosicional[n] = {
            score: score,
            maxFreq: maxFreqPos,
            melhorPos: melhorPos
        };
    }
    
    // Ordenar sorteadas por score posicional
    mesclagemData.sortPosRank = mesclagemData.sorteadas.slice().sort(function(a, b) {
        return mesclagemData.scorePosicional[b].score - mesclagemData.scorePosicional[a].score;
    });
    
    // Ordenar ausentes por score posicional
    mesclagemData.ausPosRank = mesclagemData.ausentes.slice().sort(function(a, b) {
        return mesclagemData.scorePosicional[b].score - mesclagemData.scorePosicional[a].score;
    });
}

function togglePosicionalOptions() {
    var checked = document.getElementById('mesclaUsarPosicional').checked;
    var config = document.getElementById('mesclaPosicionalConfig');
    
    if (checked) {
        config.classList.remove('hidden');
        calcularDadosPosicionais();
        updatePosicionalPreview();
    } else {
        config.classList.add('hidden');
    }
}

function updatePosicionalPreview() {
    if (!mesclagemData.sortPosRank || !mesclagemData.ausPosRank) {
        calcularDadosPosicionais();
    }
    
    if (!mesclagemData.sortPosRank) return;
    
    // Preview sorteadas top posicional
    var sortHtml = '';
    mesclagemData.sortPosRank.forEach(function(n, i) {
        var info = mesclagemData.scorePosicional[n];
        var isTop = i < 5;
        sortHtml += '<span class="mescla-preview-num sort" style="' + (isTop ? 'font-weight:700;' : 'opacity:0.6;') + '" title="Score: ' + info.score + ' | Melhor pos: ' + info.melhorPos + 'ª">';
        sortHtml += (n < 10 ? '0' + n : n) + '<small>(' + info.score + ')</small></span>';
    });
    document.getElementById('mesclaPosSortPreview').innerHTML = sortHtml;
    
    // Preview ausentes top posicional
    var ausHtml = '';
    mesclagemData.ausPosRank.forEach(function(n, i) {
        var info = mesclagemData.scorePosicional[n];
        var isTop = i < 4;
        ausHtml += '<span class="mescla-preview-num aus" style="' + (isTop ? 'font-weight:700;' : 'opacity:0.6;') + '" title="Score: ' + info.score + ' | Melhor pos: ' + info.melhorPos + 'ª">';
        ausHtml += (n < 10 ? '0' + n : n) + '<small>(' + info.score + ')</small></span>';
    });
    document.getElementById('mesclaPosAusPreview').innerHTML = ausHtml;
}

function renderMesclagemBalls() {
    var sortHtml = '';
    var sortedSort = mesclagemData.sorteadas.slice().sort(function(a,b) {
        return mesclagemData.freqSort[b] - mesclagemData.freqSort[a];
    });
    
    mesclagemData.sorteadas.forEach(function(n) {
        var f = mesclagemData.freqSort[n];
        var tempClass = f >= 7 ? 'quente' : (f >= 4 ? 'morno' : 'frio');
        sortHtml += '<div class="mescla-ball sorteada" data-n="' + n + '" title="Frequência: ' + f + 'x">';
        sortHtml += (n < 10 ? '0' + n : n);
        sortHtml += '<span class="temp-badge ' + tempClass + '">' + f + '</span>';
        sortHtml += '</div>';
    });
    document.getElementById('mesclaSorteadas').innerHTML = sortHtml;
    
    var ausHtml = '';
    mesclagemData.ausentes.forEach(function(n) {
        var f = mesclagemData.freqAus[n];
        var tempClass = f >= 7 ? 'quente' : (f >= 4 ? 'morno' : 'frio');
        ausHtml += '<div class="mescla-ball ausente" data-n="' + n + '" title="Frequência: ' + f + 'x">';
        ausHtml += (n < 10 ? '0' + n : n);
        ausHtml += '<span class="temp-badge ' + tempClass + '">' + f + '</span>';
        ausHtml += '</div>';
    });
    document.getElementById('mesclaAusentes').innerHTML = ausHtml;
}

function setMesclaEstrategia(tipo) {
    // Remover active de todos
    document.querySelectorAll('.mescla-estr-btn').forEach(function(btn) {
        btn.classList.remove('active');
    });
    // Adicionar active no clicado
    event.target.closest('.mescla-estr-btn').classList.add('active');
    
    var configs = {
        conservadora: { minSort: 9, maxSort: 11, minAus: 4, maxAus: 6, tempSort: 'quentes', tempAus: 'quentes' },
        equilibrada: { minSort: 8, maxSort: 10, minAus: 5, maxAus: 7, tempSort: 'quentes', tempAus: 'frias' },
        ousada: { minSort: 6, maxSort: 8, minAus: 7, maxAus: 9, tempSort: 'quentes', tempAus: 'frias' },
        ciclo: { minSort: 7, maxSort: 9, minAus: 6, maxAus: 8, tempSort: 'frias', tempAus: 'frias' },
        personalizada: null
    };
    
    var cfg = configs[tipo];
    if (cfg) {
        document.getElementById('mesclaMinSort').value = cfg.minSort;
        document.getElementById('mesclaMaxSort').value = cfg.maxSort;
        document.getElementById('mesclaMinAus').value = cfg.minAus;
        document.getElementById('mesclaMaxAus').value = cfg.maxAus;
        document.querySelector('input[name="tempSort"][value="' + cfg.tempSort + '"]').checked = true;
        document.querySelector('input[name="tempAus"][value="' + cfg.tempAus + '"]').checked = true;
    }
    
    updateMesclaPreview();
}

function updateMesclaPreview() {
    if (!mesclagemData.sorteadas.length) return;
    
    var tempSort = document.querySelector('input[name="tempSort"]:checked').value;
    var tempAus = document.querySelector('input[name="tempAus"]:checked').value;
    
    // Ordenar sorteadas por temperatura
    var sortOrdenadas = mesclagemData.sorteadas.slice();
    if (tempSort === 'quentes') {
        sortOrdenadas.sort(function(a,b) { return mesclagemData.freqSort[b] - mesclagemData.freqSort[a]; });
    } else if (tempSort === 'frias') {
        sortOrdenadas.sort(function(a,b) { return mesclagemData.freqSort[a] - mesclagemData.freqSort[b]; });
    }
    
    // Ordenar ausentes por temperatura
    var ausOrdenadas = mesclagemData.ausentes.slice();
    if (tempAus === 'quentes') {
        ausOrdenadas.sort(function(a,b) { return mesclagemData.freqAus[b] - mesclagemData.freqAus[a]; });
    } else if (tempAus === 'frias') {
        ausOrdenadas.sort(function(a,b) { return mesclagemData.freqAus[a] - mesclagemData.freqAus[b]; });
    }
    
    // Preview sorteadas
    var previewSortHtml = '';
    sortOrdenadas.forEach(function(n, i) {
        var f = mesclagemData.freqSort[n];
        previewSortHtml += '<span class="mescla-preview-num sort">' + (n < 10 ? '0' + n : n) + '(' + f + 'x)</span>';
    });
    document.getElementById('mesclaPreviewSort').innerHTML = previewSortHtml;
    
    // Preview ausentes
    var previewAusHtml = '';
    ausOrdenadas.forEach(function(n, i) {
        var f = mesclagemData.freqAus[n];
        previewAusHtml += '<span class="mescla-preview-num aus">' + (n < 10 ? '0' + n : n) + '(' + f + 'x)</span>';
    });
    document.getElementById('mesclaPreviewAus').innerHTML = previewAusHtml;
}

function gerarMesclagem() {
    if (!mesclagemData.sorteadas.length) {
        toast('Aguarde carregar os dados!', true);
        return;
    }
    
    var minSort = parseInt(document.getElementById('mesclaMinSort').value);
    var maxSort = parseInt(document.getElementById('mesclaMaxSort').value);
    var minAus = parseInt(document.getElementById('mesclaMinAus').value);
    var maxAus = parseInt(document.getElementById('mesclaMaxAus').value);
    var qtdJogos = parseInt(document.getElementById('mesclaQtdJogos').value);
    var baseDesd = parseInt(document.getElementById('mesclaBaseDesd').value);
    var tempSort = document.querySelector('input[name="tempSort"]:checked').value;
    var tempAus = document.querySelector('input[name="tempAus"]:checked').value;
    
    // Filtro posicional
    var usarPosicional = document.getElementById('mesclaUsarPosicional').checked;
    var minPosSort = usarPosicional ? parseInt(document.getElementById('mesclaMinPosSort').value) : 0;
    var minPosAus = usarPosicional ? parseInt(document.getElementById('mesclaMinPosAus').value) : 0;
    
    // Recalcular dados posicionais se necessário
    if (usarPosicional) {
        calcularDadosPosicionais();
    }
    
    // Validar configuração
    if (minSort + minAus > 15 || maxSort + maxAus < 15) {
        toast('Configuração inválida! Mín+Mín deve ser ≤15 e Máx+Máx deve ser ≥15', true);
        return;
    }
    
    // Ordenar por temperatura
    var sortOrdenadas = mesclagemData.sorteadas.slice();
    if (tempSort === 'quentes') {
        sortOrdenadas.sort(function(a,b) { return mesclagemData.freqSort[b] - mesclagemData.freqSort[a]; });
    } else if (tempSort === 'frias') {
        sortOrdenadas.sort(function(a,b) { return mesclagemData.freqSort[a] - mesclagemData.freqSort[b]; });
    } else {
        shuffleArray(sortOrdenadas);
    }
    
    var ausOrdenadas = mesclagemData.ausentes.slice();
    if (tempAus === 'quentes') {
        ausOrdenadas.sort(function(a,b) { return mesclagemData.freqAus[b] - mesclagemData.freqAus[a]; });
    } else if (tempAus === 'frias') {
        ausOrdenadas.sort(function(a,b) { return mesclagemData.freqAus[a] - mesclagemData.freqAus[b]; });
    } else {
        shuffleArray(ausOrdenadas);
    }
    
    // Obter top posicionais se ativado
    var topPosSorteadas = usarPosicional && mesclagemData.sortPosRank ? mesclagemData.sortPosRank.slice(0, Math.min(8, mesclagemData.sortPosRank.length)) : [];
    var topPosAusentes = usarPosicional && mesclagemData.ausPosRank ? mesclagemData.ausPosRank.slice(0, Math.min(5, mesclagemData.ausPosRank.length)) : [];
    
    mesclagemData.jogosGerados = [];
    var tentativas = 0;
    var maxTentativas = qtdJogos * 500;
    var jogosSet = {};
    
    // Contadores de diagnóstico
    var diagnostico = {
        duplicatas: 0,
        filtroPares: 0,
        filtroPrimos: 0,
        filtroFibo: 0,
        filtroMoldura: 0,
        filtroSoma: 0,
        filtroMult3: 0,
        filtroSeq: 0,
        filtroSalto: 0,
        filtroPosicional: 0
    };
    
    while (mesclagemData.jogosGerados.length < qtdJogos && tentativas < maxTentativas) {
        tentativas++;
        
        // Determinar quantas de cada
        var qtdSort = minSort + Math.floor(Math.random() * (maxSort - minSort + 1));
        var qtdAus = 15 - qtdSort;
        
        // Ajustar se fora dos limites
        if (qtdAus < minAus) {
            qtdAus = minAus;
            qtdSort = 15 - qtdAus;
        }
        if (qtdAus > maxAus) {
            qtdAus = maxAus;
            qtdSort = 15 - qtdAus;
        }
        
        // Selecionar números
        var tempSortArr = sortOrdenadas.slice();
        var tempAusArr = ausOrdenadas.slice();
        
        // Adicionar aleatoriedade mantendo prioridade
        if (tempSort !== 'todas') {
            tempSortArr = weightedShuffle(tempSortArr);
        } else {
            shuffleArray(tempSortArr);
        }
        
        if (tempAus !== 'todas') {
            tempAusArr = weightedShuffle(tempAusArr);
        } else {
            shuffleArray(tempAusArr);
        }
        
        var jogo = [];
        var sortSelecionadas = tempSortArr.slice(0, qtdSort);
        var ausSelecionadas = tempAusArr.slice(0, qtdAus);
        
        jogo = jogo.concat(sortSelecionadas);
        jogo = jogo.concat(ausSelecionadas);
        jogo.sort(function(a,b) { return a-b; });
        
        // Verificar duplicata
        var key = jogo.join(',');
        if (jogosSet[key]) {
            diagnostico.duplicatas++;
            continue;
        }
        
        // Validar filtros estatísticos com diagnóstico
        var resultadoFiltro = validarMesclagemJogoComDiagnostico(jogo);
        if (!resultadoFiltro.valido) {
            diagnostico[resultadoFiltro.filtro]++;
            continue;
        }
        
        // Validar filtro posicional se ativado
        if (usarPosicional) {
            // Contar quantas sorteadas são top posicional
            var qtdTopPosSort = sortSelecionadas.filter(function(n) {
                return topPosSorteadas.indexOf(n) > -1;
            }).length;
            
            // Contar quantas ausentes são top posicional
            var qtdTopPosAus = ausSelecionadas.filter(function(n) {
                return topPosAusentes.indexOf(n) > -1;
            }).length;
            
            if (qtdTopPosSort < minPosSort || qtdTopPosAus < minPosAus) {
                diagnostico.filtroPosicional++;
                continue;
            }
        }
        
        jogosSet[key] = true;
        mesclagemData.jogosGerados.push({
            n: jogo,
            qtdSort: qtdSort,
            qtdAus: qtdAus,
            topPosSort: usarPosicional ? sortSelecionadas.filter(function(n) { return topPosSorteadas.indexOf(n) > -1; }).length : 0,
            topPosAus: usarPosicional ? ausSelecionadas.filter(function(n) { return topPosAusentes.indexOf(n) > -1; }).length : 0
        });
    }
    
    if (mesclagemData.jogosGerados.length < qtdJogos) {
        // Mostrar diagnóstico detalhado
        var msgDiag = 'Gerados ' + mesclagemData.jogosGerados.length + '/' + qtdJogos + '. Filtros bloqueando:\n';
        if (diagnostico.filtroPares > 0) msgDiag += '• Pares: ' + diagnostico.filtroPares + '\n';
        if (diagnostico.filtroPrimos > 0) msgDiag += '• Primos: ' + diagnostico.filtroPrimos + '\n';
        if (diagnostico.filtroFibo > 0) msgDiag += '• Fibonacci: ' + diagnostico.filtroFibo + '\n';
        if (diagnostico.filtroMoldura > 0) msgDiag += '• Moldura: ' + diagnostico.filtroMoldura + '\n';
        if (diagnostico.filtroSoma > 0) msgDiag += '• Soma: ' + diagnostico.filtroSoma + '\n';
        if (diagnostico.filtroMult3 > 0) msgDiag += '• Múltiplos 3: ' + diagnostico.filtroMult3 + '\n';
        if (diagnostico.filtroSeq > 0) msgDiag += '• Sequências: ' + diagnostico.filtroSeq + '\n';
        if (diagnostico.filtroSalto > 0) msgDiag += '• Salto: ' + diagnostico.filtroSalto + '\n';
        if (diagnostico.filtroPosicional > 0) msgDiag += '• Posicional: ' + diagnostico.filtroPosicional + '\n';
        if (diagnostico.duplicatas > 0) msgDiag += '• Duplicatas: ' + diagnostico.duplicatas + '\n';
        
        mostrarDiagnosticoMesclagem(diagnostico, tentativas);
        toast('Ajuste os filtros! Veja diagnóstico abaixo.', true);
    } else {
        toast(qtdJogos + ' jogos gerados com sucesso!');
        document.getElementById('mesclaDiagnostico').innerHTML = '';
    }
    
    renderMesclagemResultado(baseDesd);
}

function validarMesclagemJogoComDiagnostico(jogo) {
    var minPar = parseInt(document.getElementById('mesclaMinPar').value);
    var maxPar = parseInt(document.getElementById('mesclaMaxPar').value);
    var minPrimo = parseInt(document.getElementById('mesclaMinPrimo').value);
    var maxPrimo = parseInt(document.getElementById('mesclaMaxPrimo').value);
    var minFibo = parseInt(document.getElementById('mesclaMinFibo').value);
    var maxFibo = parseInt(document.getElementById('mesclaMaxFibo').value);
    var minMold = parseInt(document.getElementById('mesclaMinMold').value);
    var maxMold = parseInt(document.getElementById('mesclaMaxMold').value);
    var minSoma = parseInt(document.getElementById('mesclaMinSoma').value);
    var maxSoma = parseInt(document.getElementById('mesclaMaxSoma').value);
    var minMult3 = parseInt(document.getElementById('mesclaMinMult3').value);
    var maxMult3 = parseInt(document.getElementById('mesclaMaxMult3').value);
    var minSeq = parseInt(document.getElementById('mesclaMinSeq').value);
    var maxSeq = parseInt(document.getElementById('mesclaMaxSeq').value);
    var maxSalto = parseInt(document.getElementById('mesclaMaxSalto').value);
    
    // Pares
    var pares = jogo.filter(function(n) { return n % 2 === 0; }).length;
    if (pares < minPar || pares > maxPar) return { valido: false, filtro: 'filtroPares', valor: pares, min: minPar, max: maxPar };
    
    // Primos
    var primos = jogo.filter(function(n) { return PRIMOS.indexOf(n) > -1; }).length;
    if (primos < minPrimo || primos > maxPrimo) return { valido: false, filtro: 'filtroPrimos', valor: primos, min: minPrimo, max: maxPrimo };
    
    // Fibonacci
    var fibo = jogo.filter(function(n) { return FIBONACCI.indexOf(n) > -1; }).length;
    if (fibo < minFibo || fibo > maxFibo) return { valido: false, filtro: 'filtroFibo', valor: fibo, min: minFibo, max: maxFibo };
    
    // Moldura
    var mold = jogo.filter(function(n) { return MOLDURA.indexOf(n) > -1; }).length;
    if (mold < minMold || mold > maxMold) return { valido: false, filtro: 'filtroMoldura', valor: mold, min: minMold, max: maxMold };
    
    // Soma
    var soma = jogo.reduce(function(a,b) { return a+b; }, 0);
    if (soma < minSoma || soma > maxSoma) return { valido: false, filtro: 'filtroSoma', valor: soma, min: minSoma, max: maxSoma };
    
    // Múltiplos de 3
    var mult3 = jogo.filter(function(n) { return MULTIPLOS3.indexOf(n) > -1; }).length;
    if (mult3 < minMult3 || mult3 > maxMult3) return { valido: false, filtro: 'filtroMult3', valor: mult3, min: minMult3, max: maxMult3 };
    
    // Sequências
    var sorted = jogo.slice().sort(function(a,b) { return a-b; });
    var seq = 0;
    for (var i = 1; i < sorted.length; i++) {
        if (sorted[i] === sorted[i-1] + 1) seq++;
    }
    if (seq < minSeq || seq > maxSeq) return { valido: false, filtro: 'filtroSeq', valor: seq, min: minSeq, max: maxSeq };
    
    // Salto máximo
    for (var i = 1; i < sorted.length; i++) {
        if (sorted[i] - sorted[i-1] > maxSalto) return { valido: false, filtro: 'filtroSalto', valor: sorted[i] - sorted[i-1], max: maxSalto };
    }
    
    return { valido: true };
}

function mostrarDiagnosticoMesclagem(diag, tentativas) {
    // Guardar diagnóstico para uso posterior
    mesclagemData.ultimoDiagnostico = diag;
    
    var html = '<div class="card" style="margin-top:1rem; border: 2px solid #f97316; background: linear-gradient(135deg, #451a03, #7c2d12);">';
    html += '<div class="card-title" style="color:#f97316;">⚠️ Diagnóstico de Filtros (' + tentativas + ' tentativas)</div>';
    html += '<p style="color:#fed7aa;font-size:0.85rem;margin-bottom:1rem;">Os filtros estão muito restritivos. Veja quais estão bloqueando mais jogos:</p>';
    
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:0.75rem;">';
    
    var filtros = [
        { key: 'filtroPares', nome: 'Pares', icone: '🔢' },
        { key: 'filtroPrimos', nome: 'Primos', icone: '🔷' },
        { key: 'filtroFibo', nome: 'Fibonacci', icone: '🌀' },
        { key: 'filtroMoldura', nome: 'Moldura', icone: '🖼️' },
        { key: 'filtroSoma', nome: 'Soma', icone: '➕' },
        { key: 'filtroMult3', nome: 'Múltiplos 3', icone: '3️⃣' },
        { key: 'filtroSeq', nome: 'Sequências', icone: '📈' },
        { key: 'filtroSalto', nome: 'Salto Máx.', icone: '⏭️' },
        { key: 'filtroPosicional', nome: 'Posicional', icone: '📍' },
        { key: 'duplicatas', nome: 'Duplicatas', icone: '♻️' }
    ];
    
    // Ordenar por quantidade de bloqueios
    filtros.sort(function(a, b) { return diag[b.key] - diag[a.key]; });
    
    filtros.forEach(function(f) {
        var qtd = diag[f.key];
        var cor = qtd > 1000 ? '#ef4444' : (qtd > 100 ? '#f97316' : (qtd > 0 ? '#eab308' : '#22c55e'));
        var intensidade = qtd > 1000 ? 'CRÍTICO' : (qtd > 100 ? 'ALTO' : (qtd > 0 ? 'BAIXO' : 'OK'));
        
        html += '<div style="background:#0f172a;border-radius:8px;padding:0.75rem;text-align:center;border:1px solid ' + cor + ';">';
        html += '<div style="font-size:1.5rem;">' + f.icone + '</div>';
        html += '<div style="font-size:0.8rem;color:#94a3b8;">' + f.nome + '</div>';
        html += '<div style="font-size:1.1rem;font-weight:700;color:' + cor + ';">' + qtd.toLocaleString('pt-BR') + '</div>';
        html += '<div style="font-size:0.65rem;color:' + cor + ';">' + intensidade + '</div>';
        html += '</div>';
    });
    
    html += '</div>';
    
    // Botão de correção automática
    html += '<div style="margin-top:1rem;text-align:center;">';
    html += '<button class="btn btn-p" onclick="corrigirFiltrosAutomaticamente()" style="font-size:1rem;padding:0.75rem 2rem;">';
    html += '🔧 Corrigir Filtros Automaticamente</button>';
    html += '<p style="color:#94a3b8;font-size:0.75rem;margin-top:0.5rem;">Ajusta os filtros problemáticos para valores mais flexíveis</p>';
    html += '</div>';
    
    html += '<div style="margin-top:1rem;padding:0.75rem;background:#0f172a;border-radius:8px;">';
    html += '<div style="font-size:0.85rem;color:#f1f5f9;font-weight:600;margin-bottom:0.5rem;">💡 Filtros que serão ajustados:</div>';
    html += '<ul style="font-size:0.8rem;color:#94a3b8;margin:0;padding-left:1.25rem;">';
    
    if (diag.filtroSeq > 100) html += '<li><strong>Sequências:</strong> 0 a 7</li>';
    if (diag.filtroPrimos > 100) html += '<li><strong>Primos:</strong> 2 a 7</li>';
    if (diag.filtroFibo > 100) html += '<li><strong>Fibonacci:</strong> 2 a 6</li>';
    if (diag.filtroMoldura > 100) html += '<li><strong>Moldura:</strong> 7 a 13</li>';
    if (diag.filtroSoma > 100) html += '<li><strong>Soma:</strong> 160 a 230</li>';
    if (diag.filtroPares > 100) html += '<li><strong>Pares:</strong> 5 a 10</li>';
    if (diag.filtroMult3 > 100) html += '<li><strong>Múltiplos 3:</strong> 2 a 7</li>';
    if (diag.filtroSalto > 100) html += '<li><strong>Salto Máximo:</strong> 8</li>';
    if (diag.filtroPosicional > 100) html += '<li><strong>Posicional:</strong> Sorteadas 0, Ausentes 0</li>';
    
    html += '</ul></div>';
    
    ht= 7;= '</div>';
    
    document.getElementById('mesclaDiagnostico').innerHTML = html;
}

function corrigirFiltrosAutomaticamente() {
    var diag = mesclagemData.ultimoDiagnostico;
    if (!diag) {
        toast('Execute a geração primeiro para diagnosticar!', true);
        return;
    }
    
    var ajustes = [];
    
    // Ajustar cada filtro problemático
    if (diag.filtroSeq > 100) {
        document.getElementById('mesclaMinSeq').value = 0;
        document.getElementById('mesclaMaxSeq').value = 7;
        ajustes.push('Sequências');
    }
    
    if (diag.filtroPrimos > 100) {
        document.getElementById('mesclaMinPrimo').value = 2;
        document.getElementById('mesclaMaxPrimo').value = 7;
        ajustes.push('Primos');
    }
    
    if (diag.filtroFibo > 100) {
        document.getElementById('mesclaMinFibo').value = 2;
        document.getElementById('mesclaMaxFibo').value = 6;
        ajustes.push('Fibonacci');
    }
    
    if (diag.filtroMoldura > 100) {
        document.getElementById('mesclaMinMold').value = 7;
        document.getElementById('mesclaMaxMold').value = 13;
        ajustes.push('Moldura');
    }
    
    if (diag.filtroSoma > 100) {
        document.getElementById('mesclaMinSoma').value = 160;
        document.getElementById('mesclaMaxSoma').value = 230;
        ajustes.push('Soma');
    }
    
    if (diag.filtroPares > 100) {
        document.getElementById('mesclaMinPar').value = 5;
        document.getElementById('mesclaMaxPar').value = 10;
        ajustes.push('Pares');
    }
    
    if (diag.filtroMult3 > 100) {
        document.getElementById('mesclaMinMult3').value = 2;
        document.getElementById('mesclaMaxMult3').value = 7;
        ajustes.push('Múltiplos 3');
    }
    
    if (diag.filtroSalto > 100) {
        document.getElementById('mesclaMaxSalto').value = 8;
        ajustes.push('Salto Máximo');
    }
    
    if (diag.filtroPosicional > 100) {
        document.getElementById('mesclaMinPosSort').value = 0;
        document.getElementById('mesclaMinPosAus').value = 0;
        ajustes.push('Posicional');
    }
    
    // Limpar diagnóstico
    document.getElementById('mesclaDiagnostico').innerHTML = '';
    
    if (ajustes.length > 0) {
        toast('✅ Ajustados: ' + ajustes.join(', '));
        
        // Gerar automaticamente após ajuste
        setTimeout(function() {
            gerarMesclagem();
        }, 500);
    } else {
        toast('Nenhum filtro precisou de ajuste', true);
    }
}

function weightedShuffle(arr) {
    var result = [];
    var temp = arr.slice();
    
    while (temp.length > 0) {
        // Peso maior para os primeiros índices
        var weights = temp.map(function(_, i) { return Math.pow(temp.length - i, 2); });
        var totalWeight = weights.reduce(function(a,b) { return a+b; }, 0);
        var random = Math.random() * totalWeight;
        
        var cumulative = 0;
        for (var i = 0; i < temp.length; i++) {
            cumulative += weights[i];
            if (random <= cumulative) {
                result.push(temp.splice(i, 1)[0]);
                break;
            }
        }
    }
    
    return result;
}

function shuffleArray(arr) {
    for (var i = arr.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = arr[i];
        arr[i] = arr[j];
        arr[j] = temp;
    }
}

function renderMesclagemResultado(baseDesd) {
    if (!mesclagemData.jogosGerados.length) {
        document.getElementById('mesclaResultado').innerHTML = '';
        return;
    }
    
    var usarPosicional = document.getElementById('mesclaUsarPosicional').checked;
    
    var html = '<div class="card" style="margin-top:1rem;">';
    html += '<div class="card-title">🎲 Jogos Gerados (' + mesclagemData.jogosGerados.length + ')</div>';
    
    // Botões de ação
    html += '<div class="btns" style="margin-bottom:1rem;">';
    html += '<button class="btn btn-s" onclick="salvarMesclagemTodos()">💾 Salvar Todos</button>';
    html += '<button class="btn btn-w" onclick="exportMesclagemExcel()">📊 Excel</button>';
    html += '<button class="btn btn-a" onclick="exportMesclagemTxt()">📄 TXT</button>';
    if (baseDesd > 0) {
        html += '<button class="btn btn-p" onclick="enviarParaDesdobramento()">🎯 Enviar para Desdobramento</button>';
    }
    html += '</div>';
    
    // Lista de jogos
    mesclagemData.jogosGerados.forEach(function(j, idx) {
        var p = j.n.filter(function(x) { return x % 2 === 0; }).length;
        var pr = j.n.filter(function(x) { return PRIMOS.indexOf(x) > -1; }).length;
        var m = j.n.filter(function(x) { return MOLDURA.indexOf(x) > -1; }).length;
        var s = j.n.reduce(function(a,b) { return a+b; }, 0);
        var csn = calcularCSN(j.n);
        
        html += '<div class="jogo">';
        html += '<div class="jogo-h"><span>Jogo ' + (idx + 1) + ' <small style="color:#64748b;">(' + j.qtdSort + ' sort. + ' + j.qtdAus + ' aus.';
        if (usarPosicional && (j.topPosSort > 0 || j.topPosAus > 0)) {
            html += ' | 📍' + j.topPosSort + '+' + j.topPosAus + ' top pos.';
        }
        html += ')</small></span>';
        html += '<span>P:' + p + ' Pr:' + pr + ' M:' + m + ' Σ:' + s + '</span></div>';
        html += '<div class="jogo-csn">CSN: ' + csn.toLocaleString('pt-BR') + '</div>';
        html += '<div class="jogo-n">';
        
        // Obter top posicionais para destacar
        var topPosSorteadas = mesclagemData.sortPosRank ? mesclagemData.sortPosRank.slice(0, 8) : [];
        var topPosAusentes = mesclagemData.ausPosRank ? mesclagemData.ausPosRank.slice(0, 5) : [];
        
        j.n.forEach(function(n) {
            var isSorteada = mesclagemData.sorteadas.indexOf(n) > -1;
            var isTopPos = usarPosicional && (topPosSorteadas.indexOf(n) > -1 || topPosAusentes.indexOf(n) > -1);
            var classe = isSorteada ? 'hit' : '';
            var style = isTopPos ? 'box-shadow:0 0 0 2px #f59e0b;' : '';
            var title = (isSorteada ? 'Sorteada' : 'Ausente') + (isTopPos ? ' | ⭐ Top Posicional' : '');
            html += '<div class="jn ' + classe + '" style="' + style + '" title="' + title + '">' + (n < 10 ? '0' + n : n) + '</div>';
        });
        
        html += '</div>';
        html += '<div class="jogo-f">';
        html += '<button class="btn btn-s btn-sm" onclick="salvarMesclagemUm(' + idx + ')">💾</button>';
        html += '</div></div>';
    });
    
    html += '</div>';
    document.getElementById('mesclaResultado').innerHTML = html;
}

function salvarMesclagemUm(idx) {
    var j = mesclagemData.jogosGerados[idx];
    DATA.saved.push({
        id: Date.now(),
        n: j.n.slice(),
        dt: new Date().toLocaleDateString('pt-BR'),
        tipo: 'mesclagem'
    });
    save();
    updateSavedUI();
    toast('Jogo salvo!');
}

function salvarMesclagemTodos() {
    mesclagemData.jogosGerados.forEach(function(j, idx) {
        DATA.saved.push({
            id: Date.now() + idx,
            n: j.n.slice(),
            dt: new Date().toLocaleDateString('pt-BR'),
            tipo: 'mesclagem'
        });
    });
    save();
    updateSavedUI();
    toast(mesclagemData.jogosGerados.length + ' jogos salvos!');
}

function exportMesclagemExcel() {
    if (mesclagemData.jogosGerados.length) {
        var jogos = mesclagemData.jogosGerados.map(function(j) { return j.n; });
        exportExcel(jogos, 'lotofacil-mesclagem.xlsx');
    }
}

function exportMesclagemTxt() {
    if (mesclagemData.jogosGerados.length) {
        var jogos = mesclagemData.jogosGerados.map(function(j) { return j.n; });
        exportTxt(jogos, 'lotofacil-mesclagem.txt');
    }
}

function enviarParaDesdobramento() {
    // Criar base para desdobramento combinando todos os números usados
    var todosNums = {};
    mesclagemData.jogosGerados.forEach(function(j) {
        j.n.forEach(function(n) { todosNums[n] = true; });
    });
    
    var base = Object.keys(todosNums).map(function(n) { return parseInt(n); }).sort(function(a,b) { return a-b; });
    
    // Ir para aba de desdobramento e preencher
    showSection('desd');
    
    // Selecionar as dezenas na grid
    DATA.dsel = base;
    var btns = document.querySelectorAll('#desdGrid .numbtn');
    btns.forEach(function(btn) {
        var n = parseInt(btn.getAttribute('data-n'));
        if (base.indexOf(n) > -1) {
            btn.classList.add('sel');
        } else {
            btn.classList.remove('sel');
        }
    });
    
    toast(base.length + ' dezenas enviadas para Desdobramento!');
}

function validate(g) {
    var minP = parseInt(document.getElementById('minPar').value);
    var maxP = parseInt(document.getElementById('maxPar').value);
    var minPr = parseInt(document.getElementById('minPri').value);
    var maxPr = parseInt(document.getElementById('maxPri').value);
    var minS = parseInt(document.getElementById('minSoma').value);
    var maxS = parseInt(document.getElementById('maxSoma').value);
    var minM = parseInt(document.getElementById('minMold').value);
    var maxM = parseInt(document.getElementById('maxMold').value);
    var maxSq = parseInt(document.getElementById('maxSeq').value);
    var repU = parseInt(document.getElementById('repUlt').value);
    
    var p = g.filter(function(x) { return x % 2 === 0; }).length;
    if (p < minP || p > maxP) return false;
    
    var pr = g.filter(function(x) { return PRIMOS.indexOf(x) > -1; }).length;
    if (pr < minPr || pr > maxPr) return false;
    
    var s = g.reduce(function(a, b) { return a + b; }, 0);
    if (s < minS || s > maxS) return false;
    
    var m = g.filter(function(x) { return MOLDURA.indexOf(x) > -1; }).length;
    if (m < minM || m > maxM) return false;
    
    var sorted = g.slice().sort(function(a, b) { return a - b; });
    var mxC = 1, cur = 1;
    for (var i = 1; i < sorted.length; i++) {
        if (sorted[i] === sorted[i - 1] + 1) { cur++; mxC = Math.max(mxC, cur); }
        else cur = 1;
    }
    if (mxC > maxSq) return false;
    
    if (repU > 0 && DATA.last) {
        var rep = g.filter(function(x) { return DATA.last.n.indexOf(x) > -1; }).length;
        if (rep < repU) return false;
    }
    
    return true;
}

function generate() {
    var qtd = parseInt(document.getElementById('gQtd').value);
    var dez = parseInt(document.getElementById('gDez').value);
    var useFix = document.getElementById('useFix').checked;
    
    DATA.gen = [];
    var att = 0;
    var fx = useFix ? DATA.fix : [];
    var ex = useFix ? DATA.exc : [];
    
    if (fx.length >= dez) { toast('Muitos fixos!', true); return; }
    
    while (DATA.gen.length < qtd && att < qtd * 1000) {
        att++;
        var g = fx.slice();
        var av = [];
        for (var i = 1; i <= 25; i++) {
            if (fx.indexOf(i) === -1 && ex.indexOf(i) === -1) av.push(i);
        }
        while (g.length < dez && av.length > 0) {
            var idx = Math.floor(Math.random() * av.length);
            g.push(av.splice(idx, 1)[0]);
        }
        g.sort(function(a, b) { return a - b; });
        
        if (validate(g)) {
            var gStr = g.join(',');
            var dup = DATA.gen.some(function(x) { return x.join(',') === gStr; });
            if (!dup) DATA.gen.push(g);
        }
    }
    
    if (DATA.gen.length < qtd) toast('Gerados ' + DATA.gen.length + '/' + qtd + '. Ajuste filtros.', true);
    else toast(DATA.gen.length + ' jogos gerados!');
    showGen();
}

function showGen() {
    var el = document.getElementById('genList');
    var btns = document.getElementById('genBtns');
    
    if (DATA.gen.length === 0) {
        el.innerHTML = '<div class="empty"><div class="empty-i">🎲</div><p>Nenhum jogo</p></div>';
        btns.classList.add('hidden');
        return;
    }
    
    btns.classList.remove('hidden');
    var html = '';
    DATA.gen.forEach(function(g, idx) {
        var p = g.filter(function(x) { return x % 2 === 0; }).length;
        var pr = g.filter(function(x) { return PRIMOS.indexOf(x) > -1; }).length;
        var s = g.reduce(function(a, b) { return a + b; }, 0);
        var m = g.filter(function(x) { return MOLDURA.indexOf(x) > -1; }).length;
        html += '<div class="jogo"><div class="jogo-h"><span>Jogo ' + (idx + 1) + '</span><span>P:' + p + ' Pr:' + pr + ' M:' + m + ' Σ:' + s + '</span></div><div class="jogo-n">';
        g.forEach(function(x) { html += '<div class="jn">' + (x < 10 ? '0' + x : x) + '</div>'; });
        html += '</div><div class="jogo-f"><button class="btn btn-s btn-sm" onclick="saveOne(' + idx + ')">💾</button></div></div>';
    });
    el.innerHTML = html;
}

function saveManual() {
    var all = DATA.sel.concat(DATA.fix);
    if (all.length < 15) { toast('Mín 15 números!', true); return; }
    all.sort(function(a, b) { return a - b; });
    DATA.saved.push({ id: Date.now(), n: all, dt: new Date().toLocaleDateString('pt-BR') });
    save();
    updateSavedUI();
    clearSel();
    toast('Salvo!');
}

function saveOne(idx) {
    DATA.saved.push({ id: Date.now() + idx, n: DATA.gen[idx].slice(), dt: new Date().toLocaleDateString('pt-BR') });
    save();
    updateSavedUI();
    toast('Salvo!');
}

function saveAllGen() {
    DATA.gen.forEach(function(g, idx) {
        DATA.saved.push({ id: Date.now() + idx, n: g.slice(), dt: new Date().toLocaleDateString('pt-BR') });
    });
    save();
    updateSavedUI();
    toast(DATA.gen.length + ' salvos!');
}

function clearGen() { DATA.gen = []; showGen(); }

// GERAÇÃO POSICIONAL AVANÇADA
function calcPosFrequencias(range) {
    var concursos = DATA.all.slice(0, range);
    if (concursos.length < 5) return null;
    
    var freqPorPos = [];
    for (var pos = 0; pos < 15; pos++) {
        var freq = {};
        for (var n = 1; n <= 25; n++) freq[n] = 0;
        
        concursos.forEach(function(r) {
            if (r.n && r.n[pos]) {
                freq[r.n[pos]]++;
            }
        });
        
        freqPorPos.push(freq);
    }
    
    return freqPorPos;
}

function calcNumerosQuentes(range) {
    var concursos = DATA.all.slice(0, range);
    var freq = {};
    for (var n = 1; n <= 25; n++) freq[n] = 0;
    
    concursos.forEach(function(r) {
        r.n.forEach(function(num) { freq[num]++; });
    });
    
    var sorted = Object.keys(freq).map(function(n) {
        return { n: parseInt(n), f: freq[n] };
    }).sort(function(a, b) { return b.f - a.f; });
    
    return sorted.slice(0, 10).map(function(x) { return x.n; });
}

function calcNumerosFrios(freqPorPos) {
    var frios = [];
    for (var n = 1; n <= 25; n++) {
        var totalFreq = 0;
        freqPorPos.forEach(function(freq) { totalFreq += freq[n] || 0; });
        if (totalFreq === 0) frios.push(n);
    }
    return frios;
}

function sortearComPeso(freq, excluir, intensidade, pesoRegiao) {
    var itens = [];
    var totalPeso = 0;
    
    for (var n = 1; n <= 25; n++) {
        if (excluir.indexOf(n) > -1) continue;
        
        var peso = freq[n] || 0;
        if (peso === 0) peso = 0.1;
        
        // Aplicar intensidade
        if (intensidade === 'leve') {
            peso = Math.sqrt(peso);
        } else if (intensidade === 'forte') {
            peso = peso * peso;
        }
        
        // Aplicar peso da região
        peso *= pesoRegiao;
        
        totalPeso += peso;
        itens.push({ n: n, peso: peso, acumulado: totalPeso });
    }
    
    if (itens.length === 0) return null;
    
    var sorteio = Math.random() * totalPeso;
    for (var i = 0; i < itens.length; i++) {
        if (sorteio <= itens[i].acumulado) {
            return itens[i].n;
        }
    }
    
    return itens[itens.length - 1].n;
}

function getPesoRegiao(pos, pesoIni, pesoMeio, pesoFim) {
    if (pos < 5) return pesoIni;
    if (pos < 10) return pesoMeio;
    return pesoFim;
}

function gerarJogoPosicional(freqPorPos, config) {
    var jogo = config.fixos.slice();
    var usados = config.fixos.slice().concat(config.excluidos);
    
    // Determinar quais posições usar estatística
    var posicoesEstat = [];
    for (var i = 0; i < config.numPosEstat; i++) {
        posicoesEstat.push(i);
    }
    
    // Para cada posição
    for (var pos = 0; pos < 15 && jogo.length < 15; pos++) {
        var num = null;
        
        if (posicoesEstat.indexOf(pos) > -1) {
            // Usar estatística
            var freq = freqPorPos[pos];
            var pesoRegiao = getPesoRegiao(pos, config.pesoIni, config.pesoMeio, config.pesoFim);
            num = sortearComPeso(freq, usados, config.intensidade, pesoRegiao);
        } else {
            // Aleatório
            var disponivel = [];
            for (var n = 1; n <= 25; n++) {
                if (usados.indexOf(n) === -1) disponivel.push(n);
            }
            if (disponivel.length > 0) {
                num = disponivel[Math.floor(Math.random() * disponivel.length)];
            }
        }
        
        if (num !== null) {
            jogo.push(num);
            usados.push(num);
        }
    }
    
    // Completar se necessário
    while (jogo.length < 15) {
        var disponivel = [];
        for (var n = 1; n <= 25; n++) {
            if (usados.indexOf(n) === -1) disponivel.push(n);
        }
        if (disponivel.length === 0) break;
        var num = disponivel[Math.floor(Math.random() * disponivel.length)];
        jogo.push(num);
        usados.push(num);
    }
    
    return jogo.sort(function(a, b) { return a - b; });
}

function validarJogoPosicional(jogo, config, quentes) {
    // Validar filtros gerais
    if (config.validarGeral && !validate(jogo)) return false;
    
    // Mínimo de números quentes
    if (config.minQuentes > 0) {
        var qtdQuentes = jogo.filter(function(n) { return quentes.indexOf(n) > -1; }).length;
        if (qtdQuentes < config.minQuentes) return false;
    }
    
    // Máximo salto
    if (config.maxSalto > 0) {
        for (var i = 1; i < jogo.length; i++) {
            if (jogo[i] - jogo[i-1] > config.maxSalto) return false;
        }
    }
    
    // Balanceamento por região
    var inicio = jogo.filter(function(n) { return n >= 1 && n <= 8; }).length;
    var meio = jogo.filter(function(n) { return n >= 9 && n <= 17; }).length;
    var fim = jogo.filter(function(n) { return n >= 18 && n <= 25; }).length;
    
    if (config.minIni > 0 && inicio < config.minIni) return false;
    if (config.minMeio > 0 && meio < config.minMeio) return false;
    if (config.minFim > 0 && fim < config.minFim) return false;
    
    return true;
}

function calcScorePosicional(jogo, freqPorPos, range) {
    var totalScore = 0;
    var maxScore = 0;
    
    jogo.forEach(function(num, idx) {
        var freq = freqPorPos[idx];
        var freqNum = freq[num] || 0;
        
        // Encontrar máxima frequência nessa posição
        var maxFreq = 0;
        for (var n = 1; n <= 25; n++) {
            if (freq[n] > maxFreq) maxFreq = freq[n];
        }
        
        totalScore += freqNum;
        maxScore += maxFreq;
    });
    
    return maxScore > 0 ? Math.round((totalScore / maxScore) * 100) : 0;
}

function simularAcertos(jogo, range) {
    var concursos = DATA.all.slice(0, range);
    var acertos = [];
    var premios = 0;
    
    concursos.forEach(function(r) {
        var ac = jogo.filter(function(n) { return r.n.indexOf(n) > -1; }).length;
        acertos.push(ac);
        if (ac >= 11) premios++;
    });
    
    var soma = acertos.reduce(function(a, b) { return a + b; }, 0);
    var media = acertos.length > 0 ? (soma / acertos.length).toFixed(1) : 0;
    var melhor = Math.max.apply(null, acertos);
    var pior = Math.min.apply(null, acertos);
    
    return {
        media: media,
        melhor: melhor,
        pior: pior,
        premios: premios,
        total: acertos.length
    };
}

function generatePosicional() {
    var range = parseInt(document.getElementById('gPosRange').value);
    var freqPorPos = calcPosFrequencias(range);
    
    if (!freqPorPos) {
        toast('Dados insuficientes!', true);
        return;
    }
    
    var quentes = calcNumerosQuentes(range);
    var frios = calcNumerosFrios(freqPorPos);
    
    var config = {
        qtd: parseInt(document.getElementById('gPosQtd').value),
        intensidade: document.getElementById('gPosIntens').value,
        numPosEstat: parseInt(document.getElementById('gPosMix').value),
        pesoIni: parseFloat(document.getElementById('gPosPesoIni').value),
        pesoMeio: parseFloat(document.getElementById('gPosPesoMeio').value),
        pesoFim: parseFloat(document.getElementById('gPosPesoFim').value),
        minQuentes: parseInt(document.getElementById('gPosMinQuentes').value),
        maxSalto: parseInt(document.getElementById('gPosMaxSalto').value),
        minIni: parseInt(document.getElementById('gPosMinIni').value),
        minMeio: parseInt(document.getElementById('gPosMinMeio').value),
        minFim: parseInt(document.getElementById('gPosMinFim').value),
        fixos: document.getElementById('gPosUseFix').checked ? DATA.fix.slice() : [],
        excluidos: document.getElementById('gPosUseFix').checked ? DATA.exc.slice() : [],
        validarGeral: document.getElementById('gPosValidar').checked,
        evitarFrios: document.getElementById('gPosEvitarFrios').checked,
        simular: document.getElementById('gPosSimular').checked
    };
    
    // Adicionar frios aos excluídos se configurado
    if (config.evitarFrios) {
        frios.forEach(function(n) {
            if (config.excluidos.indexOf(n) === -1) {
                config.excluidos.push(n);
            }
        });
    }
    
    if (config.fixos.length >= 15) {
        toast('Muitos números fixos!', true);
        return;
    }
    
    DATA.genPos = [];
    var tentativas = 0;
    var maxTentativas = config.qtd * 1000;
    
    while (DATA.genPos.length < config.qtd && tentativas < maxTentativas) {
        tentativas++;
        
        var jogo = gerarJogoPosicional(freqPorPos, config);
        
        if (jogo.length < 15) continue;
        
        if (!validarJogoPosicional(jogo, config, quentes)) continue;
        
        // Verificar duplicata
        var jogoStr = jogo.join(',');
        var duplicado = DATA.genPos.some(function(j) { return j.jogo.join(',') === jogoStr; });
        if (duplicado) continue;
        
        // Calcular score e simulação
        var score = calcScorePosicional(jogo, freqPorPos, range);
        var sim = config.simular ? simularAcertos(jogo, range) : null;
        
        DATA.genPos.push({
            jogo: jogo,
            score: score,
            sim: sim
        });
    }
    
    if (DATA.genPos.length < config.qtd) {
        toast('Gerados ' + DATA.genPos.length + '/' + config.qtd + '. Ajuste filtros.', true);
    } else {
        toast(DATA.genPos.length + ' jogos posicionais gerados!');
    }
    
    // Ordenar por score
    DATA.genPos.sort(function(a, b) { return b.score - a.score; });
    
    showPosGenInfo(config, quentes, frios, range);
    showPosGen();
}

function showPosGenInfo(config, quentes, frios, range) {
    var html = '<div class="alert alert-i">';
    html += '<strong>📊 Análise da Geração</strong><br>';
    html += '<span style="font-size:0.8rem;">';
    html += '• Base: ' + range + ' concursos | ';
    html += 'Intensidade: ' + config.intensidade + '<br>';
    html += '• 🔥 Quentes (Top 10): ';
    quentes.forEach(function(n) {
        html += '<span style="background:#ef4444;color:white;padding:1px 5px;border-radius:3px;margin:1px;font-size:0.7rem;">' + (n < 10 ? '0' + n : n) + '</span>';
    });
    if (frios.length > 0) {
        html += '<br>• ❄️ Frios (freq. zero): ';
        frios.forEach(function(n) {
            html += '<span style="background:#6366f1;color:white;padding:1px 5px;border-radius:3px;margin:1px;font-size:0.7rem;">' + (n < 10 ? '0' + n : n) + '</span>';
        });
    }
    html += '</span></div>';
    
    document.getElementById('posGenInfo').innerHTML = html;
}

function showPosGen() {
    var el = document.getElementById('posGenList');
    var btns = document.getElementById('posGenBtns');
    
    if (DATA.genPos.length === 0) {
        el.innerHTML = '';
        btns.classList.add('hidden');
        return;
    }
    
    btns.classList.remove('hidden');
    var html = '';
    DATA.genPos.forEach(function(item, idx) {
        var g = item.jogo;
        var p = g.filter(function(x) { return x % 2 === 0; }).length;
        var pr = g.filter(function(x) { return PRIMOS.indexOf(x) > -1; }).length;
        var s = g.reduce(function(a, b) { return a + b; }, 0);
        var m = g.filter(function(x) { return MOLDURA.indexOf(x) > -1; }).length;
        
        // Cor do score
        var scoreColor = item.score >= 70 ? '#22c55e' : (item.score >= 50 ? '#f59e0b' : '#ef4444');
        
        html += '<div class="jogo">';
        html += '<div class="jogo-h">';
        html += '<span>Jogo ' + (idx + 1) + ' <span style="background:' + scoreColor + ';color:white;padding:2px 6px;border-radius:4px;font-size:0.7rem;">Score: ' + item.score + '%</span></span>';
        html += '<span>P:' + p + ' Pr:' + pr + ' M:' + m + ' Σ:' + s + '</span>';
        html += '</div>';
        html += '<div class="jogo-n">';
        g.forEach(function(x) { html += '<div class="jn">' + (x < 10 ? '0' + x : x) + '</div>'; });
        html += '</div>';
        
        // Simulação
        if (item.sim) {
            var simColor = item.sim.premios > 0 ? '#22c55e' : '#64748b';
            html += '<div style="margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid #334155;font-size:0.75rem;color:#94a3b8;">';
            html += '📈 Simulação: Média <strong>' + item.sim.media + '</strong> pts | ';
            html += 'Melhor <strong style="color:#22c55e;">' + item.sim.melhor + '</strong> | ';
            html += 'Pior <strong style="color:#ef4444;">' + item.sim.pior + '</strong> | ';
            html += 'Prêmios <strong style="color:' + simColor + ';">' + item.sim.premios + '/' + item.sim.total + '</strong>';
            html += '</div>';
        }
        
        html += '<div class="jogo-f"><button class="btn btn-s btn-sm" onclick="savePosOne(' + idx + ')">💾</button></div>';
        html += '</div>';
    });
    el.innerHTML = html;
}

function savePosOne(idx) {
    var item = DATA.genPos[idx];
    DATA.saved.push({ 
        id: Date.now() + idx, 
        n: item.jogo.slice(), 
        dt: new Date().toLocaleDateString('pt-BR'), 
        tipo: 'posicional',
        score: item.score
    });
    save();
    updateSavedUI();
    toast('Salvo!');
}

function saveAllPosGen() {
    DATA.genPos.forEach(function(item, idx) {
        DATA.saved.push({ 
            id: Date.now() + idx, 
            n: item.jogo.slice(), 
            dt: new Date().toLocaleDateString('pt-BR'), 
            tipo: 'posicional',
            score: item.score
        });
    });
    save();
    updateSavedUI();
    toast(DATA.genPos.length + ' salvos!');
}

function clearPosGen() { 
    DATA.genPos = []; 
    document.getElementById('posGenInfo').innerHTML = '';
    showPosGen(); 
}

function exportPosGenExcel() { 
    if (DATA.genPos.length) {
        var jogos = DATA.genPos.map(function(item) { return item.jogo; });
        exportExcel(jogos, 'lotofacil-posicional.xlsx'); 
    } else {
        toast('Sem jogos!', true); 
    }
}

function exportPosGenTxt() { 
    if (DATA.genPos.length) {
        var jogos = DATA.genPos.map(function(item) { return item.jogo; });
        exportTxt(jogos, 'lotofacil-posicional.txt'); 
    } else {
        toast('Sem jogos!', true); 
    }
}

function initDesd() {
    filtrarDesd();
}

function filtrarDesd() {
    var filtroDez = parseInt(document.getElementById('filtroDesd').value);
    var filtroGar = parseInt(document.getElementById('filtroGarantia').value);
    var filtroJog = parseInt(document.getElementById('filtroJogos').value);
    var filtroOrd = document.getElementById('filtroOrdem').value;
    
    var lista = DESD.filter(function(d) {
        if (filtroDez > 0 && d.d !== filtroDez) return false;
        if (filtroGar > 0) {
            var gar = parseInt(d.g.split('pts')[0]);
            if (gar < filtroGar) return false;
        }
        if (filtroJog > 0 && d.j > filtroJog) return false;
        return true;
    });
    
    // Ordenar
    lista.sort(function(a, b) {
        if (filtroOrd === 'dezenas') return a.d - b.d || a.j - b.j;
        if (filtroOrd === 'jogos') return a.j - b.j;
        if (filtroOrd === 'garantia') {
            var gA = parseInt(a.g.split('pts')[0]);
            var gB = parseInt(b.g.split('pts')[0]);
            return gB - gA || a.j - b.j;
        }
        if (filtroOrd === 'custo') return (a.j * VALOR_JOGO) - (b.j * VALOR_JOGO);
        return 0;
    });
    
    document.getElementById('desdCount').textContent = 'Exibindo ' + lista.length + ' de ' + DESD.length + ' matrizes';
    
    var html = '';
    lista.forEach(function(d) {
        var custo = (d.j * VALOR_JOGO).toFixed(2);
        var garantia = parseInt(d.g.split('pts')[0]);
        var corGarantia = garantia >= 14 ? '#22c55e' : (garantia >= 12 ? '#f59e0b' : '#6366f1');
        
        html += '<div class="ditem" onclick="selDesd(' + d.id + ')">';
        html += '<div class="dtitle">' + d.n + '</div>';
        html += '<div class="ddesc" style="color:' + corGarantia + ';">' + d.g + '</div>';
        html += '<div class="djogos">' + d.j + ' jogos</div>';
        html += '<div class="dcusto">R$ ' + custo + '</div>';
        html += '</div>';
    });
    
    document.getElementById('desdList').innerHTML = html || '<div style="color:#64748b;text-align:center;padding:2rem;">Nenhuma matriz encontrada</div>';
}

function selDesd(id) {
    DATA.curDesd = DESD.find(function(d) { return d.id === id; });
    DATA.dsel = [];
    document.getElementById('desdCfg').classList.remove('hidden');
    document.getElementById('desdRes').classList.add('hidden');
    document.getElementById('desdReq').textContent = DATA.curDesd.d;
    
    var custo = (DATA.curDesd.j * VALOR_JOGO).toFixed(2);
    var garantia = parseInt(DATA.curDesd.g.split('pts')[0]);
    
    // Info box detalhado
    var infoHtml = '<div class="desd-info-row"><span class="desd-info-label">Matriz</span><span class="desd-info-value">' + DATA.curDesd.n + '</span></div>';
    infoHtml += '<div class="desd-info-row"><span class="desd-info-label">Dezenas necessárias</span><span class="desd-info-value">' + DATA.curDesd.d + '</span></div>';
    infoHtml += '<div class="desd-info-row"><span class="desd-info-label">Jogos gerados</span><span class="desd-info-value">' + DATA.curDesd.j + '</span></div>';
    infoHtml += '<div class="desd-info-row"><span class="desd-info-label">Custo total</span><span class="desd-info-value" style="color:#22c55e;">R$ ' + custo + '</span></div>';
    infoHtml += '<div class="desd-info-row"><span class="desd-info-label">Garantia</span><span class="desd-info-value" style="color:#f59e0b;">' + DATA.curDesd.g + '</span></div>';
    infoHtml += '<div class="desd-info-row"><span class="desd-info-label">Acurácia</span><span class="desd-info-value">' + DATA.curDesd.ac + '%</span></div>';
    document.getElementById('desdInfoBox').innerHTML = infoHtml;
    
    document.getElementById('desdInfo').textContent = 'Selecione ' + DATA.curDesd.d + ' dezenas para gerar ' + DATA.curDesd.j + ' jogos com garantia de ' + garantia + ' pontos.';
    
    var grid = document.getElementById('desdGrid');
    grid.innerHTML = '';
    for (var i = 1; i <= 25; i++) {
        var btn = document.createElement('button');
        btn.className = 'numbtn';
        if (MOLDURA.indexOf(i) > -1) btn.className += ' mold';
        btn.textContent = i < 10 ? '0' + i : i;
        btn.setAttribute('data-n', i);
        btn.addEventListener('click', function() { toggleDesd(parseInt(this.getAttribute('data-n'))); });
        grid.appendChild(btn);
    }
    updateDesdUI();
}

function toggleDesd(n) {
    var idx = DATA.dsel.indexOf(n);
    if (idx > -1) DATA.dsel.splice(idx, 1);
    else if (DATA.dsel.length < DATA.curDesd.d) DATA.dsel.push(n);
    updateDesdUI();
}

function updateDesdUI() {
    document.querySelectorAll('#desdGrid .numbtn').forEach(function(btn) {
        var n = parseInt(btn.getAttribute('data-n'));
        btn.classList.remove('sel');
        if (MOLDURA.indexOf(n) > -1) btn.classList.add('mold');
        if (DATA.dsel.indexOf(n) > -1) btn.classList.add('sel');
    });
    document.getElementById('desdCnt').textContent = DATA.dsel.length;
}

function clearDesd() { DATA.dsel = []; updateDesdUI(); }

function randomDesd() {
    DATA.dsel = [];
    var disponiveis = [];
    for (var i = 1; i <= 25; i++) disponiveis.push(i);
    
    while (DATA.dsel.length < DATA.curDesd.d && disponiveis.length > 0) {
        var idx = Math.floor(Math.random() * disponiveis.length);
        DATA.dsel.push(disponiveis.splice(idx, 1)[0]);
    }
    updateDesdUI();
}

function applyDesd() {
    if (DATA.dsel.length !== DATA.curDesd.d) { 
        toast('Selecione ' + DATA.curDesd.d + ' dezenas!', true); 
        return; 
    }
    
    DATA.dgen = [];
    var nums = DATA.dsel.slice().sort(function(a, b) { return a - b; });
    
    // Gerar jogos garantindo distribuição
    var jogosSet = {};
    var tentativas = 0;
    var maxTentativas = DATA.curDesd.j * 100;
    
    while (DATA.dgen.length < DATA.curDesd.j && tentativas < maxTentativas) {
        tentativas++;
        var g = [];
        var av = nums.slice();
        
        while (g.length < 15 && av.length > 0) {
            var idx = Math.floor(Math.random() * av.length);
            g.push(av.splice(idx, 1)[0]);
        }
        
        g.sort(function(a, b) { return a - b; });
        var gStr = g.join(',');
        
        if (!jogosSet[gStr]) {
            jogosSet[gStr] = true;
            DATA.dgen.push(g);
        }
    }
    
    document.getElementById('desdRes').classList.remove('hidden');
    
    // Resumo
    var custo = (DATA.dgen.length * VALOR_JOGO).toFixed(2);
    var resumoHtml = '<div class="alert alert-s" style="margin-bottom:1rem;">';
    resumoHtml += '<strong>✅ ' + DATA.dgen.length + ' jogos gerados!</strong><br>';
    resumoHtml += '<span style="font-size:0.85rem;">Custo total: R$ ' + custo + ' | Garantia: ' + DATA.curDesd.g + '</span>';
    resumoHtml += '</div>';
    document.getElementById('desdResumo').innerHTML = resumoHtml;
    
    var html = '';
    DATA.dgen.forEach(function(g, idx) {
        var p = g.filter(function(x) { return x % 2 === 0; }).length;
        var pr = g.filter(function(x) { return PRIMOS.indexOf(x) > -1; }).length;
        var s = g.reduce(function(a, b) { return a + b; }, 0);
        var m = g.filter(function(x) { return MOLDURA.indexOf(x) > -1; }).length;
        
        html += '<div class="jogo"><div class="jogo-h"><span>Jogo ' + (idx + 1) + '</span><span>P:' + p + ' Pr:' + pr + ' M:' + m + ' Σ:' + s + '</span></div><div class="jogo-n">';
        g.forEach(function(x) { html += '<div class="jn">' + (x < 10 ? '0' + x : x) + '</div>'; });
        html += '</div></div>';
    });
    document.getElementById('desdGames').innerHTML = html;
    toast(DATA.dgen.length + ' jogos gerados!');
}

function saveDesdGames() {
    DATA.dgen.forEach(function(g, idx) {
        DATA.saved.push({ id: Date.now() + idx, n: g.slice(), dt: new Date().toLocaleDateString('pt-BR'), desd: DATA.curDesd.n });
    });
    save();
    updateSavedUI();
    toast(DATA.dgen.length + ' salvos!');
}

// Análise Histórica - Verifica se jogos já foram sorteados
var todosResultadosHistoricos = null;

function analisarHistorico() {
    if (!DATA.saved || DATA.saved.length === 0) {
        toast('Nenhum jogo salvo para analisar!', true);
        return;
    }
    
    if (!DATA.last) {
        toast('Dados não carregados!', true);
        return;
    }
    
    var resultadoDiv = document.getElementById('analiseHistoricoResultado');
    
    // Se já temos todos os resultados carregados, usar direto
    if (todosResultadosHistoricos && todosResultadosHistoricos.length > 100) {
        executarAnaliseHistorica(todosResultadosHistoricos, resultadoDiv);
        return;
    }
    
    // Carregar todos os resultados históricos
    resultadoDiv.innerHTML = '<div style="color:#f59e0b;font-size:0.8rem;">⏳ Carregando histórico completo da Lotofácil...</div>';
    
    var ultimoConcurso = DATA.last.c;
    
    // Usar API que retorna todos os resultados
    fetch('https://loteriascaixa-api.herokuapp.com/api/lotofacil')
        .then(function(r) { return r.json(); })
        .then(function(todos) {
            // A API retorna array com todos ou objeto único
            if (Array.isArray(todos)) {
                todosResultadosHistoricos = todos.map(function(d) {
                    return {
                        c: d.concurso,
                        d: d.data,
                        n: d.dezenas.map(function(x) { return parseInt(x); }).sort(function(a,b) { return a-b; })
                    };
                });
                executarAnaliseHistorica(todosResultadosHistoricos, resultadoDiv);
            } else {
                // API não retornou array, tentar carregar em lotes
                carregarHistoricoEmLotes(ultimoConcurso, resultadoDiv);
            }
        })
        .catch(function(err) {
            // Fallback: carregar em lotes
            carregarHistoricoEmLotes(ultimoConcurso, resultadoDiv);
        });
}

function carregarHistoricoEmLotes(ultimoConcurso, resultadoDiv) {
    resultadoDiv.innerHTML = '<div style="color:#f59e0b;font-size:0.8rem;">⏳ Carregando ' + ultimoConcurso + ' sorteios em lotes... <span id="progressoLotes">0%</span></div>';
    
    todosResultadosHistoricos = [];
    var loteSize = 100;
    var lotesTotal = Math.ceil(ultimoConcurso / loteSize);
    var lotesCarregados = 0;
    
    function carregarLote(inicio, fim) {
        var promises = [];
        for (var i = inicio; i <= fim && i <= ultimoConcurso; i++) {
            (function(num) {
                promises.push(
                    fetch('https://loteriascaixa-api.herokuapp.com/api/lotofacil/' + num)
                        .then(function(r) { return r.ok ? r.json() : null; })
                        .catch(function() { return null; })
                );
            })(i);
        }
        return Promise.all(promises);
    }
    
    function processarLotes(loteAtual) {
        var inicio = (loteAtual - 1) * loteSize + 1;
        var fim = Math.min(loteAtual * loteSize, ultimoConcurso);
        
        carregarLote(inicio, fim).then(function(results) {
            results.forEach(function(d) {
                if (d && d.dezenas) {
                    todosResultadosHistoricos.push({
                        c: d.concurso,
                        d: d.data,
                        n: d.dezenas.map(function(x) { return parseInt(x); }).sort(function(a,b) { return a-b; })
                    });
                }
            });
            
            lotesCarregados++;
            var progresso = Math.round((lotesCarregados / lotesTotal) * 100);
            var spanProgresso = document.getElementById('progressoLotes');
            if (spanProgresso) spanProgresso.textContent = progresso + '%';
            
            if (loteAtual < lotesTotal) {
                // Próximo lote com delay para não sobrecarregar
                setTimeout(function() {
                    processarLotes(loteAtual + 1);
                }, 200);
            } else {
                // Todos os lotes carregados
                executarAnaliseHistorica(todosResultadosHistoricos, resultadoDiv);
            }
        });
    }
    
    // Iniciar carregamento
    processarLotes(1);
}

function executarAnaliseHistorica(todosResultados, resultadoDiv) {
    resultadoDiv.innerHTML = '<div style="color:#94a3b8;font-size:0.8rem;">🔄 Analisando ' + DATA.saved.length + ' jogos contra ' + todosResultados.length + ' sorteios...</div>';
    
    setTimeout(function() {
        var jogosAnalisados = 0;
        var jogosSorteados = [];
        var melhoresAcertos = [];
        
        // Criar mapa de todos os resultados para busca rápida (15 pontos)
        var resultadosMap = {};
        todosResultados.forEach(function(r) {
            var key = r.n.slice().sort(function(a, b) { return a - b; }).join(',');
            resultadosMap[key] = r;
        });
        
        // Analisar cada jogo salvo
        DATA.saved.forEach(function(jogo, idx) {
            jogosAnalisados++;
            var jogoNums = jogo.n.slice().sort(function(a, b) { return a - b; });
            var jogoKey = jogoNums.join(',');
            
            // Verificar se já foi sorteado (15 pontos exatos)
            if (resultadosMap[jogoKey]) {
                var r = resultadosMap[jogoKey];
                jogosSorteados.push({
                    idx: idx,
                    jogo: jogo,
                    concurso: r.c,
                    data: r.d
                });
            }
            
            // Encontrar melhor acerto histórico para este jogo
            var melhorAcerto = 0;
            var melhorConcurso = null;
            
            todosResultados.forEach(function(r) {
                var acertos = jogoNums.filter(function(n) {
                    return r.n.indexOf(n) > -1;
                }).length;
                
                if (acertos > melhorAcerto) {
                    melhorAcerto = acertos;
                    melhorConcurso = r;
                }
            });
            
            if (melhorAcerto >= 11) {
                melhoresAcertos.push({
                    idx: idx,
                    jogo: jogo,
                    acertos: melhorAcerto,
                    concurso: melhorConcurso
                });
            }
        });
        
        // Ordenar melhores acertos
        melhoresAcertos.sort(function(a, b) { return b.acertos - a.acertos; });
        
        // Montar resultado
        var html = '';
        
        // Jogos já sorteados (15 pontos)
        if (jogosSorteados.length > 0) {
            html += '<div style="background:linear-gradient(135deg,#7f1d1d,#991b1b);border:2px solid #ef4444;border-radius:8px;padding:0.75rem;margin-bottom:0.75rem;">';
            html += '<div style="font-size:0.9rem;font-weight:700;color:#fca5a5;margin-bottom:0.5rem;">⚠️ ATENÇÃO: ' + jogosSorteados.length + ' jogo(s) já foram sorteados!</div>';
            
            jogosSorteados.forEach(function(item) {
                html += '<div style="background:#0f172a;border-radius:6px;padding:0.5rem;margin-top:0.5rem;">';
                html += '<div style="font-size:0.75rem;color:#94a3b8;">Jogo #' + (item.idx + 1) + ' = Concurso <strong style="color:#ef4444;">' + item.concurso + '</strong>';
                if (item.data) html += ' (' + item.data + ')';
                html += '</div>';
                html += '<div style="font-size:0.7rem;color:#64748b;margin-top:0.25rem;">';
                html += item.jogo.n.map(function(n) { return n < 10 ? '0' + n : n; }).join(' - ');
                html += '</div>';
                html += '</div>';
            });
            
            html += '<div style="font-size:0.7rem;color:#fca5a5;margin-top:0.5rem;">⚠️ Recomendação: <strong>Substitua estes jogos!</strong> A chance de repetir é de 1 em 3.268.760!</div>';
            html += '</div>';
        } else {
            html += '<div style="background:linear-gradient(135deg,#14532d,#166534);border:2px solid #22c55e;border-radius:8px;padding:0.75rem;margin-bottom:0.75rem;">';
            html += '<div style="font-size:0.85rem;color:#86efac;">✅ Nenhum dos seus jogos foi sorteado anteriormente!</div>';
            html += '<div style="font-size:0.7rem;color:#bbf7d0;margin-top:0.25rem;">Seus ' + jogosAnalisados + ' jogos são combinações inéditas em ' + todosResultados.length + ' sorteios verificados.</div>';
            html += '</div>';
        }
        
        // Estatísticas gerais
        html += '<div style="background:#0f172a;border-radius:8px;padding:0.75rem;margin-bottom:0.75rem;">';
        html += '<div style="font-size:0.8rem;font-weight:600;color:#f1f5f9;margin-bottom:0.5rem;">📊 Estatísticas da Análise Completa</div>';
        html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;text-align:center;">';
        
        html += '<div style="background:#1e293b;padding:0.5rem;border-radius:6px;">';
        html += '<div style="font-size:1rem;font-weight:700;color:#6366f1;">' + jogosAnalisados + '</div>';
        html += '<div style="font-size:0.65rem;color:#94a3b8;">Jogos Analisados</div>';
        html += '</div>';
        
        html += '<div style="background:#1e293b;padding:0.5rem;border-radius:6px;">';
        html += '<div style="font-size:1rem;font-weight:700;color:#f59e0b;">' + todosResultados.length.toLocaleString('pt-BR') + '</div>';
        html += '<div style="font-size:0.65rem;color:#94a3b8;">Sorteios Verificados</div>';
        html += '</div>';
        
        html += '<div style="background:#1e293b;padding:0.5rem;border-radius:6px;">';
        html += '<div style="font-size:1rem;font-weight:700;color:' + (jogosSorteados.length > 0 ? '#ef4444' : '#22c55e') + ';">' + jogosSorteados.length + '</div>';
        html += '<div style="font-size:0.65rem;color:#94a3b8;">Já Sorteados</div>';
        html += '</div>';
        
        html += '</div></div>';
        
        // Melhores acertos históricos (14, 13, 12, 11 pontos)
        if (melhoresAcertos.length > 0) {
            html += '<div style="background:#0f172a;border-radius:8px;padding:0.75rem;">';
            html += '<div style="font-size:0.8rem;font-weight:600;color:#f1f5f9;margin-bottom:0.5rem;">🎯 Melhor Performance Histórica dos Seus Jogos</div>';
            html += '<div style="font-size:0.7rem;color:#94a3b8;margin-bottom:0.5rem;">Se tivessem sido jogados nesses concursos, teriam premiação:</div>';
            
            // Agrupar por quantidade de acertos
            var por14 = melhoresAcertos.filter(function(x) { return x.acertos === 14; }).length;
            var por13 = melhoresAcertos.filter(function(x) { return x.acertos === 13; }).length;
            var por12 = melhoresAcertos.filter(function(x) { return x.acertos === 12; }).length;
            var por11 = melhoresAcertos.filter(function(x) { return x.acertos === 11; }).length;
            
            html += '<div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-bottom:0.5rem;">';
            if (por14 > 0) html += '<span style="background:#10b981;color:white;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.7rem;font-weight:600;">' + por14 + ' jogos → 14 pts</span>';
            if (por13 > 0) html += '<span style="background:#6366f1;color:white;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.7rem;font-weight:600;">' + por13 + ' jogos → 13 pts</span>';
            if (por12 > 0) html += '<span style="background:#8b5cf6;color:white;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.7rem;font-weight:600;">' + por12 + ' jogos → 12 pts</span>';
            if (por11 > 0) html += '<span style="background:#f59e0b;color:white;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.7rem;font-weight:600;">' + por11 + ' jogos → 11 pts</span>';
            html += '</div>';
            
            // Mostrar top 5 melhores
            html += '<div style="font-size:0.7rem;color:#64748b;margin-top:0.5rem;">Top 5 melhores:</div>';
            melhoresAcertos.slice(0, 5).forEach(function(item) {
                var corAcerto = item.acertos >= 14 ? '#22c55e' : (item.acertos >= 13 ? '#6366f1' : (item.acertos >= 12 ? '#8b5cf6' : '#f59e0b'));
                html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:0.25rem 0;border-bottom:1px solid #334155;">';
                html += '<span style="font-size:0.7rem;color:#94a3b8;">Jogo #' + (item.idx + 1) + '</span>';
                html += '<span style="font-size:0.7rem;"><strong style="color:' + corAcerto + ';">' + item.acertos + ' pts</strong> no concurso ' + item.concurso.c + '</span>';
                html += '</div>';
            });
            
            html += '</div>';
        }
        
        resultadoDiv.innerHTML = html;
        toast('✅ Análise concluída! ' + todosResultados.length + ' sorteios verificados.');
        
    }, 100);
}

function updateSavedUI() {
    document.getElementById('totJogos').textContent = DATA.saved.length;
    var el = document.getElementById('savedList');
    
    if (DATA.saved.length === 0) {
        document.getElementById('maxAcerto').textContent = '-';
        document.getElementById('totPremios').textContent = '0';
        el.innerHTML = '<div class="empty"><div class="empty-i">📋</div><p>Nenhum jogo salvo</p></div>';
        var alertEl = document.getElementById('alertRepetidos');
        if (alertEl) alertEl.classList.add('hidden');
        updateStatsPanel([], null);
        return;
    }
    
    // Detectar jogos repetidos (comparar apenas os 15 números únicos ordenados)
    var jogosMap = {};
    var repetidos = [];
    DATA.saved.forEach(function(j, idx) {
        // Garantir que estamos comparando apenas números únicos e ordenados
        var numerosUnicos = [];
        var vistos = {};
        j.n.forEach(function(n) {
            if (!vistos[n] && n >= 1 && n <= 25) {
                vistos[n] = true;
                numerosUnicos.push(n);
            }
        });
        numerosUnicos.sort(function(a, b) { return a - b; });
        var key = numerosUnicos.slice(0, 15).join(',');
        
        if (jogosMap[key] === undefined) {
            jogosMap[key] = [idx];
        } else {
            jogosMap[key].push(idx);
            if (jogosMap[key].length === 2) {
                repetidos.push(key);
            }
        }
    });
    
    // Criar set de índices repetidos
    var indicesRepetidos = {};
    repetidos.forEach(function(key, grupoIdx) {
        jogosMap[key].forEach(function(idx) {
            indicesRepetidos[idx] = grupoIdx + 1;
        });
    });
    
    // Detectar jogos com números repetidos internamente
    var jogosComNumsRepetidos = [];
    DATA.saved.forEach(function(j, idx) {
        var numSet = {};
        var numsRepetidos = [];
        j.n.forEach(function(n) {
            if (numSet[n]) {
                numsRepetidos.push(n);
            } else {
                numSet[n] = true;
            }
        });
        if (numsRepetidos.length > 0) {
            jogosComNumsRepetidos.push({ idx: idx, nums: numsRepetidos });
        }
    });
    
    // Mostrar alerta de repetidos
    var alertEl = document.getElementById('alertRepetidos');
    if (alertEl) {
        var alertHtml = '';
        
        // Alerta de jogos duplicados
        if (repetidos.length > 0) {
            var totalRepetidos = 0;
            repetidos.forEach(function(key) { totalRepetidos += jogosMap[key].length; });
            alertHtml += '<div class="alert-rep-content"><span class="alert-rep-icon">⚠️</span><div class="alert-rep-text"><strong>Jogos Duplicados!</strong><span>' + repetidos.length + ' grupo(s) com ' + totalRepetidos + ' jogos iguais</span></div><button class="btn btn-s" onclick="removerRepetidos()">🗑️ Remover Duplicados</button></div>';
        }
        
        // Alerta de números repetidos dentro do jogo
        if (jogosComNumsRepetidos.length > 0) {
            if (alertHtml) alertHtml += '<hr style="border:none;border-top:1px solid rgba(255,255,255,0.2);margin:0.5rem 0;">';
            alertHtml += '<div class="alert-rep-content alert-nums-rep"><span class="alert-rep-icon">🔴</span><div class="alert-rep-text"><strong>ERRO: Números Repetidos no Mesmo Jogo!</strong><span>' + jogosComNumsRepetidos.length + ' jogo(s) com números duplicados internamente</span></div><button class="btn btn-d" onclick="corrigirNumerosRepetidos()">🔧 Corrigir Jogos</button></div>';
        }
        
        if (alertHtml) {
            alertEl.innerHTML = alertHtml;
            alertEl.classList.remove('hidden');
        } else {
            alertEl.classList.add('hidden');
        }
    }
    
    var selV = document.getElementById('confSel').value;
    var res = DATA.last;
    if (selV !== 'ultimo') {
        var found = DATA.all.find(function(r) { return r.c === parseInt(selV); });
        if (found) res = found;
    }
    
    var maxA = 0;
    var totP = 0;
    var html = '';
    DATA.saved.forEach(function(j, idx) {
        var rn = res && res.n ? res.n : [];
        var ac = j.n.filter(function(x) { return rn.indexOf(x) > -1; }).length;
        if (ac > maxA) maxA = ac;
        if (ac >= 11) totP++;
        var prize = ac >= 11;
        var p = j.n.filter(function(x) { return x % 2 === 0; }).length;
        var pr = j.n.filter(function(x) { return PRIMOS.indexOf(x) > -1; }).length;
        var s = j.n.reduce(function(a, b) { return a + b; }, 0);
        var m = j.n.filter(function(x) { return MOLDURA.indexOf(x) > -1; }).length;
        
        var isRepetido = indicesRepetidos[idx] !== undefined;
        var grupoNum = isRepetido ? indicesRepetidos[idx] : 0;
        
        // Verificar números repetidos dentro do jogo
        var numCount = {};
        var numsRepetidosNoJogo = [];
        j.n.forEach(function(n) {
            numCount[n] = (numCount[n] || 0) + 1;
            if (numCount[n] === 2) numsRepetidosNoJogo.push(n);
        });
        var temNumsRepetidos = numsRepetidosNoJogo.length > 0;
        
        html += '<div class="jogo' + (isRepetido ? ' jogo-repetido' : '') + (temNumsRepetidos ? ' jogo-erro' : '') + '">';
        
        // Número do jogo
        html += '<div class="jogo-numero">Jogo ' + (idx + 1) + '</div>';
        
        // Badge de erro - números repetidos
        if (temNumsRepetidos) {
            html += '<div class="erro-badge">🔴 ERRO: Números repetidos no jogo: ' + numsRepetidosNoJogo.map(function(n) { return n < 10 ? '0' + n : n; }).join(', ') + '</div>';
        }
        
        // Badge de jogo repetido - mostrar quais índices são iguais
        if (isRepetido) {
            var grupoKey = null;
            repetidos.forEach(function(key) {
                if (jogosMap[key].indexOf(idx) > -1) {
                    grupoKey = key;
                }
            });
            var outrosIdx = grupoKey ? jogosMap[grupoKey].filter(function(i) { return i !== idx; }) : [];
            html += '<div class="repetido-badge">⚠️ JOGO DUPLICADO - Grupo ' + grupoNum + ' (igual ao jogo ' + outrosIdx.map(function(i) { return '#' + (i+1); }).join(', ') + ')</div>';
        }
        
        // Calcular CSN (índice único da combinação)
        var csn = calcularCSN(j.n);
        
        html += '<div class="jogo-h"><div><span>' + j.dt + '</span>';
        if (j.desd) html += '<span style="background:#6366f1;color:white;padding:1px 4px;border-radius:3px;font-size:0.6rem;margin-left:4px;">' + j.desd + '</span>';
        if (j.tipo) html += '<span style="background:#8b5cf6;color:white;padding:1px 4px;border-radius:3px;font-size:0.6rem;margin-left:4px;">' + j.tipo + '</span>';
        html += '</div><span>P:' + p + ' Pr:' + pr + ' M:' + m + ' Σ:' + s + '</span></div>';
        html += '<div class="jogo-csn">CSN: ' + csn.toLocaleString('pt-BR') + '</div>';
        html += '<div class="jogo-n">';
        
        // Destacar números repetidos
        j.n.forEach(function(x) { 
            var isNumRepetido = numsRepetidosNoJogo.indexOf(x) > -1;
            html += '<div class="jn' + (rn.indexOf(x) > -1 ? ' hit' : '') + (isNumRepetido ? ' num-erro' : '') + '">' + (x < 10 ? '0' + x : x) + '</div>'; 
        });
        
        html += '</div><div class="jogo-f"><div><span class="jpts' + (prize ? ' prize' : '') + '">' + ac + ' pts</span>';
        if (prize) html += '<span class="pbadge">PRÊMIO!</span>';
        html += '</div><button class="btn btn-s btn-sm" onclick="removeJ(' + idx + ')" title="Remover">🗑️</button></div></div>';
    });
    el.innerHTML = html;
    document.getElementById('maxAcerto').textContent = maxA > 0 ? maxA : '-';
    document.getElementById('totPremios').textContent = totP;
    
    // Atualizar painel de estatísticas
    updateStatsPanel(DATA.saved, res);
}

function checkGames() {
    updateSavedUI();
    var v = document.getElementById('confSel').value;
    toast('Conferido com ' + (v === 'ultimo' ? (DATA.last ? DATA.last.c : 'último') : v) + '!');
}

function updateStatsPanel(jogos, resultado) {
    var totalJogos = jogos.length;
    var qty15 = 0, qty14 = 0, qty13 = 0, qty12 = 0, qty11 = 0;
    var totalGasto = totalJogos * VALOR_JOGO;
    var totalPremio = 0;
    
    var rn = resultado && resultado.n ? resultado.n : [];
    
    jogos.forEach(function(j) {
        var acertos = j.n.filter(function(x) { return rn.indexOf(x) > -1; }).length;
        
        if (acertos === 15) {
            qty15++;
            totalPremio += PREMIOS_MEDIOS[15];
        } else if (acertos === 14) {
            qty14++;
            totalPremio += PREMIOS_MEDIOS[14];
        } else if (acertos === 13) {
            qty13++;
            totalPremio += PREMIOS_MEDIOS[13];
        } else if (acertos === 12) {
            qty12++;
            totalPremio += PREMIOS_MEDIOS[12];
        } else if (acertos === 11) {
            qty11++;
            totalPremio += PREMIOS_MEDIOS[11];
        }
    });
    
    var saldo = totalPremio - totalGasto;
    
    // Atualizar elementos
    document.getElementById('statsTotalJogos').textContent = totalJogos;
    document.getElementById('statsQty15').textContent = qty15;
    document.getElementById('statsQty14').textContent = qty14;
    document.getElementById('statsQty13').textContent = qty13;
    document.getElementById('statsQty12').textContent = qty12;
    document.getElementById('statsQty11').textContent = qty11;
    document.getElementById('statsTotalGasto').textContent = formatCurrency(totalGasto);
    document.getElementById('statsTotalPremio').textContent = formatCurrency(totalPremio);
    
    var saldoEl = document.getElementById('statsSaldo');
    saldoEl.textContent = (saldo >= 0 ? '+' : '') + formatCurrency(saldo);
    saldoEl.className = 'stats-panel-saldo ' + (saldo > 0 ? 'positivo' : (saldo < 0 ? 'negativo' : 'zero'));
}

function removeJ(idx) { DATA.saved.splice(idx, 1); save(); updateSavedUI(); toast('Removido!'); }

function removerRepetidos() {
    if (!confirm('Remover todos os jogos duplicados?\n(Mantém apenas 1 de cada jogo)')) return;
    
    var jogosMap = {};
    var novosJogos = [];
    
    DATA.saved.forEach(function(j) {
        var key = j.n.slice().sort(function(a, b) { return a - b; }).join(',');
        if (!jogosMap[key]) {
            jogosMap[key] = true;
            novosJogos.push(j);
        }
    });
    
    var removidos = DATA.saved.length - novosJogos.length;
    DATA.saved = novosJogos;
    save();
    updateSavedUI();
    toast(removidos + ' jogo(s) duplicado(s) removido(s)!');
}

function corrigirNumerosRepetidos() {
    if (!confirm('Corrigir jogos com números repetidos?\n\nIsso irá:\n- Remover números duplicados\n- Excluir jogos que ficarem com menos de 15 números')) return;
    
    var corrigidos = 0;
    var removidos = 0;
    var novosJogos = [];
    
    DATA.saved.forEach(function(j) {
        // Remover duplicados mantendo ordem
        var vistos = {};
        var numsUnicos = [];
        j.n.forEach(function(n) {
            if (!vistos[n]) {
                vistos[n] = true;
                numsUnicos.push(n);
            }
        });
        
        if (numsUnicos.length !== j.n.length) {
            // Tinha números repetidos
            if (numsUnicos.length >= 15) {
                // Pode ser corrigido
                j.n = numsUnicos.slice(0, 15);
                novosJogos.push(j);
                corrigidos++;
            } else {
                // Não tem números suficientes, remover jogo
                removidos++;
            }
        } else {
            // Jogo ok
            novosJogos.push(j);
        }
    });
    
    DATA.saved = novosJogos;
    save();
    updateSavedUI();
    
    var msg = '';
    if (corrigidos > 0) msg += corrigidos + ' jogo(s) corrigido(s). ';
    if (removidos > 0) msg += removidos + ' jogo(s) removido(s) (poucos números).';
    if (!msg) msg = 'Nenhum jogo precisou de correção.';
    toast(msg);
}
function clearAllJ() { 
    if (confirm('Remover todos os jogos?')) { 
        DATA.saved = []; 
        save(); 
        updateSavedUI(); 
        // Limpar análise histórica
        document.getElementById('analiseHistoricoResultado').innerHTML = '';
        toast('Jogos removidos!'); 
    } 
}

function openBatch() { document.getElementById('batchModal').classList.add('show'); document.getElementById('batchRes').innerHTML = ''; }
function closeBatch() { document.getElementById('batchModal').classList.remove('show'); }

function execBatch() {
    if (DATA.saved.length === 0) { toast('Sem jogos!', true); return; }
    var qtd = parseInt(document.getElementById('batchQtd').value);
    var res = DATA.all.slice(0, qtd);
    if (res.length === 0) { toast('Sem resultados!', true); return; }
    
    var html = '';
    var tot = { 11: 0, 12: 0, 13: 0, 14: 0, 15: 0 };
    
    DATA.saved.forEach(function(j, gi) {
        html += '<div style="margin-bottom:0.75rem;padding:0.5rem;background:#0f172a;border-radius:6px;"><div style="font-weight:600;font-size:0.8rem;margin-bottom:0.4rem;">Jogo ' + (gi + 1) + '</div>';
        res.forEach(function(r) {
            var ac = j.n.filter(function(x) { return r.n.indexOf(x) > -1; }).length;
            if (ac >= 11) tot[ac]++;
            html += '<div class="crow"><span>Conc. ' + r.c + '</span><span style="color:' + (ac >= 11 ? '#f59e0b' : '#64748b') + ';font-weight:' + (ac >= 11 ? '700' : '400') + ';">' + ac + 'pts' + (ac >= 11 ? ' 🎉' : '') + '</span></div>';
        });
        html += '</div>';
    });
    
    var tP = tot[11] + tot[12] + tot[13] + tot[14] + tot[15];
    var summary = '<div class="alert ' + (tP ? 'alert-s' : 'alert-i') + '"><strong>Resumo:</strong> ' + tP + ' prêmios em ' + (DATA.saved.length * res.length) + ' conferências';
    if (tot[15]) summary += '<br>🏆 15pts: ' + tot[15];
    if (tot[14]) summary += '<br>🥇 14pts: ' + tot[14];
    if (tot[13]) summary += '<br>🥈 13pts: ' + tot[13];
    if (tot[12]) summary += '<br>🥉 12pts: ' + tot[12];
    if (tot[11]) summary += '<br>✓ 11pts: ' + tot[11];
    summary += '</div>';
    
    document.getElementById('batchRes').innerHTML = summary + '<div style="max-height:250px;overflow-y:auto;">' + html + '</div>';
}

// EXPORTAÇÃO
function gamesToArray(games) {
    return games.map(function(g, i) {
        var nums = Array.isArray(g) ? g : g.n;
        return [i + 1].concat(nums.map(function(x) { return x < 10 ? '0' + x : '' + x; }));
    });
}

function exportExcel(games, filename) {
    var data = [['Jogo', 'D1', 'D2', 'D3', 'D4', 'D5', 'D6', 'D7', 'D8', 'D9', 'D10', 'D11', 'D12', 'D13', 'D14', 'D15']];
    gamesToArray(games).forEach(function(row) { data.push(row); });
    var ws = XLSX.utils.aoa_to_sheet(data);
    var wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Jogos');
    XLSX.writeFile(wb, filename);
    toast('Excel exportado!');
}

function exportTxt(games, filename) {
    var lines = [];
    games.forEach(function(g, i) {
        var nums = Array.isArray(g) ? g : g.n;
        lines.push('Jogo ' + (i + 1) + ': ' + nums.map(function(x) { return x < 10 ? '0' + x : '' + x; }).join(' '));
    });
    var blob = new Blob([lines.join('\n')], { type: 'text/plain' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
    toast('TXT exportado!');
}

function exportGenExcel() { if (DATA.gen.length) exportExcel(DATA.gen, 'lotofacil-gerados.xlsx'); else toast('Sem jogos!', true); }
function exportGenTxt() { if (DATA.gen.length) exportTxt(DATA.gen, 'lotofacil-gerados.txt'); else toast('Sem jogos!', true); }
function exportDesdExcel() { if (DATA.dgen.length) exportExcel(DATA.dgen, 'lotofacil-desdobramento.xlsx'); else toast('Sem jogos!', true); }
function exportDesdTxt() { if (DATA.dgen.length) exportTxt(DATA.dgen, 'lotofacil-desdobramento.txt'); else toast('Sem jogos!', true); }
function exportSavedExcel() { if (DATA.saved.length) exportExcel(DATA.saved, 'lotofacil-meus-jogos.xlsx'); else toast('Sem jogos!', true); }
function exportSavedTxt() { if (DATA.saved.length) exportTxt(DATA.saved, 'lotofacil-meus-jogos.txt'); else toast('Sem jogos!', true); }

function exportJ() {
    if (DATA.saved.length === 0) { toast('Sem jogos!', true); return; }
    var d = JSON.stringify(DATA.saved, null, 2);
    var b = new Blob([d], { type: 'application/json' });
    var u = URL.createObjectURL(b);
    var a = document.createElement('a');
    a.href = u;
    a.download = 'lotofacil-' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    URL.revokeObjectURL(u);
    toast('JSON exportado!');
}

function importJ() {
    var inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = '.json,.txt,.csv,.xlsx,.xls';
    inp.onchange = function(e) {
        var f = e.target.files[0];
        if (!f) return;
        
        var ext = f.name.split('.').pop().toLowerCase();
        
        if (ext === 'json') {
            importJSON(f);
        } else if (ext === 'txt' || ext === 'csv') {
            importTXT(f);
        } else if (ext === 'xlsx' || ext === 'xls') {
            importExcelFile(f);
        } else {
            toast('Formato não suportado!', true);
        }
    };
    inp.click();
}

function importJSON(f) {
    var reader = new FileReader();
    reader.onload = function(ev) {
        try {
            var g = JSON.parse(ev.target.result);
            if (Array.isArray(g)) {
                var count = 0;
                var erros = 0;
                g.forEach(function(item, idx) {
                    var nums = item.n || item.numeros || item;
                    if (Array.isArray(nums) && nums.length >= 15) {
                        // Converter para inteiros e remover duplicatas
                        var dezenas = [];
                        var vistos = {};
                        nums.forEach(function(x) {
                            var n = parseInt(x);
                            if (n >= 1 && n <= 25 && !vistos[n]) {
                                vistos[n] = true;
                                dezenas.push(n);
                            }
                        });
                        
                        if (dezenas.length >= 15) {
                            DATA.saved.push({
                                id: Date.now() + idx,
                                n: dezenas.slice(0, 15).sort(function(a,b) { return a-b; }),
                                dt: new Date().toLocaleDateString('pt-BR'),
                                tipo: 'importado'
                            });
                            count++;
                        } else {
                            erros++;
                        }
                    }
                });
                save();
                updateSavedUI();
                if (erros > 0) {
                    toast(count + ' importados, ' + erros + ' com erro (números inválidos/duplicados)');
                } else {
                    toast(count + ' jogos importados!');
                }
            }
        } catch (err) { toast('Erro ao ler JSON!', true); }
    };
    reader.readAsText(f);
}

function importTXT(f) {
    var reader = new FileReader();
    reader.onload = function(ev) {
        try {
            var texto = ev.target.result;
            var linhas = texto.split(/[\r\n]+/);
            var count = 0;
            var erros = 0;
            
            linhas.forEach(function(linha, idx) {
                linha = linha.trim();
                if (!linha || linha.startsWith('#') || linha.startsWith('//')) return;
                
                // Extrair números da linha (aceita vários separadores)
                var nums = linha.match(/\d+/g);
                if (nums && nums.length >= 15) {
                    // Converter e remover duplicatas
                    var dezenas = [];
                    var vistos = {};
                    nums.forEach(function(x) {
                        var n = parseInt(x);
                        if (n >= 1 && n <= 25 && !vistos[n]) {
                            vistos[n] = true;
                            dezenas.push(n);
                        }
                    });
                    
                    if (dezenas.length >= 15) {
                        DATA.saved.push({
                            id: Date.now() + idx,
                            n: dezenas.slice(0, 15).sort(function(a,b) { return a-b; }),
                            dt: new Date().toLocaleDateString('pt-BR'),
                            tipo: 'importado'
                        });
                        count++;
                    } else {
                        erros++;
                    }
                }
            });
            
            if (count > 0) {
                save();
                updateSavedUI();
                if (erros > 0) {
                    toast(count + ' importados, ' + erros + ' com erro');
                } else {
                    toast(count + ' jogos importados!');
                }
            } else {
                toast('Nenhum jogo válido encontrado!', true);
            }
        } catch (err) { toast('Erro ao ler TXT!', true); }
    };
    reader.readAsText(f);
}

function importExcelFile(f) {
    var reader = new FileReader();
    reader.onload = function(ev) {
        try {
            var data = new Uint8Array(ev.target.result);
            var workbook = XLSX.read(data, { type: 'array' });
            var sheetName = workbook.SheetNames[0];
            var sheet = workbook.Sheets[sheetName];
            var json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            
            var count = 0;
            var erros = 0;
            json.forEach(function(row, idx) {
                if (!row || row.length < 15) return;
                
                // Extrair números da linha e remover duplicatas
                var dezenas = [];
                var vistos = {};
                row.forEach(function(cell) {
                    var n = parseInt(cell);
                    if (!isNaN(n) && n >= 1 && n <= 25 && !vistos[n]) {
                        vistos[n] = true;
                        dezenas.push(n);
                    }
                });
                
                if (dezenas.length >= 15) {
                    DATA.saved.push({
                        id: Date.now() + idx,
                        n: dezenas.slice(0, 15).sort(function(a,b) { return a-b; }),
                        dt: new Date().toLocaleDateString('pt-BR'),
                        tipo: 'importado'
                    });
                    count++;
                } else if (dezenas.length > 0) {
                    erros++;
                }
            });
            
            if (count > 0) {
                save();
                updateSavedUI();
                if (erros > 0) {
                    toast(count + ' importados, ' + erros + ' com erro (duplicados/inválidos)');
                } else {
                    toast(count + ' jogos importados!');
                }
            } else {
                toast('Nenhum jogo válido encontrado!', true);
            }
        } catch (err) { 
            console.error(err);
            toast('Erro ao ler Excel!', true); 
        }
    };
    reader.readAsArrayBuffer(f);
}

function save() { localStorage.setItem('lf_v3', JSON.stringify(DATA.saved)); }

// ESTATÍSTICA POSICIONAL
function calcPosStats() {
    var last25 = DATA.all.slice(0, 25);
    if (last25.length < 10) return null;
    
    var stats = [];
    for (var pos = 0; pos < 15; pos++) {
        var freq = {};
        for (var n = 1; n <= 25; n++) freq[n] = 0;
        
        last25.forEach(function(r) {
            if (r.n && r.n[pos]) {
                freq[r.n[pos]]++;
            }
        });
        
        var sorted = Object.keys(freq).map(function(n) {
            return { n: parseInt(n), f: freq[n], pct: Math.round((freq[n] / last25.length) * 100) };
        }).sort(function(a, b) { return b.f - a.f; });
        
        stats.push({
            pos: pos + 1,
            freq: freq,
            sorted: sorted,
            top: sorted[0],
            total: last25.length
        });
    }
    
    return stats;
}

function initPosTabs() {
    var html = '';
    for (var i = 1; i <= 15; i++) {
        html += '<button class="pos-tab' + (i === 1 ? ' active' : '') + '" data-pos="' + i + '" onclick="selectPos(' + i + ')">' + i + 'ª</button>';
    }
    document.getElementById('posTabs').innerHTML = html;
}

function selectPos(pos) {
    currentPos = pos;
    document.querySelectorAll('.pos-tab').forEach(function(tab) {
        tab.classList.remove('active');
        if (parseInt(tab.getAttribute('data-pos')) === pos) {
            tab.classList.add('active');
        }
    });
    renderPosChart();
}

function renderPosChart() {
    if (!posStats || !posStats[currentPos - 1]) {
        document.getElementById('posChart').innerHTML = '<div style="color:#64748b;text-align:center;padding:2rem;">Carregando dados...</div>';
        return;
    }
    
    var data = posStats[currentPos - 1];
    var maxFreq = data.sorted[0].f;
    var maxHeight = 160;
    
    var colors = [
        '#10b981', '#22c55e', '#84cc16', '#eab308', '#f59e0b',
        '#f97316', '#ef4444', '#ec4899', '#d946ef', '#a855f7',
        '#8b5cf6', '#6366f1', '#3b82f6', '#0ea5e9', '#06b6d4',
        '#14b8a6', '#10b981', '#22c55e', '#84cc16', '#eab308',
        '#f59e0b', '#f97316', '#ef4444', '#ec4899', '#d946ef'
    ];
    
    var html = '';
    for (var n = 1; n <= 25; n++) {
        var freq = data.freq[n];
        var height = maxFreq > 0 ? Math.max((freq / maxFreq) * maxHeight, freq > 0 ? 8 : 2) : 2;
        var pct = Math.round((freq / data.total) * 100);
        var isTop = data.top.n === n;
        
        html += '<div class="pos-bar-wrapper">';
        html += '<div class="pos-bar' + (isTop ? ' highlight' : '') + '" style="height:' + height + 'px;background:' + colors[n-1] + ';">';
        if (freq > 0) {
            html += '<span class="pos-bar-value">' + freq + 'x</span>';
        }
        html += '</div>';
        html += '<span class="pos-bar-label">' + (n < 10 ? '0' + n : n) + '</span>';
        html += '</div>';
    }
    
    document.getElementById('posChart').innerHTML = html;
}

function renderPosSummary() {
    if (!posStats) {
        document.getElementById('posSummary').innerHTML = '';
        return;
    }
    
    var html = '<div class="pos-summary-title">🏆 Números mais frequentes por posição (25 últimos sorteios)</div>';
    html += '<div class="pos-summary-grid">';
    
    posStats.forEach(function(data) {
        var top = data.top;
        html += '<div class="pos-summary-item">';
        html += '<div class="pos-summary-pos">' + data.pos + 'ª pos</div>';
        html += '<div class="pos-summary-num">' + (top.n < 10 ? '0' + top.n : top.n) + '</div>';
        html += '<div class="pos-summary-pct">' + top.pct + '% (' + top.f + 'x)</div>';
        html += '</div>';
    });
    
    html += '</div>';
    document.getElementById('posSummary').innerHTML = html;
}

function updatePosStats() {
    posStats = calcPosStats();
    initPosTabs();
    renderPosChart();
    renderPosSummary();
}

// NÚMEROS AUSENTES (10 últimos sorteios)
function calcAusentes() {
    if (DATA.l10.length === 0) return [];
    
    var apareceu = {};
    for (var n = 1; n <= 25; n++) apareceu[n] = false;
    
    DATA.l10.forEach(function(r) {
        r.n.forEach(function(num) {
            apareceu[num] = true;
        });
    });
    
    var ausentes = [];
    for (var n = 1; n <= 25; n++) {
        if (!apareceu[n]) ausentes.push(n);
    }
    
    return ausentes;
}

function renderAusentes() {
    var ausentes = calcAusentes();
    var grid = document.getElementById('ausentesGrid');
    var info = document.getElementById('ausentesInfo');
    
    if (ausentes.length === 0) {
        grid.innerHTML = '<div class="ausentes-empty">✅ Todos os 25 números apareceram nos últimos 10 sorteios!</div>';
        info.innerHTML = '';
        return;
    }
    
    var html = '';
    ausentes.forEach(function(n) {
        html += '<div class="ausente-num">' + (n < 10 ? '0' + n : n) + '</div>';
    });
    grid.innerHTML = html;
    
    var pct = Math.round((ausentes.length / 25) * 100);
    info.innerHTML = '<div class="alert alert-i" style="text-align:center;">' +
        '<strong>' + ausentes.length + '</strong> número(s) ausente(s) (' + pct + '% do volante)<br>' +
        '<span style="font-size:0.75rem;">Esses números não saíram em nenhum dos últimos 10 concursos</span>' +
        '</div>';
}

// CICLO DE FECHAMENTO
function calcCicloFechamento() {
    if (DATA.all.length === 0) return null;
    
    var ciclo = {};
    for (var n = 1; n <= 25; n++) {
        ciclo[n] = { num: n, ultimo: -1, atraso: 0 };
    }
    
    // Percorre do mais recente ao mais antigo
    for (var i = 0; i < DATA.all.length; i++) {
        var r = DATA.all[i];
        r.n.forEach(function(num) {
            if (ciclo[num].ultimo === -1) {
                ciclo[num].ultimo = i;
                ciclo[num].atraso = i;
            }
        });
        
        // Verifica se todos foram encontrados
        var todoEncontrado = true;
        for (var n = 1; n <= 25; n++) {
            if (ciclo[n].ultimo === -1) {
                todoEncontrado = false;
                break;
            }
        }
        if (todoEncontrado) break;
    }
    
    // Para números que não apareceram em todo o histórico
    for (var n = 1; n <= 25; n++) {
        if (ciclo[n].ultimo === -1) {
            ciclo[n].atraso = DATA.all.length;
        }
    }
    
    return ciclo;
}

function renderCicloFechamento() {
    var ciclo = calcCicloFechamento();
    if (!ciclo) {
        document.getElementById('cicloGrid').innerHTML = '<div style="color:#64748b;text-align:center;">Carregando...</div>';
        return;
    }
    
    // Calcula estatísticas
    var atrasos = [];
    var maxAtraso = 0;
    var totalAtraso = 0;
    
    for (var n = 1; n <= 25; n++) {
        atrasos.push(ciclo[n].atraso);
        if (ciclo[n].atraso > maxAtraso) maxAtraso = ciclo[n].atraso;
        totalAtraso += ciclo[n].atraso;
    }
    
    var mediaAtraso = (totalAtraso / 25).toFixed(1);
    
    // Números mais atrasados
    var ordenado = Object.values(ciclo).sort(function(a, b) { return b.atraso - a.atraso; });
    var maisAtrasados = ordenado.slice(0, 5);
    
    // Info
    var infoHtml = '<div style="display:flex;flex-wrap:wrap;gap:0.5rem;justify-content:center;margin-bottom:0.75rem;">';
    infoHtml += '<div class="cnt">Média: <span class="cnt-v">' + mediaAtraso + '</span></div>';
    infoHtml += '<div class="cnt" style="background:rgba(239,68,68,0.2);">Máx: <span class="cnt-v" style="color:#ef4444;">' + maxAtraso + '</span></div>';
    infoHtml += '</div>';
    
    if (maisAtrasados[0].atraso > 5) {
        infoHtml += '<div style="font-size:0.75rem;color:#f59e0b;text-align:center;margin-bottom:0.5rem;">⚠️ Mais atrasados: ';
        maisAtrasados.forEach(function(item, idx) {
            if (item.atraso > 5) {
                infoHtml += '<strong>' + (item.num < 10 ? '0' + item.num : item.num) + '</strong>(' + item.atraso + ')';
                if (idx < maisAtrasados.length - 1 && maisAtrasados[idx + 1].atraso > 5) infoHtml += ', ';
            }
        });
        infoHtml += '</div>';
    }
    
    document.getElementById('cicloInfo').innerHTML = infoHtml;
    
    // Grid
    var gridHtml = '';
    for (var n = 1; n <= 25; n++) {
        var atraso = ciclo[n].atraso;
        var classe = 'normal';
        var classeVal = 'normal';
        
        if (atraso === 0) {
            classe = 'recente';
            classeVal = 'recente';
        } else if (atraso >= 8) {
            classe = 'atrasado';
            classeVal = 'atrasado';
        } else if (atraso >= 5) {
            classe = 'alerta';
            classeVal = 'alerta';
        }
        
        var label = atraso === 0 ? 'SAIU' : atraso + ' sorteio' + (atraso > 1 ? 's' : '');
        
        gridHtml += '<div class="ciclo-item ' + classe + '">';
        gridHtml += '<div class="ciclo-num">' + (n < 10 ? '0' + n : n) + '</div>';
        gridHtml += '<div class="ciclo-val ' + classeVal + '">' + label + '</div>';
        gridHtml += '</div>';
    }
    
    gridHtml += '</div>';
    gridHtml += '<div class="ciclo-legend">';
    gridHtml += '<div class="ciclo-leg-item"><div class="ciclo-leg-dot recente"></div>Saiu agora</div>';
    gridHtml += '<div class="ciclo-leg-item"><div class="ciclo-leg-dot normal"></div>1-4 sorteios</div>';
    gridHtml += '<div class="ciclo-leg-item"><div class="ciclo-leg-dot alerta"></div>5-7 sorteios</div>';
    gridHtml += '<div class="ciclo-leg-item"><div class="ciclo-leg-dot atrasado"></div>8+ sorteios</div>';
    gridHtml += '</div>';
    
    document.getElementById('cicloGrid').innerHTML = gridHtml;
}

function updateAusentesECiclo() {
    renderAusentes();
    renderCicloFechamento();
    renderTabelaCiclos();
}

// TABELA DE CICLOS ESTILO MAZUSOFT
function renderTabelaCiclos() {
    if (DATA.all.length < 5) {
        document.getElementById('cicloTable').innerHTML = '<tr><td style="color:#64748b;padding:2rem;">Carregando dados...</td></tr>';
        return;
    }
    
    var concursos = DATA.all.slice(0, 50); // Últimos 50 concursos
    
    // Linhas do volante 5x5:
    // Linha 1: 01-05 | Linha 2: 06-10 | Linha 3: 11-15 | Linha 4: 16-20 | Linha 5: 21-25
    var linhaDoNumero = function(n) {
        return Math.ceil(n / 5);
    };
    
    // Cores padronizadas
    var corCabecalho = '#8B008B';  // Roxo escuro
    var corTexto = '#F8F8FF';       // Branco ghost
    var corSeparador = '#FFA500';   // Laranja
    
    // Cabeçalho com dezenas e separadores por linha
    var headHtml = '<tr><th>Conc.</th>';
    for (var d = 1; d <= 25; d++) {
        var isUltimoDaLinha = d % 5 === 0;
        var borderRight = isUltimoDaLinha ? 'border-right:3px solid ' + corSeparador + ';' : '';
        headHtml += '<th class="dez-header" style="background:' + corCabecalho + ';color:' + corTexto + ';font-weight:700;' + borderRight + '">' + (d < 10 ? '0' + d : d) + '</th>';
    }
    headHtml += '<th style="min-width:120px;">Faltam p/ Fechar</th>';
    headHtml += '</tr>';
    
    document.getElementById('cicloTableHead').innerHTML = headHtml;
    
    // Primeiro, precisamos identificar onde cada ciclo começa e termina
    // Processando do mais antigo ao mais recente para identificar ciclos
    var concursosReverso = concursos.slice().reverse();
    
    var ciclosSairam = {}; // Números que já saíram no ciclo atual
    for (var d = 1; d <= 25; d++) ciclosSairam[d] = false;
    
    var ciclosInfo = []; // Info para cada concurso (na ordem reversa)
    var historicoCiclos = [];
    var cicloNum = 1;
    var concursosNoCiclo = 0;
    
    concursosReverso.forEach(function(conc, idx) {
        concursosNoCiclo++;
        
        // Marcar números que saíram neste concurso
        conc.n.forEach(function(num) {
            ciclosSairam[num] = true;
        });
        
        // Calcular quais ainda faltam APÓS este concurso
        var faltantes = [];
        for (var d = 1; d <= 25; d++) {
            if (!ciclosSairam[d]) faltantes.push(d);
        }
        
        var fechou = faltantes.length === 0;
        
        ciclosInfo.push({
            conc: conc.c,
            numeros: conc.n.slice(),
            faltantes: faltantes.slice(),
            fechou: fechou,
            cicloNum: cicloNum
        });
        
        // Se fechou, resetar para próximo ciclo
        if (fechou) {
            historicoCiclos.push({
                num: cicloNum,
                concursos: concursosNoCiclo,
                fechouEm: conc.c
            });
            cicloNum++;
            concursosNoCiclo = 0;
            for (var d = 1; d <= 25; d++) ciclosSairam[d] = false;
        }
    });
    
    // Reverter para ordem original (mais recente primeiro)
    ciclosInfo.reverse();
    
    // Status do ciclo atual - pegar da primeira linha (concurso mais recente)
    var faltandoAtual = ciclosInfo.length > 0 ? ciclosInfo[0].faltantes : [];
    var concursosNoCicloAtual = 0;
    
    // Contar quantos concursos desde o último fechamento
    for (var i = 0; i < ciclosInfo.length; i++) {
        concursosNoCicloAtual++;
        if (ciclosInfo[i].fechou) {
            concursosNoCicloAtual = 1; // Este concurso é o primeiro do novo ciclo
            faltandoAtual = ciclosInfo[i].faltantes;
            break;
        }
    }
    
    // Se o primeiro (mais recente) não fechou, usar seus faltantes
    if (ciclosInfo.length > 0 && !ciclosInfo[0].fechou) {
        faltandoAtual = ciclosInfo[0].faltantes;
        concursosNoCicloAtual = 0;
        for (var i = 0; i < ciclosInfo.length; i++) {
            concursosNoCicloAtual++;
            if (ciclosInfo[i].fechou) {
                break;
            }
        }
    }
    
    // Status do ciclo atual
    var statusHtml = '<div class="ciclo-status">';
    statusHtml += '<div class="ciclo-status-item"><div class="ciclo-status-value ' + (faltandoAtual.length === 0 ? 'fechado' : 'aberto') + '">' + (faltandoAtual.length === 0 ? 'FECHADO' : 'ABERTO') + '</div><div class="ciclo-status-label">Status do Ciclo</div></div>';
    statusHtml += '<div class="ciclo-status-item"><div class="ciclo-status-value" style="color:#10b981;">' + concursosNoCicloAtual + '</div><div class="ciclo-status-label">Concursos no Ciclo</div></div>';
    statusHtml += '<div class="ciclo-status-item"><div class="ciclo-status-value" style="color:#6366f1;">' + (25 - faltandoAtual.length) + '/25</div><div class="ciclo-status-label">Dezenas Sorteadas</div></div>';
    
    if (faltandoAtual.length > 0) {
        statusHtml += '<div class="ciclo-status-item"><div class="ciclo-status-value" style="color:#ef4444;">' + faltandoAtual.length + '</div><div class="ciclo-status-label">Faltando</div></div>';
    }
    statusHtml += '</div>';
    
    if (faltandoAtual.length > 0) {
        statusHtml += '<div style="margin-top:0.75rem;text-align:center;"><span style="font-size:0.8rem;color:#94a3b8;">🎯 Faltam para fechar o ciclo atual: </span>';
        faltandoAtual.forEach(function(d) {
            statusHtml += '<span style="display:inline-block;background:linear-gradient(135deg,#ef4444,#dc2626);color:white;width:32px;height:32px;line-height:32px;border-radius:50%;font-weight:700;font-size:0.85rem;margin:3px;box-shadow:0 2px 8px rgba(239,68,68,0.4);">' + (d < 10 ? '0' + d : d) + '</span>';
        });
        statusHtml += '</div>';
    } else {
        statusHtml += '<div style="margin-top:0.75rem;text-align:center;color:#22c55e;font-size:0.9rem;">✅ Ciclo completo! Todos os 25 números já saíram.</div>';
    }
    
    document.getElementById('cicloStatus').innerHTML = statusHtml;
    
    // Corpo da tabela
    var bodyHtml = '';
    ciclosInfo.forEach(function(data, idx) {
        var rowClass = data.fechou ? ' class="ciclo-fechou"' : '';
        
        bodyHtml += '<tr' + rowClass + '>';
        bodyHtml += '<td class="conc-cell">' + data.conc + '</td>';
        
        // Células das dezenas com separadores por linha do volante
        for (var d = 1; d <= 25; d++) {
            var saiu = data.numeros.indexOf(d) > -1;
            var isUltimoDaLinha = d % 5 === 0;
            
            var cellClass = 'nao-saiu';
            var cellContent = '·';
            
            if (saiu) {
                cellClass = 'saiu';
                cellContent = (d < 10 ? '0' + d : d);
            }
            
            // Destacar se fechou o ciclo
            if (data.fechou && saiu) {
                cellClass = 'fechou';
            }
            
            // Adicionar classe de separador de linha
            if (isUltimoDaLinha) {
                cellClass += ' linha-sep';
            }
            
            bodyHtml += '<td class="' + cellClass + '">' + cellContent + '</td>';
        }
        
        // Coluna de faltantes
        bodyHtml += '<td class="faltantes-cell">';
        if (data.fechou) {
            bodyHtml += '<span style="color:#22c55e;font-weight:700;">✓ FECHOU</span>';
        } else if (data.faltantes.length > 0) {
            if (data.faltantes.length <= 8) {
                data.faltantes.forEach(function(f) {
                    bodyHtml += '<span class="falta-num">' + (f < 10 ? '0' + f : f) + '</span>';
                });
            } else {
                bodyHtml += '<span style="color:#ef4444;font-weight:600;">' + data.faltantes.length + ' números</span>';
            }
        }
        bodyHtml += '</td>';
        
        bodyHtml += '</tr>';
    });
    
    document.getElementById('cicloTableBody').innerHTML = bodyHtml;
    
    // Histórico de ciclos
    var legendHtml = '<div style="font-size:0.8rem;color:#94a3b8;margin-bottom:0.5rem;">📊 Histórico dos últimos ciclos fechados:</div>';
    legendHtml += '<div class="ciclo-hist">';
    
    historicoCiclos.slice(-10).forEach(function(c) {
        legendHtml += '<div class="ciclo-hist-item">Ciclo <span>#' + c.num + '</span>: ' + c.concursos + ' conc. (fechou no ' + c.fechouEm + ')</div>';
    });
    
    if (historicoCiclos.length === 0) {
        legendHtml += '<div class="ciclo-hist-item">Nenhum ciclo completo nos últimos 50 concursos</div>';
    } else {
        // Calcular média
        var somaConc = 0;
        historicoCiclos.forEach(function(c) { somaConc += c.concursos; });
        var media = (somaConc / historicoCiclos.length).toFixed(1);
        legendHtml += '<div class="ciclo-hist-item" style="background:#10b981;color:white;">Média: <span style="color:white;">' + media + '</span> concursos/ciclo</div>';
    }
    
    legendHtml += '</div>';
    document.getElementById('cicloLegend').innerHTML = legendHtml;
}

// ==================== FECHAMENTO INTELIGENTE (AUSENTES + SORTEADAS) ====================

var smartSorteadasSelecionadas = [];
var smartJogosGerados = [];

// Dados posicionais para fechamento
var smartPosData = {
    scorePosicional: {},
    ausPosRank: [],
    sortPosRank: []
};

function toggleSmartPosicional() {
    var checked = document.getElementById('smartUsarPosicional').checked;
    var config = document.getElementById('smartPosConfig');
    
    if (checked) {
        config.classList.remove('hidden');
        calcularSmartPosDados();
        updateSmartPosPreview();
    } else {
        config.classList.add('hidden');
    }
}

function calcularSmartPosDados() {
    if (!DATA.all || !DATA.last) return;
    
    var range = parseInt(document.getElementById('smartPosRange').value) || 25;
    var concursos = DATA.all.slice(0, range);
    
    if (concursos.length < 5) return;
    
    // Calcular frequência por posição
    var freqPorPos = [];
    for (var pos = 0; pos < 15; pos++) {
        var freq = {};
        for (var n = 1; n <= 25; n++) freq[n] = 0;
        freqPorPos.push(freq);
    }
    
    concursos.forEach(function(c) {
        var sorted = c.n.slice().sort(function(a,b) { return a-b; });
        sorted.forEach(function(n, pos) {
            freqPorPos[pos][n]++;
        });
    });
    
    // Para cada número, calcular seu "score posicional"
    smartPosData.scorePosicional = {};
    for (var n = 1; n <= 25; n++) {
        var score = 0;
        freqPorPos.forEach(function(freq) {
            score += freq[n];
        });
        smartPosData.scorePosicional[n] = score;
    }
    
    // Obter ausentes e sorteadas do último sorteio
    var sorteadas = DATA.last.n;
    var ausentes = [];
    for (var i = 1; i <= 25; i++) {
        if (sorteadas.indexOf(i) === -1) ausentes.push(i);
    }
    
    // Ordenar ausentes por score posicional
    smartPosData.ausPosRank = ausentes.slice().sort(function(a, b) {
        return smartPosData.scorePosicional[b] - smartPosData.scorePosicional[a];
    });
    
    // Ordenar sorteadas por score posicional
    smartPosData.sortPosRank = sorteadas.slice().sort(function(a, b) {
        return smartPosData.scorePosicional[b] - smartPosData.scorePosicional[a];
    });
}

function updateSmartPosPreview() {
    calcularSmartPosDados();
    
    if (!smartPosData.ausPosRank.length) return;
    
    // Preview ausentes top
    var ausHtml = smartPosData.ausPosRank.slice(0, 5).map(function(n) {
        return '<span style="background:rgba(239,68,68,0.2);padding:2px 6px;border-radius:4px;margin-right:4px;">' + 
            (n < 10 ? '0' + n : n) + '(' + smartPosData.scorePosicional[n] + ')</span>';
    }).join('');
    document.getElementById('smartPosAusPreview').innerHTML = ausHtml;
    
    // Preview sorteadas top
    var sortHtml = smartPosData.sortPosRank.slice(0, 5).map(function(n) {
        return '<span style="background:rgba(34,197,94,0.2);padding:2px 6px;border-radius:4px;margin-right:4px;">' + 
            (n < 10 ? '0' + n : n) + '(' + smartPosData.scorePosicional[n] + ')</span>';
    }).join('');
    document.getElementById('smartPosSortPreview').innerHTML = sortHtml;
}

function initSmartFechamento() {
    updateSmartDisplay();
    renderSmartTabela();
    updateSmartFech();
}

function updateSmartDisplay() {
    if (!DATA.last || !DATA.last.n) return;
    
    var sorteadas = DATA.last.n;
    var ausentes = [];
    for (var i = 1; i <= 25; i++) {
        if (sorteadas.indexOf(i) === -1) ausentes.push(i);
    }
    
    // Exibir ausentes
    var ausHtml = '';
    ausentes.forEach(function(n) {
        ausHtml += '<div class="smart-ball aus">' + (n < 10 ? '0' + n : n) + '</div>';
    });
    document.getElementById('smartAusentes').innerHTML = ausHtml;
    
    // Exibir sorteadas
    var sortHtml = '';
    sorteadas.forEach(function(n) {
        sortHtml += '<div class="smart-ball sort">' + (n < 10 ? '0' + n : n) + '</div>';
    });
    document.getElementById('smartSorteadas').innerHTML = sortHtml;
    
    // Grid de seleção manual
    var selHtml = '';
    sorteadas.forEach(function(n) {
        selHtml += '<button class="smart-sel-btn" data-n="' + n + '" onclick="toggleSmartSel(' + n + ')">' + (n < 10 ? '0' + n : n) + '</button>';
    });
    document.getElementById('smartSelGrid').innerHTML = selHtml;
}

function toggleSmartSel(n) {
    var idx = smartSorteadasSelecionadas.indexOf(n);
    if (idx > -1) {
        smartSorteadasSelecionadas.splice(idx, 1);
    } else {
        var qtdNecessaria = parseInt(document.getElementById('smartSortAdd').value);
        if (smartSorteadasSelecionadas.length < qtdNecessaria) {
            smartSorteadasSelecionadas.push(n);
        }
    }
    updateSmartSelUI();
    updateSmartFech();
}

function updateSmartSelUI() {
    document.querySelectorAll('.smart-sel-btn').forEach(function(btn) {
        var n = parseInt(btn.getAttribute('data-n'));
        btn.classList.toggle('selected', smartSorteadasSelecionadas.indexOf(n) > -1);
    });
}

function updateSmartFech() {
    var selecaoTipo = document.getElementById('smartSelecao').value;
    var manualDiv = document.getElementById('smartManual');
    
    if (selecaoTipo === 'manual') {
        manualDiv.classList.remove('hidden');
    } else {
        manualDiv.classList.add('hidden');
        smartSorteadasSelecionadas = [];
        updateSmartSelUI();
    }
    
    updateSmartInfo();
}

function getSmartEstrategiaConfig() {
    var qtdSort = parseInt(document.getElementById('smartSortAdd').value);
    var estrategia = document.getElementById('smartEstrategia').value;
    var totalDez = 10 + qtdSort;
    
    // Buscar fechamento baseado na estratégia
    var fechamentosDisponiveis = FECHAMENTOS.filter(function(f) {
        return f.dez === totalDez && f.cond === 15;
    });
    
    if (fechamentosDisponiveis.length === 0) return null;
    
    // Ordenar por estratégia
    if (estrategia === 'economica') {
        fechamentosDisponiveis.sort(function(a, b) { return a.jogos - b.jogos; });
    } else if (estrategia === 'agressiva') {
        fechamentosDisponiveis.sort(function(a, b) { return b.gar - a.gar; });
    } else {
        // Equilibrada: melhor custo-benefício (lucro / custo)
        fechamentosDisponiveis.sort(function(a, b) {
            var lucroA = PREMIOS_MEDIOS[a.gar] - (a.jogos * VALOR_JOGO);
            var lucroB = PREMIOS_MEDIOS[b.gar] - (b.jogos * VALOR_JOGO);
            return lucroB - lucroA;
        });
    }
    
    return fechamentosDisponiveis[0];
}

function updateSmartInfo() {
    var config = getSmartEstrategiaConfig();
    if (!config) {
        document.getElementById('smartInfo').innerHTML = '<div style="color:#ef4444;">Nenhum fechamento disponível para esta configuração.</div>';
        return;
    }
    
    var custo = config.jogos * VALOR_JOGO;
    var premio = PREMIOS_MEDIOS[config.gar];
    var lucro = premio - custo;
    var isLucro = lucro > 0;
    
    var html = '<div class="smart-info-grid">';
    
    html += '<div class="smart-info-item">';
    html += '<div class="smart-info-value">' + config.dez + '</div>';
    html += '<div class="smart-info-label">Dezenas (10+' + (config.dez - 10) + ')</div>';
    html += '</div>';
    
    html += '<div class="smart-info-item">';
    html += '<div class="smart-info-value">' + config.jogos + '</div>';
    html += '<div class="smart-info-label">Jogos</div>';
    html += '</div>';
    
    html += '<div class="smart-info-item">';
    html += '<div class="smart-info-value">R$ ' + custo.toFixed(2) + '</div>';
    html += '<div class="smart-info-label">Custo Total</div>';
    html += '</div>';
    
    html += '<div class="smart-info-item">';
    html += '<div class="smart-info-value" style="color:#f59e0b;">' + config.gar + ' pts</div>';
    html += '<div class="smart-info-label">Garantia Mín.</div>';
    html += '</div>';
    
    html += '<div class="smart-info-item">';
    html += '<div class="smart-info-value" style="color:#10b981;">R$ ' + premio.toFixed(2) + '</div>';
    html += '<div class="smart-info-label">Prêmio Mín.</div>';
    html += '</div>';
    
    html += '<div class="smart-info-item">';
    html += '<div class="smart-info-value ' + (isLucro ? 'lucro' : 'prejuizo') + '">';
    html += (isLucro ? '+' : '') + 'R$ ' + lucro.toFixed(2);
    html += '</div>';
    html += '<div class="smart-info-label">' + (isLucro ? '✅ Lucro' : '❌ Prejuízo') + '</div>';
    html += '</div>';
    
    html += '</div>';
    
    document.getElementById('smartInfo').innerHTML = html;
}

function renderSmartTabela() {
    var html = '<table>';
    html += '<thead><tr>';
    html += '<th>Dezenas</th>';
    html += '<th>Composição</th>';
    html += '<th>Garantia</th>';
    html += '<th>Jogos</th>';
    html += '<th>Custo</th>';
    html += '<th>Prêmio Mín.</th>';
    html += '<th>Resultado</th>';
    html += '</tr></thead><tbody>';
    
    // Filtrar fechamentos com 10 ausentes + sorteadas (16 a 20 dezenas)
    var fechamentosRelevantes = FECHAMENTOS.filter(function(f) {
        return f.dez >= 16 && f.dez <= 20 && f.cond === 15;
    });
    
    fechamentosRelevantes.forEach(function(f) {
        var custo = f.jogos * VALOR_JOGO;
        var premio = PREMIOS_MEDIOS[f.gar];
        var lucro = premio - custo;
        var isLucro = lucro > 0;
        var classe = isLucro ? 'lucro' : 'prejuizo';
        var sortAdd = f.dez - 10;
        
        html += '<tr class="' + classe + '">';
        html += '<td><strong>' + f.dez + '</strong></td>';
        html += '<td>10 aus + ' + sortAdd + ' sort</td>';
        html += '<td>' + f.gar + ' pontos</td>';
        html += '<td>' + f.jogos + '</td>';
        html += '<td>R$ ' + custo.toFixed(2) + '</td>';
        html += '<td>R$ ' + premio.toFixed(2) + '</td>';
        html += '<td>';
        if (isLucro) {
            html += '<span class="badge-lucro">+R$ ' + lucro.toFixed(2) + '</span>';
        } else if (lucro === 0) {
            html += '<span style="color:#f59e0b;">Empate</span>';
        } else {
            html += '<span class="badge-prejuizo">R$ ' + lucro.toFixed(2) + '</span>';
        }
        html += '</td>';
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    document.getElementById('smartTabela').innerHTML = html;
}

function gerarSmartFechamento() {
    if (!DATA.last || !DATA.last.n) {
        toast('Dados do último sorteio não disponíveis!', true);
        return;
    }
    
    var config = getSmartEstrategiaConfig();
    if (!config) {
        toast('Nenhum fechamento disponível!', true);
        return;
    }
    
    var sorteadas = DATA.last.n;
    var ausentes = [];
    for (var i = 1; i <= 25; i++) {
        if (sorteadas.indexOf(i) === -1) ausentes.push(i);
    }
    
    // Determinar quais sorteadas usar
    var qtdSort = config.dez - 10;
    var sorteadasUsar = [];
    var selecaoTipo = document.getElementById('smartSelecao').value;
    
    if (selecaoTipo === 'manual') {
        if (smartSorteadasSelecionadas.length !== qtdSort) {
            toast('Selecione exatamente ' + qtdSort + ' dezenas sorteadas!', true);
            return;
        }
        sorteadasUsar = smartSorteadasSelecionadas.slice();
    } else if (selecaoTipo === 'quentes') {
        // Pegar as mais frequentes nos últimos 10 sorteios
        var freq = {};
        sorteadas.forEach(function(n) { freq[n] = 0; });
        
        if (DATA.l10) {
            DATA.l10.forEach(function(r) {
                r.n.forEach(function(n) {
                    if (freq[n] !== undefined) freq[n]++;
                });
            });
        }
        
        sorteadasUsar = sorteadas.slice().sort(function(a, b) {
            return freq[b] - freq[a];
        }).slice(0, qtdSort);
    } else {
        // Aleatório
        var disponiveis = sorteadas.slice();
        while (sorteadasUsar.length < qtdSort && disponiveis.length > 0) {
            var idx = Math.floor(Math.random() * disponiveis.length);
            sorteadasUsar.push(disponiveis.splice(idx, 1)[0]);
        }
    }
    
    // Combinar ausentes + sorteadas selecionadas
    var dezenas = ausentes.concat(sorteadasUsar).sort(function(a, b) { return a - b; });
    
    // Verificar filtro posicional
    var usarPosicional = document.getElementById('smartUsarPosicional').checked;
    var minPosAus = usarPosicional ? parseInt(document.getElementById('smartMinPosAus').value) : 0;
    var minPosSort = usarPosicional ? parseInt(document.getElementById('smartMinPosSort').value) : 0;
    
    // Calcular dados posicionais se necessário
    if (usarPosicional) {
        calcularSmartPosDados();
    }
    
    // Top posicionais
    var topPosAus = usarPosicional ? smartPosData.ausPosRank.slice(0, 5) : [];
    var topPosSort = usarPosicional ? smartPosData.sortPosRank.slice(0, 8) : [];
    
    // Gerar jogos
    smartJogosGerados = [];
    var jogosSet = {};
    var tentativas = 0;
    var maxTentativas = config.jogos * 500;
    var filtroPosBloqueou = 0;
    
    while (smartJogosGerados.length < config.jogos && tentativas < maxTentativas) {
        tentativas++;
        var jogo = [];
        var disponiveis = dezenas.slice();
        
        while (jogo.length < 15 && disponiveis.length > 0) {
            var idx = Math.floor(Math.random() * disponiveis.length);
            jogo.push(disponiveis.splice(idx, 1)[0]);
        }
        
        jogo.sort(function(a, b) { return a - b; });
        var jogoStr = jogo.join(',');
        
        if (jogosSet[jogoStr]) continue;
        
        // Aplicar filtro posicional
        if (usarPosicional) {
            var qtdTopPosAus = jogo.filter(function(n) {
                return topPosAus.indexOf(n) > -1;
            }).length;
            
            var qtdTopPosSort = jogo.filter(function(n) {
                return topPosSort.indexOf(n) > -1;
            }).length;
            
            if (qtdTopPosAus < minPosAus || qtdTopPosSort < minPosSort) {
                filtroPosBloqueou++;
                continue;
            }
        }
        
        jogosSet[jogoStr] = true;
        smartJogosGerados.push(jogo);
    }
    
    // Aviso se filtro posicional bloqueou muitos
    if (usarPosicional && filtroPosBloqueou > 100 && smartJogosGerados.length < config.jogos) {
        toast('Filtro posicional muito restritivo. Bloqueou ' + filtroPosBloqueou + ' jogos. Reduza os mínimos.', true);
    }
    
    // Mostrar resultado
    document.getElementById('smartResultado').classList.remove('hidden');
    
    var custo = smartJogosGerados.length * VALOR_JOGO;
    var premio = PREMIOS_MEDIOS[config.gar];
    var lucro = premio - custo;
    
    var resumoHtml = '<div class="alert ' + (lucro > 0 ? 'alert-s' : 'alert-w') + '" style="margin-bottom:1rem;">';
    resumoHtml += '<strong>✅ ' + smartJogosGerados.length + ' jogos gerados!</strong><br>';
    resumoHtml += '<span style="font-size:0.85rem;">';
    resumoHtml += '<strong>Dezenas usadas:</strong> 10 ausentes + ' + qtdSort + ' sorteadas = ' + config.dez + ' dezenas<br>';
    resumoHtml += 'Custo: R$ ' + custo.toFixed(2) + ' | ';
    resumoHtml += 'Garantia: ' + config.gar + ' pts | ';
    resumoHtml += 'Prêmio mín.: R$ ' + premio.toFixed(2) + ' | ';
    resumoHtml += '<strong style="color:' + (lucro > 0 ? '#22c55e' : '#ef4444') + ';">';
    resumoHtml += (lucro > 0 ? 'Lucro: +' : 'Resultado: ') + 'R$ ' + lucro.toFixed(2);
    resumoHtml += '</strong></span>';
    resumoHtml += '</div>';
    
    // Mostrar dezenas usadas
    resumoHtml += '<div style="margin-bottom:1rem;padding:0.75rem;background:#0f172a;border-radius:8px;">';
    resumoHtml += '<div style="font-size:0.8rem;color:#94a3b8;margin-bottom:0.5rem;">Dezenas utilizadas:</div>';
    resumoHtml += '<div style="display:flex;flex-wrap:wrap;gap:4px;">';
    dezenas.forEach(function(n) {
        var isAusente = ausentes.indexOf(n) > -1;
        var cor = isAusente ? '#ef4444' : '#22c55e';
        resumoHtml += '<span style="display:inline-block;width:28px;height:28px;border-radius:50%;background:rgba(' + (isAusente ? '239,68,68' : '34,197,94') + ',0.2);border:2px solid ' + cor + ';color:' + cor + ';font-size:0.75rem;font-weight:600;line-height:24px;text-align:center;">' + (n < 10 ? '0' + n : n) + '</span>';
    });
    resumoHtml += '</div>';
    resumoHtml += '<div style="font-size:0.7rem;color:#64748b;margin-top:0.5rem;">🔴 Ausentes | 🟢 Sorteadas</div>';
    resumoHtml += '</div>';
    
    document.getElementById('smartResumo').innerHTML = resumoHtml;
    
    var jogosHtml = '';
    smartJogosGerados.forEach(function(jogo, idx) {
        var p = jogo.filter(function(x) { return x % 2 === 0; }).length;
        var pr = jogo.filter(function(x) { return PRIMOS.indexOf(x) > -1; }).length;
        var m = jogo.filter(function(x) { return MOLDURA.indexOf(x) > -1; }).length;
        var s = jogo.reduce(function(a, b) { return a + b; }, 0);
        var ausCount = jogo.filter(function(x) { return ausentes.indexOf(x) > -1; }).length;
        
        jogosHtml += '<div class="jogo">';
        jogosHtml += '<div class="jogo-h"><span>Jogo ' + (idx + 1) + '</span>';
        jogosHtml += '<span>P:' + p + ' Pr:' + pr + ' M:' + m + ' Σ:' + s + ' | Aus:' + ausCount + '</span></div>';
        jogosHtml += '<div class="jogo-n">';
        jogo.forEach(function(n) {
            var isAus = ausentes.indexOf(n) > -1;
            var estilo = isAus ? 'border:2px solid #ef4444;' : '';
            jogosHtml += '<div class="jn" style="' + estilo + '">' + (n < 10 ? '0' + n : n) + '</div>';
        });
        jogosHtml += '</div></div>';
    });
    document.getElementById('smartJogos').innerHTML = jogosHtml;
    
    toast(smartJogosGerados.length + ' jogos gerados com sucesso!');
    document.getElementById('smartResultado').scrollIntoView({ behavior: 'smooth' });
}

function salvarSmartFechamento() {
    if (smartJogosGerados.length === 0) {
        toast('Nenhum jogo para salvar!', true);
        return;
    }
    
    smartJogosGerados.forEach(function(jogo, idx) {
        DATA.saved.push({
            id: Date.now() + idx,
            n: jogo,
            dt: new Date().toLocaleDateString('pt-BR'),
            tipo: 'smart'
        });
    });
    
    save();
    updateSavedUI();
    toast(smartJogosGerados.length + ' jogos salvos!');
}

function exportSmartExcel() {
    if (smartJogosGerados.length === 0) {
        toast('Nenhum jogo para exportar!', true);
        return;
    }
    exportExcel(smartJogosGerados, 'lotofacil-smart-fechamento.xlsx');
}

function exportSmartTxt() {
    if (smartJogosGerados.length === 0) {
        toast('Nenhum jogo para exportar!', true);
        return;
    }
    exportTxt(smartJogosGerados, 'lotofacil-smart-fechamento.txt');
}

// ==================== FECHAMENTO COM GARANTIA ====================

var fechamentoAtual = null;
var fechDezSelecionadas = [];
var fechJogosGerados = [];

function initFechamento() {
    renderTabelaFechamentos();
    updateFechOptions();
}

function renderTabelaFechamentos() {
    var html = '<table>';
    html += '<thead><tr>';
    html += '<th>Dezenas</th>';
    html += '<th>Condição</th>';
    html += '<th>Garantia</th>';
    html += '<th>Jogos</th>';
    html += '<th>Custo</th>';
    html += '<th>Prêmio Mín.</th>';
    html += '<th>Resultado</th>';
    html += '<th>Ação</th>';
    html += '</tr></thead><tbody>';
    
    FECHAMENTOS.forEach(function(f, idx) {
        var custo = f.jogos * VALOR_JOGO;
        var premio = PREMIOS_MEDIOS[f.gar] || 0;
        var lucro = premio - custo;
        var isLucro = lucro > 0;
        var classe = isLucro ? 'lucro' : 'prejuizo';
        
        html += '<tr class="' + classe + '">';
        html += '<td><strong>' + f.dez + '</strong></td>';
        html += '<td>Acertar ' + f.cond + '/' + f.dez + '</td>';
        html += '<td>' + f.gar + ' pontos</td>';
        html += '<td>' + f.jogos + '</td>';
        html += '<td>R$ ' + custo.toFixed(2) + '</td>';
        html += '<td>R$ ' + premio.toFixed(2) + '</td>';
        html += '<td>';
        if (isLucro) {
            html += '<span class="badge-lucro">+R$ ' + lucro.toFixed(2) + '</span>';
        } else {
            html += '<span class="badge-prejuizo">R$ ' + lucro.toFixed(2) + '</span>';
        }
        html += '</td>';
        html += '<td><button class="btn-usar" onclick="usarFechamento(' + idx + ')">Usar</button></td>';
        html += '</tr>';
    });
    
    html += '</tbody></table>';
    document.getElementById('fechTabela').innerHTML = html;
}

function updateFechOptions() {
    var dez = parseInt(document.getElementById('fechDezenas').value);
    var condSelect = document.getElementById('fechCondicao');
    
    // Atualizar opções de condição baseado nas dezenas
    var condicoes = [];
    FECHAMENTOS.forEach(function(f) {
        if (f.dez === dez && condicoes.indexOf(f.cond) === -1) {
            condicoes.push(f.cond);
        }
    });
    condicoes.sort(function(a, b) { return b - a; });
    
    condSelect.innerHTML = '';
    condicoes.forEach(function(c) {
        var opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c + ' das dezenas';
        condSelect.appendChild(opt);
    });
    
    updateFechGarantias();
}

function updateFechGarantias() {
    var dez = parseInt(document.getElementById('fechDezenas').value);
    var cond = parseInt(document.getElementById('fechCondicao').value);
    var garSelect = document.getElementById('fechGarantia');
    
    // Atualizar opções de garantia
    var garantias = [];
    FECHAMENTOS.forEach(function(f) {
        if (f.dez === dez && f.cond === cond && garantias.indexOf(f.gar) === -1) {
            garantias.push(f.gar);
        }
    });
    garantias.sort(function(a, b) { return b - a; });
    
    garSelect.innerHTML = '';
    garantias.forEach(function(g) {
        var opt = document.createElement('option');
        opt.value = g;
        opt.textContent = g + ' pontos';
        garSelect.appendChild(opt);
    });
    
    updateFechInfo();
}

function updateFechInfo() {
    var dez = parseInt(document.getElementById('fechDezenas').value);
    var cond = parseInt(document.getElementById('fechCondicao').value);
    var gar = parseInt(document.getElementById('fechGarantia').value);
    
    var fech = FECHAMENTOS.find(function(f) {
        return f.dez === dez && f.cond === cond && f.gar === gar;
    });
    
    if (!fech) {
        document.getElementById('fechInfo').innerHTML = '<div style="color:#ef4444;">Fechamento não disponível</div>';
        document.getElementById('fechSelecao').classList.add('hidden');
        return;
    }
    
    fechamentoAtual = fech;
    
    var custo = fech.jogos * VALOR_JOGO;
    var premio = PREMIOS_MEDIOS[fech.gar] || 0;
    var lucro = premio - custo;
    var isLucro = lucro > 0;
    
    var html = '<div class="fech-info-row">';
    html += '<span class="fech-info-label">Dezenas necessárias</span>';
    html += '<span class="fech-info-value">' + fech.dez + '</span>';
    html += '</div>';
    
    html += '<div class="fech-info-row">';
    html += '<span class="fech-info-label">Condição</span>';
    html += '<span class="fech-info-value">Acertar ' + fech.cond + ' das ' + fech.dez + ' dezenas</span>';
    html += '</div>';
    
    html += '<div class="fech-info-row">';
    html += '<span class="fech-info-label">Garantia</span>';
    html += '<span class="fech-info-value" style="color:#f59e0b;">Mínimo ' + fech.gar + ' pontos</span>';
    html += '</div>';
    
    html += '<div class="fech-info-row">';
    html += '<span class="fech-info-label">Jogos gerados</span>';
    html += '<span class="fech-info-value">' + fech.jogos + ' jogos</span>';
    html += '</div>';
    
    html += '<div class="fech-info-row">';
    html += '<span class="fech-info-label">Custo total</span>';
    html += '<span class="fech-info-value">R$ ' + custo.toFixed(2) + '</span>';
    html += '</div>';
    
    html += '<div class="fech-info-row">';
    html += '<span class="fech-info-label">Prêmio mínimo garantido</span>';
    html += '<span class="fech-info-value" style="color:#10b981;">R$ ' + premio.toFixed(2) + '</span>';
    html += '</div>';
    
    html += '<div class="fech-info-row" style="background:' + (isLucro ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)') + ';margin:0.5rem -1rem -1rem;padding:0.75rem 1rem;border-radius:0 0 7px 7px;">';
    html += '<span class="fech-info-label" style="font-weight:600;">Resultado</span>';
    html += '<span class="fech-info-value ' + (isLucro ? 'lucro' : 'prejuizo') + '" style="font-size:1rem;">';
    html += isLucro ? '✅ LUCRO: +R$ ' + lucro.toFixed(2) : '❌ PREJUÍZO: R$ ' + lucro.toFixed(2);
    html += '</span>';
    html += '</div>';
    
    document.getElementById('fechInfo').innerHTML = html;
    
    // Mostrar seleção de dezenas
    document.getElementById('fechSelecao').classList.remove('hidden');
    document.getElementById('fechReq').textContent = fech.dez;
    initFechGrid();
}

function initFechGrid() {
    fechDezSelecionadas = [];
    var grid = document.getElementById('fechGrid');
    grid.innerHTML = '';
    
    for (var i = 1; i <= 25; i++) {
        var btn = document.createElement('button');
        btn.className = 'numbtn';
        if (MOLDURA.indexOf(i) > -1) btn.className += ' mold';
        btn.textContent = i < 10 ? '0' + i : i;
        btn.setAttribute('data-n', i);
        btn.addEventListener('click', function() {
            toggleFechNum(parseInt(this.getAttribute('data-n')));
        });
        grid.appendChild(btn);
    }
    updateFechUI();
}

function toggleFechNum(n) {
    var idx = fechDezSelecionadas.indexOf(n);
    if (idx > -1) {
        fechDezSelecionadas.splice(idx, 1);
    } else if (fechamentoAtual && fechDezSelecionadas.length < fechamentoAtual.dez) {
        fechDezSelecionadas.push(n);
    }
    updateFechUI();
}

function updateFechUI() {
    document.querySelectorAll('#fechGrid .numbtn').forEach(function(btn) {
        var n = parseInt(btn.getAttribute('data-n'));
        btn.classList.remove('sel');
        if (fechDezSelecionadas.indexOf(n) > -1) btn.classList.add('sel');
    });
    document.getElementById('fechCnt').textContent = fechDezSelecionadas.length;
}

function clearFech() {
    fechDezSelecionadas = [];
    updateFechUI();
}

function randomFech() {
    if (!fechamentoAtual) return;
    fechDezSelecionadas = [];
    var disponiveis = [];
    for (var i = 1; i <= 25; i++) disponiveis.push(i);
    
    while (fechDezSelecionadas.length < fechamentoAtual.dez && disponiveis.length > 0) {
        var idx = Math.floor(Math.random() * disponiveis.length);
        fechDezSelecionadas.push(disponiveis.splice(idx, 1)[0]);
    }
    updateFechUI();
}

function usarFechamento(idx) {
    var f = FECHAMENTOS[idx];
    document.getElementById('fechDezenas').value = f.dez;
    updateFechOptions();
    document.getElementById('fechCondicao').value = f.cond;
    updateFechGarantias();
    document.getElementById('fechGarantia').value = f.gar;
    updateFechInfo();
    
    // Scroll para a seleção
    document.getElementById('fechSelecao').scrollIntoView({ behavior: 'smooth' });
}

function gerarFechamento() {
    if (!fechamentoAtual) {
        toast('Selecione um fechamento!', true);
        return;
    }
    
    if (fechDezSelecionadas.length !== fechamentoAtual.dez) {
        toast('Selecione ' + fechamentoAtual.dez + ' dezenas!', true);
        return;
    }
    
    fechJogosGerados = [];
    var nums = fechDezSelecionadas.slice().sort(function(a, b) { return a - b; });
    
    // Gerar jogos garantindo distribuição uniforme
    var jogosSet = {};
    var tentativas = 0;
    var maxTentativas = fechamentoAtual.jogos * 500;
    
    while (fechJogosGerados.length < fechamentoAtual.jogos && tentativas < maxTentativas) {
        tentativas++;
        var jogo = [];
        var disponiveis = nums.slice();
        
        while (jogo.length < 15 && disponiveis.length > 0) {
            var idx = Math.floor(Math.random() * disponiveis.length);
            jogo.push(disponiveis.splice(idx, 1)[0]);
        }
        
        jogo.sort(function(a, b) { return a - b; });
        var jogoStr = jogo.join(',');
        
        if (!jogosSet[jogoStr]) {
            jogosSet[jogoStr] = true;
            fechJogosGerados.push(jogo);
        }
    }
    
    // Mostrar resultado
    document.getElementById('fechResultado').classList.remove('hidden');
    
    var custo = fechJogosGerados.length * VALOR_JOGO;
    var premio = PREMIOS_MEDIOS[fechamentoAtual.gar];
    var lucro = premio - custo;
    
    var resumoHtml = '<div class="alert ' + (lucro > 0 ? 'alert-s' : 'alert-w') + '" style="margin-bottom:1rem;">';
    resumoHtml += '<strong>✅ ' + fechJogosGerados.length + ' jogos gerados!</strong><br>';
    resumoHtml += '<span style="font-size:0.85rem;">';
    resumoHtml += 'Custo: R$ ' + custo.toFixed(2) + ' | ';
    resumoHtml += 'Garantia: ' + fechamentoAtual.gar + ' pts | ';
    resumoHtml += 'Prêmio mín.: R$ ' + premio.toFixed(2) + ' | ';
    resumoHtml += '<strong style="color:' + (lucro > 0 ? '#22c55e' : '#ef4444') + ';">';
    resumoHtml += (lucro > 0 ? 'Lucro: +' : 'Resultado: ') + 'R$ ' + lucro.toFixed(2);
    resumoHtml += '</strong></span>';
    resumoHtml += '</div>';
    document.getElementById('fechResumo').innerHTML = resumoHtml;
    
    var jogosHtml = '';
    fechJogosGerados.forEach(function(jogo, idx) {
        var p = jogo.filter(function(x) { return x % 2 === 0; }).length;
        var pr = jogo.filter(function(x) { return PRIMOS.indexOf(x) > -1; }).length;
        var m = jogo.filter(function(x) { return MOLDURA.indexOf(x) > -1; }).length;
        var s = jogo.reduce(function(a, b) { return a + b; }, 0);
        
        jogosHtml += '<div class="jogo">';
        jogosHtml += '<div class="jogo-h"><span>Jogo ' + (idx + 1) + '</span>';
        jogosHtml += '<span>P:' + p + ' Pr:' + pr + ' M:' + m + ' Σ:' + s + '</span></div>';
        jogosHtml += '<div class="jogo-n">';
        jogo.forEach(function(n) {
            jogosHtml += '<div class="jn">' + (n < 10 ? '0' + n : n) + '</div>';
        });
        jogosHtml += '</div></div>';
    });
    document.getElementById('fechJogos').innerHTML = jogosHtml;
    
    toast(fechJogosGerados.length + ' jogos gerados com sucesso!');
    
    // Scroll para resultado
    document.getElementById('fechResultado').scrollIntoView({ behavior: 'smooth' });
}

function salvarFechamento() {
    if (fechJogosGerados.length === 0) {
        toast('Nenhum jogo para salvar!', true);
        return;
    }
    
    fechJogosGerados.forEach(function(jogo, idx) {
        DATA.saved.push({
            id: Date.now() + idx,
            n: jogo,
            dt: new Date().toLocaleDateString('pt-BR'),
            tipo: 'fechamento'
        });
    });
    
    save();
    updateSavedUI();
    toast(fechJogosGerados.length + ' jogos salvos!');
}

function exportFechExcel() {
    if (fechJogosGerados.length === 0) {
        toast('Nenhum jogo para exportar!', true);
        return;
    }
    exportExcel(fechJogosGerados, 'lotofacil-fechamento.xlsx');
}

function exportFechTxt() {
    if (fechJogosGerados.length === 0) {
        toast('Nenhum jogo para exportar!', true);
        return;
    }
    exportTxt(fechJogosGerados, 'lotofacil-fechamento.txt');
}

function toast(msg, warn) {
    var el = document.getElementById('toast');
    el.textContent = msg;
    el.style.borderColor = warn ? '#eab308' : '#10b981';
    el.classList.add('show');
    setTimeout(function() { el.classList.remove('show'); }, 2500);
}
</script>

<footer class="site-footer">
    <div class="footer-content">
        <div class="footer-logo">🍀 VKBRUTUS LOTERIAS</div>
        <div class="footer-info">
            <span>Itapagipe - MG</span>
            <span class="footer-sep">|</span>
            <span>Todos os direitos reservados</span>
        </div>
        <div class="footer-copy">© 2025 VKBRUTUS LOTERIAS - Sistema de análise e geração de jogos</div>
        <div class="footer-disclaimer">Este sistema é apenas uma ferramenta de auxílio. Aposte com responsabilidade.</div>
    </div>
</footer>

<style>
.site-footer { background: linear-gradient(135deg, #0f172a, #1e293b); border-top: 2px solid #10b981; padding: 1.5rem 1rem; margin-top: 2rem; text-align: center; }
.footer-content { max-width: 1100px; margin: 0 auto; }
.footer-logo { font-size: 1.25rem; font-weight: 700; color: #10b981; margin-bottom: 0.5rem; }
.footer-info { display: flex; justify-content: center; align-items: center; gap: 0.5rem; flex-wrap: wrap; color: #94a3b8; font-size: 0.85rem; margin-bottom: 0.5rem; }
.footer-sep { color: #334155; }
.footer-copy { color: #64748b; font-size: 0.75rem; margin-bottom: 0.25rem; }
.footer-disclaimer { color: #475569; font-size: 0.7rem; font-style: italic; }
</style>
</body>
</html>
